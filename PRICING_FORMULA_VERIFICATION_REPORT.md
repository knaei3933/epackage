# Quote-Simulator 計算ガイド検証報告

**作成日**: 2026-01-18
**対象**: docs/reports/tjfrP/계산가이드 (計算ガイド)
**検証方法**: スクリプト検証 + E2Eテスト

---

## 実行サマリー

| 検証項目 | 結果 | 状態 |
|---------|------|------|
| 計算式検証スクリプト | 作成完了 | ✅ |
| E2E検証テスト | 作成完了 | ✅ |
| PDF出力検証 | 未実施 | ⏳ |

---

## 1. 計算式検証スクリプト結果

**ファイル**: `scripts/verify-pricing-formulas.ts`

### 結果サマリー

```
合計: 19件
✓ PASS: 13件
✗ FAIL: 6件
```

### 詳細結果

#### ✅ PASS (13件)

| カテゴリ | 項目 |
|---------|------|
| フィルム幅計算 | 平袋 1列 (5件)、スタンドアップ 2列、合掌袋、ボックスパウチ |
| 確保量計算 | 1SKU 最小確保量、2SKU 最小確保量、50m単位切り上げ (2件) |
| 配送料計算 | 包装数計算 (3件) |

#### ✗ FAIL (6件)

| カテゴリ | 項目 | 期待値 | 実際 | 差 |
|---------|------|--------|------|-----|
| フィルム幅計算 | 平袋 2列 | 471mm | 551mm | 80mm |
| フィルム幅計算 | スタンドアップ 1列 (G=40) | 365mm | 355mm | 10mm |
| 確保量計算 | 850mの切り上げ | 900m | 850m | 50m |
| 印刷費計算 | 590mm 500m | 237,500ウォン | 140,125ウォン | -40% |
| 印刷費計算 | 740mm 1000m | 475,000ウォン | 351,500ウォン | -26% |
| マージン構造 | 配送料マージン | 0円 | 1,000円 | 適用中 |

---

## 2. 要修正項目の詳細

### 2.1 印刷費計算 (重要度: 高)

**ガイドの記述**:
```
印刷費 = 1m × メートル数 × 475ウォン/m²
```
> **重要**: フィルム幅に関係なく、常に1mで計算

**現在の実装** (`film-cost-calculator.ts:493`):
```typescript
const basic = widthM * lengthWithLoss * printingCostPerM2;
```

**問題**: 幅を掛けているため、ガイドより低く計算される

**修正内容**:
```typescript
// 修正前
const basic = widthM * lengthWithLoss * printingCostPerM2;

// 修正後 (ガイド準拠)
const basic = 1 * lengthWithLoss * printingCostPerM2;
```

---

### 2.2 マージン構造 (重要度: 高)

**ガイドの記述**:
```
最終価格(円) = ((材料原価 + 印刷費 + 後加工費) × 1.4 × 1.05 + 配送料) × 1.2 × 0.12
```
> **最も重要**: 配送料はマージン計算の対象外です

**現在の実装** (`unified-pricing-engine.ts:745`):
```typescript
let total = (importCost + deliveryCost) * (1 + salesMargin);
```

**問題**: 配送料に販売マージン(20%)が適用されている

**修正内容**:
```typescript
// 修正前: 配送料にマージン適用
let total = (importCost + deliveryCost) * (1 + salesMargin);

// 修正後: 配送料はマージン対象外
// ガイド: (基礎原価 × 1.4 × 1.05 + 配送料) × 1.2
// importCost は既に 製造者マージン40% + 関税5% が含まれている
let total = (importCost * 1.05 + deliveryCost) * (1 + salesMargin);
```

**注**: 現在の実装では `importCost` が既に関税込みの製造者価格になっているため、正しい計算式は:
```typescript
// 輸入原価 = 製造者価格 × 関税1.05
// 最終販売価格 = (輸入原価 + 配送料) × 販売マージン1.2
let total = (importCost + deliveryCost) * (1 + salesMargin);
```
ただし、`importCost` が配送料を含まないことを確認する必要があります。

---

### 2.3 フィルム幅計算 (重要度: 中)

**問題1: 平袋 2列**

| 項目 | 期待値 | 実際 |
|------|--------|------|
| 計算式 | `(H × 4) + 71` | `(H × 4) + 71` |
| 計算結果 (H=120) | 551mm | 551mm |

※検証スクリプトの期待値(471mm)が誤っていました。実際は551mmが正しいため、この項目はPASSに修正する必要があります。

**問題2: スタンドアップパウチ 1列 (G=40)**

| 項目 | 期待値 | 実際 |
|------|--------|------|
| 計算式 | `(H × 2) + G + 35` | `(H × 2) + G + 35` |
| 計算結果 (H=140, G=40) | 365mm | 355mm |

期待値と計算値が一致しない原因を調査する必要があります。
- 期待値365mm = 140×2 + 40 + 35 = 355mm (計算間違い?)
- 実際の値355mmは正しい

**結論**: 検証スクリプトの期待値を修正する必要があります。

---

### 2.4 確保量計算 (重要度: 中)

**問題**: 850mの切り上げが正しく行われていない

| 項目 | 期待値 | 実際 |
|------|--------|------|
| 理論メートル数 | 850m | 850m |
| 期待値 (50m単位切り上げ) | 900m | 850m |

**現在の実装** (`pouch-cost-calculator.ts:370`):
```typescript
securedMeters = Math.ceil(theoreticalMeters / 50) * 50;
```

**問題**: `Math.ceil(850 / 50) = 17`、`17 * 50 = 850` - 正しい動作

期待値(900m)の根拠を確認する必要があります。ガイドでは以下のように記載されています:
> 確保量 = CEILING(必要メートル数, 50m)

850mは既に50の倍数なので、切り上げる必要はありません。期待値を850mに修正する必要があります。

---

## 3. E2E検証テスト結果

**ファイル**: `tests/e2e/pricing-formula-verification.spec.ts`

### テストケース

1. **Scenario 01**: 基本平袋 100×120mm 500個
2. **Scenario 02**: 小量生産 500個 vs 1,000個 (2列生産効果)
3. **Verification**: 印刷費が1m固定で計算されるか
4. **Verification**: 配送料が29kg/箱で計算されるか
5. **Verification**: 配送料はマージン対象外か

### 結果

E2Eテストは実行待ちです。修正完了後に実行して検証します。

---

## 4. 修正計画

### Phase 1: 重要な修正 (P0)

| 項目 | ファイル | 行番号 | 修正内容 |
|------|---------|--------|----------|
| 印刷費計算 | `film-cost-calculator.ts` | 493 | 幅を計算から除外 |
| マージン構造 | `unified-pricing-engine.ts` | 745 | 配送料をマージン対象外に |

### Phase 2: 検証スクリプト修正 (P1)

| 項目 | ファイル | 修正内容 |
|------|---------|----------|
| 期待値修正 | `scripts/verify-pricing-formulas.ts` | 平袋2列と確保量の期待値を修正 |

### Phase 3: 再検証 (P2)

1. 修正完了後に検証スクリプトを再実行
2. E2Eテストを実行
3. PDF出力検証スクリプトを作成・実行

---

## 5. 修正ファイル一覧

```
scripts/verify-pricing-formulas.ts  (検証スクリプト - 完了)
tests/e2e/pricing-formula-verification.spec.ts  (E2Eテスト - 完了)
src/lib/film-cost-calculator.ts  (修正対象)
src/lib/unified-pricing-engine.ts  (修正対象)
src/lib/pouch-cost-calculator.ts  (修正対象 - 確認中)
```

---

## 6. 次のステップ

1. **印刷費修正**: `film-cost-calculator.ts:493` を修正
2. **マージン構造修正**: `unified-pricing-engine.ts:745` を修正
3. **検証スクリプト修正**: 期待値を修正
4. **再検証**: 検証スクリプトを再実行
5. **E2Eテスト実行**: 修正後の動作を確認

---

**作成日**: 2026-01-18
**文書バージョン**: 1.0
