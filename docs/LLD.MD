# EPackage Lab ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ”¹å–„ LLD

> ä½œæˆæ—¥: 2026-01-18
> ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.0

## ğŸ“ è¨­è¨ˆæ¦‚è¦

æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ”¹å–„ã®è©³ç´°è¨­è¨ˆã‚’è¨˜è¿°ã—ã¾ã™ã€‚

---

## 1. SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³é˜²æ­¢è¨­è¨ˆ

### 1.1 ç¾çŠ¶å•é¡Œ

```typescript
// src/lib/supabase-sql.ts:259-305 (å±é™º)
export async function insertQuotationItems(items: QuotationItemInput[]): Promise<SqlResult> {
  const valuesClauses = items.map((item) => {
    return `(
      '${item.quotation_id}',
      '${item.product_name.replace(/'/g, "''")}',  // ä¸ååˆ†
      ${item.category ? `'${item.category.replace(/'/g, "''")}'` : 'NULL'},
      ...
    )`;
  }).join(',\n');

  return executeSql(`INSERT INTO quotation_items (...) VALUES ${valuesClauses}`, []);
}
```

**å•é¡Œç‚¹**:
1. æ–‡å­—åˆ—è£œé–“ã§SQLæ§‹æˆ
2. `replace(/'/g, "''")`ã®ã¿ã§ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆä¸ååˆ†ï¼‰
3. æ•°å€¤ã‚„NULLã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ä¸å‚™
4. Unicode/ãƒãƒ«ãƒãƒã‚¤ãƒˆæ–‡å­—ã®è€ƒæ…®ä¸è¶³

### 1.2 è§£æ±ºè¨­è¨ˆ

#### æ–°é–¢æ•°: `insertQuotationItemsSafe`

```typescript
/**
 * ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒªã‚’ä½¿ç”¨ã—ãŸå®‰å…¨ãªè¦‹ç©ã‚¢ã‚¤ãƒ†ãƒ æŒ¿å…¥
 *
 * @param items - æŒ¿å…¥ã™ã‚‹è¦‹ç©ã‚¢ã‚¤ãƒ†ãƒ é…åˆ—
 * @returns SqlResult
 */
export async function insertQuotationItemsSafe(
  items: Array<{
    quotation_id: string;
    display_order: number;
    product_name: string;
    category: string | null;
    quantity: number;
    unit_price: number;
    total_price: number;
    specifications: string | null;
    notes: string | null;
  }>
): Promise<SqlResult> {
  // æ—¢å­˜ã®executeTransactioné–¢æ•°ã‚’æ´»ç”¨
  const queries = items.map((item) => ({
    query: `
      INSERT INTO quotation_items (
        quotation_id, display_order, product_name, category,
        quantity, unit_price, total_price, specifications, notes, created_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, NOW())
    `,
    params: [
      item.quotation_id,
      item.display_order,
      item.product_name,
      item.category,
      item.quantity,
      item.unit_price,
      item.total_price,
      item.specifications,
      item.notes,
    ] as (string | number | boolean | null)[],
  }));

  return executeTransaction(queries);
}
```

#### æ—¢å­˜é–¢æ•°: `executeTransaction`

```typescript
// src/lib/supabase-sql.ts:123-147
export async function executeTransaction<T = unknown>(
  queries: Array<{ query: string; params?: (string | number | boolean | null)[] }>
): Promise<SqlResult<T>> {
  try {
    const supabase = createServiceClient();

    // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚¯ã‚¨ãƒªæ§‹ç¯‰
    const transactionQuery = queries
      .map((q, i) => `-- Query ${i + 1}\n${q.query}`)
      .join(';\n');

    const allParams = queries.flatMap((q) => q.params ?? []);

    return executeSql<T>(transactionQuery, allParams);
  } catch (error) {
    console.error('[executeTransaction] Error:', error);

    return {
      error: {
        message: error instanceof Error ? error.message : 'Transaction failed',
        code: 'TRANSACTION_ERROR',
      },
    };
  }
}
```

### 1.3 ç§»è¡Œè¨ˆç”»

```typescript
// å¾“æ¥ã®é–¢æ•°ã‚’å®‰å…¨ãªå®Ÿè£…ã«ç½®ãæ›ãˆ
export const insertQuotationItems = insertQuotationItemsSafe;

// @deprecated ã‚¢ãƒˆãƒŸã‚¯ã‚¹ã‚¤ãƒƒãƒç”¨
export async function insertQuotationItemsLegacy(...): Promise<SqlResult> {
  // å…ƒã®å±é™ºãªå®Ÿè£…ï¼ˆå‰Šé™¤äºˆå®šï¼‰
}
```

---

## 2. MCP APIã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### 2.1 ç¾çŠ¶å•é¡Œ

```typescript
// src/app/api/supabase-mcp/execute/route.ts (å±é™º)
export async function POST(request: NextRequest) {
  const body = await request.json()
  const { query, params } = body

  // èªè¨¼ãªã—ï¼èª°ã§ã‚‚SQLå®Ÿè¡Œå¯èƒ½
  const supabase = createServiceClient()
  const { data, error } = await supabase.rpc('execute_sql', {
    sql_query: query,
    sql_params: params,
  })

  return NextResponse.json({ data })
}
```

### 2.2 è§£æ±ºè¨­è¨ˆ

#### èªè¨¼ãƒ¬ã‚¤ãƒ¤ãƒ¼

```typescript
import { verifyAdminAuth } from '@/lib/auth-helpers'
import { isProductionEnvironment } from '@/lib/env-validation'

export async function POST(request: NextRequest) {
  // ==================== ãƒ¬ã‚¤ãƒ¤ãƒ¼1: èªè¨¼ ====================
  const authResult = await verifyAdminAuth(request)
  if (!authResult) {
    return NextResponse.json(
      { error: 'Admin authentication required' },
      { status: 401 }
    )
  }

  // ==================== ãƒ¬ã‚¤ãƒ¤ãƒ¼2: SQLå®‰å…¨æ¤œè¨¼ ====================
  const body: ExecuteRequest = await request.json()
  const { query, params = [] } = body

  // 2.1 ã‚¯ã‚¨ãƒªé•·åˆ¶é™
  if (query.length > 10000) {
    return NextResponse.json(
      { error: { message: 'Query too long', code: 'QUERY_TOO_LONG' } },
      { status: 400 }
    )
  }

  // 2.2 å±é™ºãªSQLã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œå‡º
  const dangerousKeywords = [
    'DROP', 'DELETE', 'TRUNCATE', 'ALTER', 'GRANT', 'REVOKE',
    'CREATE', 'INSERT', 'UPDATE', 'EXECUTE', 'SCRIPT'
  ]

  const upperQuery = query.toUpperCase()
  for (const keyword of dangerousKeywords) {
    if (upperQuery.includes(keyword)) {
      // ãƒ­ã‚°è¨˜éŒ²
      console.warn('[MCP] Dangerous SQL keyword detected:', {
        userId: authResult.userId,
        keyword,
        query: query.substring(0, 100),
      })

      return NextResponse.json(
        { error: { message: `Dangerous SQL keyword: ${keyword}`, code: 'DANGEROUS_SQL' } },
        { status: 403 }
      )
    }
  }

  // 2.3 SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º
  const injectionPatterns = [
    /--/,           // SQLã‚³ãƒ¡ãƒ³ãƒˆ
    /\/\*/,         // è¤‡æ•°è¡Œã‚³ãƒ¡ãƒ³ãƒˆé–‹å§‹
    /\*\/,         // è¤‡æ•°è¡Œã‚³ãƒ¡ãƒ³ãƒˆçµ‚äº†
    /;\s*DROP/,    // ã‚³ãƒ¡ãƒ³ãƒˆå¾Œã®DROP
    /'/,            // ã‚¯ã‚ªãƒ¼ãƒˆï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã®ã¿è¨±å¯ï¼‰
  ]

  for (const pattern of injectionPatterns) {
    if (pattern.test(query)) {
      console.warn('[MCP] SQL injection pattern detected:', {
        userId: authResult.userId,
        pattern: pattern.source,
      })

      return NextResponse.json(
        { error: { message: 'Invalid SQL pattern detected', code: 'INVALID_SQL' } },
        { status: 403 }
      )
    }
  }

  // ==================== ãƒ¬ã‚¤ãƒ¤ãƒ¼3: SQLå®Ÿè¡Œï¼ˆå®‰å…¨ï¼‰ ====================
  const supabase = createServiceClient()
  const { data, error } = await supabase.rpc('execute_sql', {
    sql_query: query,
    sql_params: params,
  })

  // ==================== ãƒ¬ã‚¤ãƒ¤ãƒ¼4: ç›£æŸ»ãƒ­ã‚° ====================
  console.log('[MCP] SQL execution:', {
    userId: authResult.userId,
    role: authResult.role,
    isDevMode: authResult.isDevMode,
    queryLength: query.length,
    paramCount: params.length,
    success: !error,
    timestamp: new Date().toISOString(),
  })

  if (error) {
    return NextResponse.json(
      { error: { message: error.message, code: error.code || 'SQL_ERROR' } },
      { status: 400 }
    )
  }

  return NextResponse.json({
    data: Array.isArray(data) ? data : [data],
    rowsAffected: data?.length ?? 0,
  })
}
```

### 2.3 ç’°å¢ƒå¤‰æ•°æ¤œè¨¼

```typescript
// src/lib/env-validation.ts (æ–°è¦)
/**
 * æœ¬ç•ªç’°å¢ƒæ¤œè¨¼
 *
 * @returns {boolean} æœ¬ç•ªç’°å¢ƒã®å ´åˆtrue
 */
export function isProductionEnvironment(): boolean {
  return (
    process.env.NODE_ENV === 'production' ||
    process.env.NEXT_PUBLIC_APP_URL?.includes('prod') ||
    process.env.NEXT_PUBLIC_APP_URL?.includes('example.com') ||
    !process.env.NEXT_PUBLIC_APP_URL?.includes('localhost')
  )
}

/**
 * é–‹ç™ºãƒ¢ãƒ¼ãƒ‰å®‰å…¨æ¤œè¨¼
 *
 * æœ¬ç•ªç’°å¢ƒã§é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹å ´åˆã€ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã‚‹
 */
export function validateDevModeSafety(): void {
  const isProd = isProductionEnvironment()
  const devModeEnabled = process.env.ENABLE_DEV_MOCK_AUTH === 'true'

  if (isProd && devModeEnabled) {
    throw new Error(
      'CRITICAL: Dev mode (ENABLE_DEV_MOCK_AUTH) is enabled in production environment.\n' +
      'This is a security risk. Please disable ENABLE_DEV_MOCK_AUTH in production.'
    )
  }
}

// ã‚µãƒ¼ãƒãƒ¼èµ·å‹•æ™‚ã«æ¤œè¨¼å®Ÿè¡Œ
if (typeof window === 'undefined') {
  validateDevModeSafety()
}
```

---

## 3. é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–

### 3.1 å¤šé‡ç’°å¢ƒæ¤œè¨¼ãƒ¬ã‚¤ãƒ¤ãƒ¼

```typescript
// src/lib/dev-mode.ts (æ‹¡å¼µ)
import { validateDevModeSafety, isProductionEnvironment } from './env-validation'

/**
 * SECURE: é–‹ç™ºãƒ¢ãƒ¼ãƒ‰æ¤œè¨¼ï¼ˆå¼·åŒ–ç‰ˆï¼‰
 *
 * æ¤œè¨¼ãƒ¬ã‚¤ãƒ¤ãƒ¼:
 * 1. NODE_ENV === 'development'
 * 2. ENABLE_DEV_MOCK_AUTH === 'true'
 * 3. ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒã§ãªã„ã“ã¨
 * 4. localhostæ¥ç¶šã§ã‚ã‚‹ã“ã¨
 */
export function isDevMode(): boolean {
  // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ã¿
  if (typeof window !== 'undefined') {
    return false
  }

  // ãƒ¬ã‚¤ãƒ¤ãƒ¼1: åŸºæœ¬æ¤œè¨¼
  if (process.env.NODE_ENV !== 'development') {
    return false
  }

  // ãƒ¬ã‚¤ãƒ¤ãƒ¼2: ç’°å¢ƒå¤‰æ•°æ¤œè¨¼
  if (process.env.ENABLE_DEV_MOCK_AUTH !== 'true') {
    return false
  }

  // ãƒ¬ã‚¤ãƒ¤ãƒ¼3: ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³æ¤œè¨¼
  if (isProductionEnvironment()) {
    console.error('[SECURITY] Dev mode blocked in production environment')
    return false
  }

  return true
}
```

---

## 4. èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢çµ±åˆè¨­è¨ˆ

### 4.1 å…±é€šèªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

```typescript
// src/lib/api-auth.ts (æ–°è¦)
import { NextRequest, NextResponse } from 'next/server'
import { verifyAdminAuth, type AdminAuthResult } from './auth-helpers'

/**
 * èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚¿ã‚¤ãƒ—
 */
export type AuthMiddlewareOptions = {
  requireAdmin?: boolean
  requireMember?: boolean
  requireActive?: boolean
}

/**
 * APIãƒ«ãƒ¼ãƒˆç”¨èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ä½œæˆ
 */
export function createAuthMiddleware(options: AuthMiddlewareOptions = {}) {
  return async (request: NextRequest): Promise<AdminAuthResult | NextResponse> => {
    const authResult = await verifyAdminAuth(request)

    if (!authResult) {
      return NextResponse.json(
        { error: 'Authentication required' },
        { status: 401 }
      )
    }

    // ç®¡ç†è€…ãƒ­ãƒ¼ãƒ«ç¢ºèª
    if (options.requireAdmin && authResult.role !== 'ADMIN') {
      return NextResponse.json(
        { error: 'Admin role required' },
        { status: 403 }
      )
    }

    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ç¢ºèª
    if (options.requireActive && authResult.status !== 'ACTIVE') {
      return NextResponse.json(
        { error: 'Account not active' },
        { status: 403 }
      )
    }

    return authResult
  }
}

/**
 * APIãƒãƒ³ãƒ‰ãƒ©ãƒ¼èªè¨¼ãƒ©ãƒƒãƒ‘ãƒ¼
 */
export function withAuth<T = any>(
  handler: (request: NextRequest, auth: AdminAuthResult) => Promise<NextResponse<T>>,
  options: AuthMiddlewareOptions = {}
) {
  return async (request: NextRequest): Promise<NextResponse> => {
    const middleware = createAuthMiddleware(options)
    const result = await middleware(request)

    // èªè¨¼å¤±æ•—ã®å ´åˆã€ã‚¨ãƒ©ãƒ¼å¿œç­”ã‚’è¿”ã™
    if (result instanceof NextResponse) {
      return result
    }

    // èªè¨¼æˆåŠŸã®å ´åˆã€ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å®Ÿè¡Œ
    return handler(request, result as AdminAuthResult)
  }
}
```

### 4.2 ä½¿ç”¨ä¾‹

```typescript
// æ—¢å­˜APIãƒ«ãƒ¼ãƒˆã®ç§»è¡Œ
import { withAuth } from '@/lib/api-auth'

// ç§»è¡Œå‰
export async function POST(request: NextRequest) {
  const authResult = await verifyAdminAuth(request)
  if (!authResult) return unauthorizedResponse()
  // ...
}

// ç§»è¡Œå¾Œ
export const POST = withAuth(async (request, auth) => {
  // auth.userId, auth.role, auth.status ãŒåˆ©ç”¨å¯èƒ½
  return NextResponse.json({ userId: auth.userId })
}, { requireAdmin: true, requireActive: true })
```

---

## 5. ã‚¿ã‚¤ãƒ—ã‚¬ãƒ¼ãƒ‰è¨­è¨ˆ

### 5.1 ã‚¿ã‚¤ãƒ—ã‚¬ãƒ¼ãƒ‰ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

```typescript
// src/lib/type-guards.ts (æ–°è¦)

/**
 * ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¡Œã‚¿ã‚¤ãƒ—ã‚¬ãƒ¼ãƒ‰
 */
export function isDbRow<T>(value: unknown, validator: (v: any) => v is T): value is T {
  return typeof value === 'object' && value !== null && validator(value)
}

/**
 * ã‚¿ã‚¤ãƒ—ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå®‰å…¨ï¼‰
 */
export function assertType<T>(
  value: unknown,
  validator: (v: any) => v is T,
  message = 'Type assertion failed'
): asserts value is T {
  if (!validator(value)) {
    throw new TypeError(message)
  }
}

/**
 * é…åˆ—ã‚¿ã‚¤ãƒ—ã‚¬ãƒ¼ãƒ‰
 */
export function isArray<T>(value: unknown, validator?: (v: any) => v is T): value is T[] {
  if (!Array.isArray(value)) return false

  if (validator) {
    return value.every(item => validator(item))
  }

  return true
}

/**
 * UUIDæ¤œè¨¼
 */
export function isUUID(value: unknown): value is string {
  if (typeof value !== 'string') return false

  const uuidRegex =
    /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i

  return uuidRegex.test(value)
}

/**
 * Supabaseè¡Œã‚¿ã‚¤ãƒ—ã‚¬ãƒ¼ãƒ‰
 */
export function isSupabaseRow<T>(
  value: unknown
): value is { id: string } & T {
  return (
    typeof value === 'object' &&
    value !== null &&
    'id' in value &&
    isUUID((value as any).id)
  )
}
```

---

## 6. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¨­è¨ˆ

### 6.1 æ¨™æº–ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹

```typescript
// src/lib/api-error-handler.ts (æ–°è¦)

/**
 * APIã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹
 */
export class ApiError extends Error {
  constructor(
    public statusCode: number,
    public code: string,
    message: string,
    public details?: unknown
  ) {
    super(message)
    this.name = 'ApiError'
  }
}

/**
 * ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
 */
export function handleApiError(error: unknown): NextResponse {
  if (error instanceof ApiError) {
    return NextResponse.json(
      {
        error: {
          message: error.message,
          code: error.code,
          details: error.details,
        },
      },
      { status: error.statusCode }
    )
  }

  // äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼
  console.error('[API] Unexpected error:', error)

  return NextResponse.json(
    {
      error: {
        message: 'Internal server error',
        code: 'INTERNAL_ERROR',
      },
    },
    { status: 500 }
  )
}

/**
 * APIãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆè‡ªå‹•ã‚¨ãƒ©ãƒ¼å‡¦ç†ï¼‰
 */
export function withApiHandler<T = any>(
  handler: (request: NextRequest) => Promise<NextResponse<T>>
): (request: NextRequest) => Promise<NextResponse> {
  return async (request: NextRequest) => {
    try {
      return await handler(request)
    } catch (error) {
      return handleApiError(error)
    }
  }
}
```

---

## 7. æ¤œè¨¼ã‚¹ã‚­ãƒ¼ãƒè¨­è¨ˆ

### 7.1 Zodå…±é€šã‚¹ã‚­ãƒ¼ãƒ

```typescript
// src/lib/validation-schemas.ts (æ–°è¦)
import { z } from 'zod'

/**
 * UUIDã‚¹ã‚­ãƒ¼ãƒ
 */
export const uuidSchema = z.string().uuid()

/**
 * ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚¹ã‚­ãƒ¼ãƒ
 */
export const emailSchema = z.string().email()

/**
 * é›»è©±ç•ªå·ã‚¹ã‚­ãƒ¼ãƒï¼ˆæ—¥æœ¬ï¼‰
 */
export const phoneSchema = z.string().regex(
  /^(0\d{1,4}-\d{1,4}-\d{4}|0\d{9,10})$/,
  'Invalid phone number format'
)

/**
 * ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚­ãƒ¼ãƒ
 */
export const paginationSchema = z.object({
  page: z.coerce.number().int().positive().default(1),
  limit: z.coerce.number().int().positive().max(100).default(20),
  sortBy: z.string().optional(),
  sortOrder: z.enum(['asc', 'desc']).default('asc'),
})

/**
 * SQLã‚¯ã‚¨ãƒªå®‰å…¨ã‚¹ã‚­ãƒ¼ãƒ
 */
export const sqlQuerySchema = z.object({
  query: z.string().max(10000).refine(
    (q) => !['DROP', 'DELETE', 'TRUNCATE'].some(kw => q.toUpperCase().includes(kw)),
    'Dangerous SQL keyword detected'
  ),
  params: z.array(z.union([z.string(), z.number(), z.boolean(), z.null()])).default([]),
})

/**
 * å‹ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
 */
export type PaginationParams = z.infer<typeof paginationSchema>
export type SqlQueryParams = z.infer<typeof sqlQuerySchema>
```

---

## 8. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆ¦ç•¥

### 8.1 ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°

```bash
# .env
USE_PARAMETERIZED_QUERIES=true
MCP_AUTH_REQUIRED=true
STRICT_ENV_VALIDATION=true
UNIFIED_AUTH_MIDDLEWARE=true
```

### 8.2 æ¡ä»¶ä»˜ãã‚¤ãƒ³ãƒãƒ¼ãƒˆ

```typescript
// å®‰å…¨ãªå®Ÿè£…ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
export const insertQuotationItems = insertQuotationItemsSafe

// ãƒ¬ã‚¬ã‚·ãƒ¼å®Ÿè£…ï¼ˆãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
if (process.env.USE_PARAMETERIZED_QUERIES !== 'true') {
  console.warn('[SECURITY] Using legacy (unsafe) SQL implementation')
  // export const insertQuotationItems = insertQuotationItemsLegacy
}
```

---

## 9. ãƒ†ã‚¹ãƒˆè¨­è¨ˆ

### 9.1 SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ

```typescript
describe('insertQuotationItems', () => {
  it('should prevent SQL injection', async () => {
    const maliciousItems = [{
      quotation_id: "'; DROP TABLE quotations; --",
      product_name: "'; DELETE FROM users; --",
      // ...
    }]

    const result = await insertQuotationItems(maliciousItems)

    // ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚Œã€SQLã¨ã—ã¦å®Ÿè¡Œã•ã‚Œãªã„
    expect(result.error).toBeUndefined()
    expect(result.data).toBeDefined()
  })
})
```

### 9.2 MCP APIã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ

```typescript
describe('/api/supabase-mcp/execute', () => {
  it('should reject unauthenticated requests', async () => {
    const response = await fetch('/api/supabase-mcp/execute', {
      method: 'POST',
      body: JSON.stringify({ query: 'SELECT * FROM users' }),
    })

    expect(response.status).toBe(401)
  })

  it('should reject dangerous SQL keywords', async () => {
    const authenticatedRequest = // èªè¨¼æ¸ˆã¿ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

    const response = await authenticatedRequest.fetch('/api/supabase-mcp/execute', {
      method: 'POST',
      body: JSON.stringify({ query: 'DROP TABLE users' }),
    })

    expect(response.status).toBe(403)
  })
})
```

---

## 10. ç§»è¡Œãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

### ãƒ•ã‚§ãƒ¼ã‚º1 (Week 1): è‡´å‘½çš„è„†å¼±æ€§ä¿®æ­£
1. `insertQuotationItemsSafe`å®Ÿè£…
2. MCP APIèªè¨¼è¿½åŠ 
3. ç’°å¢ƒæ¤œè¨¼å¼·åŒ–

### ãƒ•ã‚§ãƒ¼ã‚º2 (Week 2): èªè¨¼æ¨™æº–åŒ–
1. `api-auth.ts`ä½œæˆ
2. å„ªå…ˆåº¦ã®é«˜ã„APIãƒ«ãƒ¼ãƒˆï¼ˆ10å€‹ï¼‰ã«é©ç”¨
3. ãƒ†ã‚¹ãƒˆã¨æ¤œè¨¼

### ãƒ•ã‚§ãƒ¼ã‚º3 (Week 3): ã‚¿ã‚¤ãƒ—å®‰å…¨æ€§
1. `type-guards.ts`ä½œæˆ
2. `@ts-ignore`ã‚’50%å‰Šé™¤
3. Zodæ¤œè¨¼å°å…¥

### ãƒ•ã‚§ãƒ¼ã‚º4 (Week 4): å®Œäº†ã¨æ¤œè¨¼
1. æ®‹ã‚Š50%ã®`@ts-ignore`å‰Šé™¤
2. å…¨APIãƒ«ãƒ¼ãƒˆèªè¨¼çµ±åˆ
3. E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
4. TypeScript strictãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹åŒ–

---

ä»¥ä¸Š
