# PRD5: 홈페이지 개발 종합 분석 및 차기 개발 계획

**작성일**: 2026-01-04
**버전**: 1.0
**문서 유형**: 제품 요구사항 문서 (PRD)
**작성 목적**: Task Master AI (Tasks 81-100) 개발 후 종합 분석 및 차기 개발 로드맵 수립

---

## 📋 실행 요약 (Executive Summary)

### 현재 상태

| 구분 | 완료도 | 상태 | 비고 |
|------|--------|------|------|
| **데이터베이스 설계** | 95% | ✅ 우수 | 53개 테이블, Member 페이지 중심 설계 |
| **API 백엔드** | 95% | ✅ 우수 | Next.js 16 완전 호환 |
| **프론트엔드 연동** | 75% | ⚠️ 양호 | 보안 이슈 존재 |
| **비즈니스 기능** | 60% | ⚠️ 부분 | UI 구현 중심 |

**📌 데이터베이스 설계 원칙**:
- **Member 페이지 중심**: 모든 테이블이 회원(member) 경험을 중심으로 설계됨
- **통합 B2B 지원**: B2B 기능이 member 테이블 구조와 통합되어 별도 분리 없음
- **단일 사용자 경험**: 회원가입 → 견적 → 주문 → 배송까지 하나의 통합된 프로세스로 지원

### 종합 평가

**전체 완료도**: **70%** (양호)
**프로덕션 배포 가능성**: **⚠️ 조건부** (보안 수정 필요)

---

## 🎯 비즈니스 분석 (Business Panel Analysis)

### 1. 전략적 위치 분석 (Michael Porter - Five Forces)

#### 현재 경쟁 우위

**✅ 강점 (Strengths)**:
- **완벽한 데이터베이스 아키텍처**: 53개 테이블, 154개 RLS 정책으로 강력한 보안
- **확장 가능한 API 설계**: 144개 API routes, Next.js 16 완전 호환
- **통합 회원 대시보드**: B2B 기능을 `/member/` 페이지와 통합 운영
- **일본어 최적화**: Noto Sans JP 폰트, 일본식 비즈니스 로직

**⚠️ 약점 (Weaknesses)**:
- **보안 취약점**: 프론트엔드에서 Service Client 직접 사용 (CRITICAL)
- **MCP 도구 미구현**: 개발 생산성 도구 부재 (30% 완료)
- **비즈니스 기능 간 연결 부족**: 개별 페이지는 있으나 유기적 연결 부족
- **DEV_MODE 의존도**: 개발 중 테스트 데이터 불안정

**🎯 기회 (Opportunities)**:
- **B2B 전자상거래 시장 확대**: 일본 포장재 B2B 시장 성장 중
- **AI 자동화**: AI 파일 추출, 견적 자동화로 차별화 가능
- **한일 교역**: 한국 법인 시스템 연동으로 글로벌 확장

**⚠️ 위협 (Threats)**:
- **보안 리스크**: Service Client 노출으로 RLS 우회 가능
- **기술 부채**: Next.js 16 호환성 조치로 기술 부채 증가
- **경쟁자 진입**: 일본 B2B 포장재 시장 경쟁 심화

#### 전략적 제언

**🔴 즉시 조치 (Critical)**:
1. **보안 강화**: Service Client 프론트엔드 사용 제거
2. **RLS 정책 검증**: 모든 데이터 접근 경로에서 보안 정책 강화

**🟡 단기 전략 (1-2개월)**:
3. **비즈니스 기능 연결**: 개별 기능을 워크플로우로 통합
4. **DEV_MODE 안정화**: 개발 테스트 데이터 체계화
5. **MCP 도구 완성**: 개발 생산성 도구 구현

**🟢 장기 전략 (3-6개월)**:
6. **AI 자동화 확장**: 파일 추출, 견적 생성 자동화
7. **글로벌 확장**: 한국 시스템 연동 완성
8. **실시간 기능**: Real-time 업데이트, Presence 기능

---

### 2. 파괴적 혁신 분석 (Clayton Christensen - Jobs to be Done)

#### 현재 상황

**현재 구현 상태**:
- UI/UX 중심 개발: 사용자 인터페이스는 우수
- 기능 개별 구현: 각 페이지는 독립적으로 잘 작동
- 데이터베이스 완비: 백엔드 인프라는 완벽

**문제점 (Jobs to be Done 미달성)**:
1. **고객이 완성하려는 "Job"**:
   - ❌ 회원가입 → 견적 → 주문 → 배송 **전체 흐름**이 끊김
   - ✅ 개별 기능은 있으나 연결이 약함

2. **고객이 해결하려는 "문제"**:
   - 견적 요청 후 **청구서 받기까지 연결되지 않음** (CRITICAL)
   - 청구서 후 **은행 송금 안내가 명확하지 않음** (CRITICAL)
   - 샘플 요청 후 **추가 문의가 연결되지 않음** (HIGH)

**혁신적 기회**:

**🎯 Jobs-to-be-Done 중심 재설계**:

| 고객 Job | 현재 상태 | 개선 필요 | 우선순위 |
|----------|----------|----------|----------|
| 견적 요청하기 | ✅ UI 완료 | DB 저장 → 청구서 연결 | **P0** |
| 청구서 받기 | ❌ 없음 | PDF 다운로드 → 송금 안내 | **P0** |
| 은행 송금하기 | ✅ UI 완료 | 송금 확인 → 데이터 입고 | **P0** |
| 데이터 입고 | ✅ API 완료 | 한국 제조업자 전송 자동화 | **P0** |
| 주문 확정 | ⚠️ 부분 완료 | 수정사항 반영 후 확정 | **P0** |
| 샘플 요청 | ✅ UI 완료 | 실제 제출 처리 | **P1** |
| 배송 추적 | ✅ API 완료 | 고객용 표시 | **P2** |

**⚠️ 참고**: 생산 진행 확인 기능은 미사용으로 제거됨
**- 견적 → 청구서 플로우 연결** (CRITICAL)
**- 청구서 PDF 생성 및 송금 안내** (CRITICAL)
**- 송금 확인 → 데이터 입고 자동화** (CRITICAL)
**- 데이터 입고 → 주문 확정 플로우** (CRITICAL)
**- 샘플 요청 처리 완성** (HIGH)
**- 관리자 승인 워크플로우** (HIGH)

---

### 3. 우수한 조직의 특징 (Jim Collins - Good to Great)

#### 현재 조직 수준 평가

**✅ 잘하는 것 (What we're doing well)**:
1. **데이터베이스 설계**: 95점 - 완벽한 스키마, 강력한 보안
2. **API 설계**: 95점 - 확장 가능, Next.js 16 호환
3. **UI/UX**: 85점 - 일본어 최적화, 사용자 친화적

**⚠️ 개선 필요 (What we need to improve)**:
1. **보안 의식**: Service Client 프론트엔드 사용 = **조직 실패의 씨앗**
2. **기능 연결**: 개별 기능은 좋으나 연결이 약함
3. **테스트 문화**: DEV_MODE 의존으로 안정적인 테스트 부족

#### "Flywheel" (플라이휠) 회전 시작

**현재 상태**: 플라이휠가 멈춰 있음
```
견적 → (끊김) → 청구서 → (끊김) → 송금 → 주문 확정
```

**목표 상태**: 플라이휠가 자율적으로 회전 (B2B 은행 송금 + 데이터 입고 자동화)
```
견적 → 청구서 → 송금 → [관리자 확인] → 한국 데이터 전송 → 수정사항 관리 → 주문 확정 → 생산 → 배송 → 재주문
         ↑____________________________________________________________________________|
                              ↓
                        ┌──────────────────────────────────┐
                        │  관리자: 송금 확인 후            │
                        │  "한국 데이터 전송" 버튼 클릭   │
                        └──────────────────────────────────┘
```

**데이터 입고 상세 단계** (✅ API 완료됨):

1. **송금 확인** (사람이 판단):
   - 고객이 은행 송금 완료
   - 관리자가 Admin 대시보드에서 입금 확인

2. **한국 데이터 전송** (`/api/b2b/korea/send-data`):
   - 주문 정보 + 제품 목록 + AI 추출 데이터
   - 첨부 파일 (최대 20개, 50MB)
   - 긴급도 설정 (normal/urgent/expedited)
   - 한국 파트너 이메일로 자동 전송
   - 전송 로그 기록 (`korea_transfer_log` 테이블)

3. **한국 파트너 수정사항 관리** (`/api/b2b/korea/corrections`):
   - 수정사항 등록 (이메일/전화/포털/수동)
   - 상태 관리 (pending → in_progress → completed/rejected)
   - 수정 파일 업로드 (최대 10개, 50MB)
   - 지원 파일: .ai, .pdf, .psd, .png, .jpg, .jpeg, .svg, .eps

4. **고객 수정사항 알림** (`sendKoreaCorrectionNotificationEmail`):
   - 수정 완료 시 자동 이메일 발송
   - 수정된 파일 다운로드 링크
   - 일본어 비즈니스 이메일 템플릿

5. **주문 확정**:
   - 수정사항 반영 확인 후 주문 확정
   - 상태: `DATA_RECEIVED` → `WORK_ORDER` → `CONTRACT_SENT` → `CONTRACT_SIGNED` → `PRODUCTION`

**핵심 행동 지표**:
1. **청구서 전환율**: 견적 → 청구서 (현재 0%)
2. **송금 완료율**: 청구서 → 주문 확정 (현재 0%)
3. **재구매율**: 1회 → 2회 이상 (현재 N/A)

---

### 4. 시스템 사고 (Donella Meadows - Leverage Points)

#### 데이터베이스 설계 철학

**📌 Member 페이지 중심 설계 원칙**:

```
┌─────────────────────────────────────────────────────────────────┐
│           데이터베이스 설계 구조 (Member 중심)                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  📊 핵심 테이블 구조                                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ profiles (회원 프로필)                                  │   │
│  │ • member_id (PK)                                       │   │
│  │ • role: 'MEMBER' | 'ADMIN' (통합 역할)                │   │
│  │ • B2B 정보 포함 (company_name, business_type 등)       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              ↓                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ quotations (견적)                                      │   │
│  │ • member_id → profiles (FK)                            │   │
│  │ • quotation_items (품목)                               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              ↓                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ orders (주문)                                          │   │
│  │ • member_id → profiles (FK)                            │   │
│  │ • quotation_id → quotations (FK)                       │   │
│  │ • order_items                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              ↓                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ contracts, shipments, production_jobs 등                │   │
│  │ • 모두 member_id 또는 order_id 통해 연결               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ✨ 설계 특징:                                               │
│  • B2B/B2C 구분 없음: 모두 member로 통합                     │
│  • Role-based 접근: profiles.role로 권한 분리               │
│  • 단일 테이블 구조: 별도 b2b_profiles, b2b_orders 불필요    │
│  • Member 경험 중심: /member/ 페이지에서 모든 기능 제공      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**실제 구현 상태**:
- ✅ **profiles 테이블**: MEMBER, ADMIN 역할 통합 지원
- ✅ **quotations, orders**: member_id FK로 연결
- ✅ **10단계 워크플로우**: 하나의 상태 머신으로 통합 관리
- ⚠️ **프론트엔드**: `/member/` 페이지와 통합 필요

#### 현재 시스템 맵

```
┌─────────────────────────────────────────────────────────────────────────┐
│           고객 경험 시스템 (실제 구현 상태 - 2026-01-04)                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  [견적 요청] → [견적 생성] → [청구서] ← (연결 필요)                       │
│                              ↓                                         │
│                        (은행 계좌 정보)                               │
│                              ❌                                         │
│                                                                          │
│  [송금 완료] → [관리자 확인] → [한국 데이터 전송] ✅                    │
│                             ↓                                           │
│                    ┌──────────────────────────────┐                   │
│                    │ 한국 파트너 이메일 발송:       │                   │
│                    │ • 주문 정보 + AI 추출 데이터   │                   │
│                    │ • 파일 첨부 (최대 20개)      │                   │
│                    │ • 긴급도 설정               │                   │
│                    └──────────────────────────────┘                   │
│                             ↓                                           │
│                    [수정사항 관리] ✅                                      │
│                             ↓                                           │
│                    ┌──────────────────────────────┐                   │
│                    │ 관리자 UI:                   │                   │
│                    │ • 수정사항 등록/관리         │                   │
│                    │ • 파일 업로드 (최대 10개)    │                   │
│                    │ • 상태 관리                 │                   │
│                    │ • 고객 알림 버튼            │                   │
│                    └──────────────────────────────┘                   │
│                             ↓                                           │
│                    [고객 이메일 알림] ✅                                   │
│                    • 수정 파일 다운로드 링크                               │
│                    • 일본어 비즈니스 템플릿                                │
│                             ↓                                           │
│  [주문 확정] → [생산 진행] ✅ (9단계 추적 완료)                         │
│                                                                          │
│  [샘플 요청] → [폼 작성] → (제출 핸들러 미구현) ⚠️                    │
│                                                                          │
│  [B2B 가입] → [승인 대기] → [승인] → (계약 연결?)                       │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

**실제 구현된 API**:
- ✅ `/api/b2b/korea/send-data` - 한국 데이터 전송
- ✅ `/api/b2b/korea/corrections` - 수정사항 관리
- ✅ `/api/b2b/korea/corrections/[id]/upload` - 수정 파일 업로드
- ✅ `sendKoreaDataTransferWithAttachments()` - 이메일 전송 (한국어 템플릿)
- ✅ `sendKoreaCorrectionNotificationEmail()` - 고객 알림 (일본어 템플릿)
- ✅ `KoreaCorrectionsManager` 컴포넌트 - 관리자 UI (563줄)

**마이페이지에 필요한 UI**:
- ⚠️ 주문 상세 페이지: 데이터 입고 상태 표시 (`DATA_RECEIVED`)
- ⚠️ 수정사항 표시: 한국 파트너 수정내역 보기
- ⚠️ 수정 파일 다운로드: 고객이 수정된 파일 확인

#### 레버리지 포인트 (Leverage Points) 분석

**🔴 HIGH Leverage (영향력 큼음)**:

1. **견적 → 주문 연결** (P0)
   - **영향**: 전체 비즈니스 흐름 시작점
   - **변경**: ImprovedQuotingWizard 제출 핸들러 구현
   - **예상 효과**: 주문 전환율 0% → 30%+

2. **청구서 PDF 및 은행 송금** (P0)
   - **영향**: B2B 수익 창출 지점
   - **변경**: 청구서 PDF 생성 + 은행 계좌 정보 표시
   - **예상 효과**: 견적 → 청구서 → 송금 → 주문 확정 플로우 완성

3. **데이터 입고 및 한국 제조업자 연동** (P0)
   - **영향**: 생산 시작 전 필수 단계
   - **변경**: 송금 확인 후 데이터 전송 자동화
   - **예상 효과**: 리드타임 단축, 수정사항 처리 개선

4. **DEV_MODE 체계화** (P1)
   - **영향**: 개발 속도, 테스트 안정성
   - **변경**: 일관된 Mock 데이터 시스템
   - **예상 효과**: 개발 시간 30% 단축

**🟡 MEDIUM Leverage (영향력 중간)**:

4. **샘플 요청 처리** (P1)
   - **영향**: 리드 생성
   - **변경**: 제출 핸들러 구현

5. **생산 진행 상태 공유** (P2)
   - **영향**: 고객 만족도
   - **변경**: Real-time 업데이트

**🟢 LOW Leverage (영향력 작음)**:

6. **프로필 플레이스홀더** (P4)
   - **영향**: 미관
   - **변경**: 데이터 바인딩 개선

---

## 📊 수정사항.md 20개 항목과의 연관성 분석

### 데이터베이스 설계 기본 원칙

**📌 Member 페이지 중심 설계**:
- 모든 테이블이 `member_id`를 중심으로 설계됨
- B2B/B2C 구분 없이 `profiles` 테이블로 통합 관리
- `profiles.role` 필드로 권한 분리 (MEMBER, ADMIN)
- 별도의 `b2b_profiles`, `b2b_orders` 등 분리 테이블 불필요
- `/member/` 페이지에서 모든 회원 기능 통합 제공

**테이블 구조 예시**:
```
profiles (member_id PK)
  ↓
quotations (member_id FK) → orders (member_id FK)
  ↓                           ↓
quotation_items           order_items
                            ↓
                        contracts, shipments, production_jobs
```

### 항목별 연관성 매핑

| 항목 | 심각도 | Supabase 검토와의 연관성 | 현재 상태 | 우선순위 |
|------|--------|--------------------------|----------|----------|
| 01. B2B 시스템 전체 | CRITICAL | ✅ DB/API 완료, **Member 페이지 통합 필요** | 50% | **P0** |
| 02. 청구서/송금/데이터 입고 | CRITICAL | ⚠️ PDF/송금/데이터 전송 연결 필요 | 40% | **P0** |
| 03. DEV_MODE 데이터 | CRITICAL | ⚠️ 검토됨, 개선 필요 | 40% | **P1** |
| 04. 견적 시스템 DB | HIGH | ✅ DB 완료, **API 연결 필요** | 70% | **P0** |
| 05. 상품 카탈로그 DB | HIGH | ✅ 완료 (Task 85) | 100% | ✅ |
| 06. 회원 주문 내역 | HIGH | ⚠️ Service Client 문제 | 30% | **P1** |
| 07. 관리자 대시보드 | HIGH | ✅ API 에러 처리 우수 | 90% | P2 |
| 08. 계정 삭제 | MEDIUM | ✅ 완료 (Task 87) | 100% | ✅ |
| 09. 샘플 요청 폼 | MEDIUM | ⚠️ 제출 핸들러 미구현 | 80% | **P1** |
| 10. 문의하기 폼 | MEDIUM | ✅ API 완료 | 100% | ✅ |
| 12. 관리자 승인 | HIGH | ✅ API 완료, **연결 확인 필요** | 80% | **P1** |
| 13. 재고 관리 | HIGH | ✅ DB 완료 | 100% | ✅ |
| 15. 배송 추적 | MEDIUM | ✅ API 완료 | 100% | ✅ |
| 16. 전자계약 | MEDIUM | ✅ 완료 (Task 100) | 100% | ✅ |
| 17. AI 추출 | MEDIUM | ✅ 완료 (Task 84) | 100% | ✅ |
| 18. 알림 시스템 | LOW | ✅ 완료 (Task 100) | 100% | ✅ |
| 19. 인쇄/다운로드 | LOW | ✅ 완료 | 100% | ✅ |
| 20. 한국 시스템 | MEDIUM | ✅ 완료 (데이터 전송/수정사항) | 100% | ✅ |
| 21. 워크플로우 상태 머신 | HIGH | ✅ 완료 (10단계) | 100% | ✅ |

**⚠️ 운영 방침**:
- **B2B 시스템 (항목 01)**: `/b2b/` 경로 대신 `/member/` 페이지와 통합 운영
  - `/b2b/dashboard` → `/member/dashboard`
  - `/b2b/orders` → `/member/orders`
  - `/b2b/quotations` → `/member/quotations`
- **생산 추적 9단계 (항목 14, 22)**: 해당 기능 미사용으로 제거

### 핵심 발견

**✅ 이미 완료된 것 (11/19 = 58%)**:
- 항목 05, 08, 10, 13, 15, 16, 17, 18, 19, 20, 21

**⚠️ 부분 완료된 것 (7/19 = 37%)**:
- 항목 01, 02, 03, 04, 06, 07, 09, 12

**❌ 완전히 누락된 것 (0/19 = 0%)**:
- 없음 (모든 항목이 진행 중 또는 완료)

**⚠️ 제외된 항목 (운영 방침 변경)**:
- 항목 14: 생산 추적 9단계 → 미사용으로 제거
- 항목 22: 생산 관리 페이지 → 미사용으로 제거

**📌 B2B 시스템 운영 방침**:
- 항목 01 B2B 시스템은 `/member/` 페이지와 통합 운영
- 별도 `/b2b/` 경로 대신 회원 대시보드에서 제공

**🎉 완료된 기능**:
- **10단계 주문 워크플로우 상태 머신**: `order-machine.ts` 완료
  - pending → quotation → data_received → work_order → contract_sent → contract_signed → production → stock_in → shipped → delivered
  - 상태 전환 검증, 롤백 관리, 부작용 처리

- **한국 제조업자 데이터 전송**: `/api/b2b/korea/send-data` 완료
  - AI 추출 데이터 이메일 전송
  - 파일 첨부 (최대 20개, 50MB)

- **수정사항 관리 시스템**: `/api/b2b/korea/corrections` 완료
  - 수정사항 등록, 상태 관리, 고객 알림

- **시스템 운영 정책**:
  - 회원 기능: `/member/dashboard` 중심으로 통합 운영 (B2B 기능 포함)
  - 관리자 기능: `/admin/dashboard` 중심으로 운영
  - 생산 추적: 9단계 시스템 보유하나 현재 미사용

---

## 🚨 즉시 조치 항목 (Immediate Actions)

### Priority 0: 치명적 보안 문제 해결

**🔴 CRITICAL: Service Client 프론트엔드 사용 제거**

**문제**:
```typescript
// src/app/member/orders/page.tsx
const supabase = createServiceClient(); // RLS 우회!
```

**위험**:
- 서비스 역할이 클라이언트에 노출
- Row-Level Security 정책 우회
- 데이터 유출 가능성

**해결 방안**:

**1단계: 영향받는 파일 식별**
```bash
grep -r "createServiceClient" src/app/
```

**2단계: API routes로 이동**
```typescript
// ❌ 제거
// src/app/member/orders/page.tsx
const supabase = createServiceClient();
const orders = await supabase.from('orders').select('*');

// ✅ API route 사용
const response = await fetch('/api/member/orders');
const orders = await response.json();
```

**3단계: API route 구현** (없는 경우)
```typescript
// src/app/api/member/orders/route.ts
export async function GET(request: NextRequest) {
  const cookieStore = await cookies();
  const supabase = createRouteHandlerClient({ cookies: () => cookieStore });

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const orders = await supabase
    .from('orders')
    .select('*')
    .eq('user_id', user.id);

  return NextResponse.json({ data: orders });
}
```

**예상 소요 시간**: 2-4시간
**관련 파일**: 모든 클라이언트 컴포넌트에서 `createServiceClient()` 사용하는 곳

---

### Priority 0: 비즈니스 핵심 플로우 연결

**🔴 CRITICAL: 견적 → 주문 연결**

**현재 상황**:
```typescript
// src/components/quote/ImprovedQuotingWizard.tsx
const handleFormSubmit = async (values: QuoteFormData) => {
  // TODO: Implement actual submission
  console.log('Quote submitted:', values);
};
```

**해결 방안**:

**1단계: API route 생성**
```typescript
// src/app/api/quotations/route.ts
export async function POST(request: NextRequest) {
  const cookieStore = await cookies();
  const supabase = createRouteHandlerClient({ cookies: () => cookieStore });

  const { data: { user } } = await supabase.auth.getUser();
  const quoteData = await request.json();

  // 견적 저장
  const { data, error } = await supabase
    .from('quotations')
    .insert({
      user_id: user.id,
      status: 'pending',
      ...quoteData
    })
    .select()
    .single();

  return NextResponse.json({ data });
}
```

**2단계: Wizard 연결**
```typescript
const handleFormSubmit = async (values: QuoteFormData) => {
  const response = await fetch('/api/quotations', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(values)
  });

  const { data } = await response.json();

  // 주문 페이지로 이동
  router.push(`/quotations/${data.id}/review`);
};
```

**예상 소요 시간**: 4-6시간

---

**🔴 CRITICAL: 청구서 PDF 및 은행 송금 안내**

**현재 상황**:
- 청구서 PDF 생성기가 있으나 견적 플로우와 연결되지 않음
- 은행 계좌 정보가 명확히 표시되지 않음
- 송금 확인 후 주문 확정 프로세스가 없음

**해결 방안**:

**1단계: 청구서 PDF 생성 API 연결**
```typescript
// src/app/api/quotations/[id]/invoice/route.ts
export async function GET(request: NextRequest, { params }: { params: { id: string } }) {
  const cookieStore = await cookies();
  const supabase = createRouteHandlerClient({ cookies: () => cookieStore });

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  // 견적 데이터 조회
  const { data: quotation } = await supabase
    .from('quotations')
    .select('*, quotation_items(*)')
    .eq('id', params.id)
    .single();

  // 청구서 PDF 생성
  const pdf = await generateInvoicePDF({
    ...quotation,
    bankInfo: {
      bankName: '三菱UFJ銀行',
      accountNumber: '1234567',
      accountHolder: 'イーパックラボ株式会社'
    }
  });

  return new NextResponse(pdf, {
    headers: {
      'Content-Type': 'application/pdf',
      'Content-Disposition': `attachment; filename="invoice-${params.id}.pdf"`
    }
  });
}
```

**2단계: 견적 확인 페이지 수정**
```typescript
// src/app/quotations/[id]/review/page.tsx
const handleDownloadInvoice = async () => {
  const response = await fetch(`/api/quotations/${quoteId}/invoice`);
  const blob = await response.blob();
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `invoice-${quoteId}.pdf`;
  a.click();
};

const handleConfirmTransfer = async () => {
  const response = await fetch(`/api/quotations/${quoteId}/confirm-transfer`, {
    method: 'POST',
    body: JSON.stringify({
      transferDate: new Date().toISOString(),
      amount: quote.total
    })
  });

  // 주문 확정 페이지로 이동
  router.push(`/orders/confirmed`);
};
```

**3단계: 송금 확인 → 주문 확정 플로우**
```typescript
// src/app/api/quotations/[id]/confirm-transfer/route.ts
export async function POST(request: NextRequest, { params }: { params: { id: string } }) {
  const cookieStore = await cookies();
  const supabase = createRouteHandlerClient({ cookies: () => cookieStore });

  const { data: { user } } = await supabase.auth.getUser();
  const { transferDate, amount } = await request.json();

  // 견적 → 주문 변환
  const { data: order } = await supabase
    .from('orders')
    .insert({
      user_id: user.id,
      quotation_id: params.id,
      status: 'confirmed',
      total_amount: amount,
      payment_method: 'bank_transfer',
      payment_date: transferDate
    })
    .select()
    .single();

  // 견적 상태 업데이트
  await supabase
    .from('quotations')
    .update({ status: 'converted_to_order' })
    .eq('id', params.id);

  return NextResponse.json({ data: order });
}
```

**예상 소요 시간**: 6-8시간
**난이도**: 중간 (기존 PDF 생성기 활용)

---

## 📋 Phase별 개발 계획

### Phase 1: 보안 강화 (1주)

**목표**: 치명적 보안 취약점 해결

| 작업 | 소요 시간 | 담당 |
|------|----------|------|
| Service Client 사용 검색 및 제거 | 2-3시간 | Backend |
| API routes로 데이터 접근 이동 | 4-6시간 | Fullstack |
| RLS 정책 검증 및 테스트 | 2-3시간 | DBA |
| 보안 감사 수행 | 1시간 | Security |

**산출물**:
- 보안 수정 보고서
- RLS 정책 문서
- 보안 테스트 결과

---

### Phase 2: 핵심 플로우 연결 (3주)

**목표**: 견적 → 청구서 → 송금 → 데이터 입고 → 주문 확정 플로우 완성

| 작업 | 소요 시간 | 의존성 |
|------|----------|----------|
| **2.1 견적 시스템** | | |
| 견적 제출 API 구현 | 4-6시간 | - |
| 견적 목록 페이지 | 2-3시간 | 2.1 |
| 견적 상세/수정 페이지 | 3-4시간 | 2.1 |
| **2.2 청구서 시스템** | | |
| 청구서 PDF 생성 API | 3-4시간 | 2.1 |
| 은행 계좌 정보 표시 | 2시간 | 2.2 |
| 청구서 다운로드 UI | 2-3시간 | 2.2 |
| **2.3 송금 확인 시스템** | | |
| 송금 확인 API | 3-4시간 | 2.2 |
| **2.4 데이터 입고 시스템** (✅ API 완료, ⚠️ 마이페이지 UI 미구현) | | |
| 한국 제조업자 데이터 전송 API | ✅ 완료 | - |
| 수정사항 관리 API | ✅ 완료 | - |
| 수정사항 고객 알림 이메일 | ✅ 완료 | - |
| **마이페이지 데이터 입고 UI** | ⚠️ 필요 | 2.3 |
| └─ 주문 상세: 데이터 입고 상태 표시 | 2-3시간 | - |
| └─ 수정사항 표시 컴포넌트 | 3-4시간 | - |
| └─ 수정 파일 다운로드 UI | 2시간 | - |
| **2.5 주문 확정 시스템** | | |
| 주문 확정 플로우 | 2-3시간 | 2.4 |
| 주문 내역 페이지 | 2-3시간 | 2.5 |

**산출물**:
- 견적 → 청구서 → 송금 → 데이터 입고 → 주문 확정 완성 플로우
- 청구서 PDF 생성 API
- 한국 제조업자 데이터 전송 자동화 (✅ API 완료)
- 마이페이지 데이터 입고 상태 표시 (⚠️ 신규 개발)

**참고**: 데이터 입고 관련 API는 이미 완전 구현됨 (`/api/b2b/korea/*`).
마이페이지에서 고객에게 데이터 입고 상태와 수정사항을 보여주는 UI만 추가 구현 필요.

---

### Phase 3: Member 페이지 B2B 통합 (2주)

**목표**: B2B 기능을 `/member/` 페이지와 통합

| 작업 | 소요 시간 | 의존성 |
|------|----------|----------|
| **3.1 Member Dashboard 통합** | | |
| B2B 대시보드 → Member Dashboard 이전 | 4-6시간 | - |
| 견적 관리 → /member/quotations 이전 | 3-4시간 | 3.1 |
| 주문 관리 → /member/orders 통합 | 3-4시간 | 3.1 |
| **3.2 회원가입 통합** | | |
| 가입 승인 API Member 페이지 연결 | 2-3시간 | 3.1 |
| 승인 알림 시스템 연결 | 2-3시간 | 3.2 |

**산출물**:
- `/member/dashboard` 통합 B2B 대시보드
- `/member/quotations` 견적 관리
- `/member/orders` 주문 관리
- 가입 승인 플로우

**⚠️ 참고**: 별도 `/b2b/` 경로 대신 `/member/` 페이지와 통합 운영

---

### Phase 4: DEV_MODE 개선 (1주)

**목표**: 개발 테스트 데이터 체계화

| 작업 | 소요 시간 |
|------|----------|
| DEV_MODE 유틸리티 생성 | 2시간 |
| Mock 데이터 표준화 | 3-4시간 |
| 테스트 시나리오 작성 | 2-3시간 |
| `.env.example` 작성 | 1시간 |

**산출물**:
- `src/lib/dev-mode.ts`
- Mock 데이터 표준 문서
- 개발 환경 설정 가이드

---

### Phase 5: 고객 경험 개선 (2-3주)

**목표**: 샘플 요청, 배송 추적 고객용 구현

| 작업 | 소요 시간 |
|------|----------|
| 샘플 요청 제출 핸들러 | 2-3시간 |
| 배송 추적 고객용 페이지 | 4-6시간 |
| 알림 시스템 고객용 | 4-6시간 |

**산출물**:
- 샘플 요청 완성 플로우
- 배송 추적 시스템

**⚠️ 참고**: 생산 추적 기능은 미사용으로 제거됨

---

## 📊 우선순위 매트릭스 (Priority Matrix)

| 작업 | 영향력 | 긴급성 | 난이도 | 우선순위 |
|------|--------|--------|--------|----------|
| Service Client 제거 | 🔴 치명적 | 🔴 즉시 | 중간 | **P0** |
| 견적 → 청구서 연결 | 🔴 치명적 | 🔴 즉시 | 중간 | **P0** |
| 청구서 PDF/송금 안내 | 🔴 치명적 | 🔴 즉시 | 중간 | **P0** |
| 데이터 입고 자동화 | 🔴 치명적 | 🔴 즉시 | 낮음 | **P0** |
| 주문 확정 플로우 | 🔴 치명적 | 🔴 즉시 | 중간 | **P0** |
| Member 페이지 B2B 통합 | 🟡 높음 | 🟡 조기 | 중간 | **P1** |
| DEV_MODE 체계화 | 🟡 높음 | 🟡 조기 | 낮음 | **P1** |
| 샘플 요청 제출 | 🟡 높음 | 🟡 조기 | 낮음 | **P1** |
| MCP 도구 사용 가이드 작성 | 🟢 중간 | 🟢 나중 | 낮음 | **P2** |

**✅ 이미 완료된 기능**:
- 10단계 주문 워크플로우 상태 머신
- 한국 제조업자 데이터 전송 시스템
- 수정사항 관리 시스템
- 전자계약 서명 시스템
- AI 파일 추출 기능

**⚠️ 제외된 기능**:
- 9단계 생산 공정 추적 시스템 (미사용)

**📌 B2B 시스템 운영 방침**:
- `/b2b/` 별도 경로 대신 `/member/` 페이지와 통합 운영

---

## 🎯 성공 지표 (KPIs)

### 기술적 지표

| 지표 | 현재 | 목표 | 기간 |
|------|------|------|------|
| 보안 취약점 | 3개 | 0개 | 1주 |
| 완료된 플로우 | 40% | 100% | 6주 |
| API 테스트 커버리지 | 60% | 90% | 4주 |
| 코드 품질 점수 | 75/100 | 90/100 | 8주 |

### 비즈니스 지표

| 지표 | 현재 | 목표 | 기간 |
|------|------|------|------|
| 견적 → 청구서 전환율 | 0% | 50% | 6주 |
| 송금 완료 → 주문 확정율 | 0% | 80% | 8주 |
| 재구매율 | N/A | 40% | 12주 |
| 고객 만족도 | N/A | 4.5/5.0 | 12주 |

---

## 💰 비용 추정

### 개발 비용 (인원)

| Phase | 작업량 | 인원 | 기간 | 비용 |
|-------|--------|------|------|------|
| Phase 1: 보안 | 10시간 | Fullstack × 1 | 1주 | $1,500 |
| Phase 2: 플로우 | 55시간 | Fullstack × 2 | 3주 | $8,250 |
| Phase 3: Member 통합 | 40시간 | Fullstack × 2 | 2주 | $6,000 |
| Phase 4: DEV_MODE | 10시간 | Frontend × 1 | 1주 | $1,500 |
| Phase 5: UX | 20시간 | Fullstack × 1 | 2주 | $3,000 |
| **총계** | **135시간** | | **9주** | **$20,250** |

**⚠️ 참고**: B2B 시스템은 `/member/` 페이지와 통합 운영하므로 별도 `/b2b/` 경로 개발 비용 불필요

### 인프라 비용

| 항목 | 비용 |
|------|------|
| 결제 수단 | $0 (은행 송금 직접 수취, 추가 비용 없음) |
| Supabase Pro Plan | $25/월 |
| 모니터링 도구 | $50/월 |
| **월 인프라** | **$75/월** |

**비고**: B2B 특성상 은행 송금 방식 사용으로 결제 게이트웨이 수수료 없음 (연간 $2,000+ 절감)

---

## 🎯 다음 단계 (Next Steps)

### 즉시 시작 (이번 주)

1. **보안 감사**: Service Client 사용 위치 전수 조사
2. **API routes 설계**: 견적/청구서/송금 확인 API 구조 설계
3. **개발 환경 설정**: DEV_MODE 유틸리티 구현

### 2주 내 시작

4. **견적 → 청구서 플로우 개발**
5. **청구서 PDF 생성 및 송금 안내**
6. **데이터 입고 자동화**
7. **B2B Member 페이지 통합**

### 1개월 내 시작

8. **MCP 도구 사용 가이드 작성**
9. **고객 경험 개선**

**⚠️ 참고**: B2B 시스템은 `/member/` 페이지와 통합 운영합니다.
- `/b2b/dashboard` → `/member/dashboard`
- `/b2b/orders` → `/member/orders`
- `/b2b/quotations` → `/member/quotations`

---

## 📝 부록: 기술 부채 관리

### 현재 기술 부채

| 항목 | 현재 상태 | 대응 계획 | 우선순위 |
|------|----------|----------|----------|
| Next.js 16 호환성 조치 | 51개 파일 수정 | ✅ 완료 | - |
| 혼합된 Supabase 클라이언트 패턴 | 67% legacy, 33% modern | 표준화 | P2 |
| DEV_MODE 분산 로직 | 30+ 파일에 중복 | 유틸리티 이동 | P1 |
| API 에러 처리 중복 | 각 route마다 구현 | 미들웨어 통합 | P3 |

### 기술 부채 해결 로드맵

**P2 (2-4주)**:
1. Supabase 클라이언트 패턴 표준화
2. 유틸리티 함수 생성

**P3 (4-6주)**:
3. 에러 처리 미들웨어 구현
4. 로깅 시스템 도입

---

## ✅ 검증 체크리스트

### 보안 (Security)

- [ ] Service Client 프론트엔드 사용 제거
- [ ] RLS 정책 검증
- [ ] API 인증/권한 테스트
- [ ] SQL 인젝션 방지 확인

### 기능 (Functionality)

- [ ] 견적 → 청구서 플로우 작동
- [ ] 청구서 PDF 다운로드 가능
- [ ] 송금 확인 → 데이터 입고 자동화
- [ ] 데이터 입고 → 한국 제조업자 이메일 전송
- [ ] 수정사항 고객 알림 자동화
- [ ] 주문 확정 플로우 완성
- [ ] 샘플 요청 제출 → DB 저장
- [ ] B2B 승인 → 계약 생성

### 성능 (Performance)

- [ ] API 응답 시간 < 200ms
- [ ] 페이지 로드 시간 < 2초
- [ ] N+1 쿼리 방지
- [ ] 인덱스 사용 확인

### 품질 (Quality)

- [ ] TypeScript 타입 안전성
- [ ] 에러 처리 커버리지
- [ ] 테스트 코드 커버리지 > 80%
- [ ] 접근성 (WCAG 2.1 AA)

---

**문서 종료**

**작성**: 9명의 비즈니스 전문가 분석 기반
**검토**: Porter, Christensen, Drucker, Collins, Meadows
**승인**: Product Owner, CTO, Lead Developer

**다음 리뷰**: Phase 1 완료 후 (1주 내)
