# Epackage Lab B2B 시스템 개선 프로젝트 PRD

**프로젝트 명**: Epackage Lab B2B 시스템 보안 및 접근성 개선
**작성 일자**: 2026-01-02
**버전**: 1.0
**작성자**: Claude Code

---

## 1. 프로젝트 개요 (Executive Summary)

### 1.1 배경

Epackage Lab B2B 시스템의 종합 코드 리뷰 결과, 전체 점수 **6.7/10**으로 평가되었습니다. 데이터베이스 구현(9.5/10)과 기능 구현(9/10)은 우수하나, **보안(4/10)**과 **접근성(5/10)** 분야에서 긴급 개선이 필요합니다.

### 1.2 현재 상태

| 구분 | 점수 | 상태 |
|------|------|------|
| 데이터베이스 | 9.5/10 | ✅ 프로덕션 준비 완료 |
| 기능 구현 | 9/10 | ✅ 대부분 완료 |
| UI/UX | 7.5/10 | ⚠️ 양호 (일부 개선 필요) |
| 코드 품질 | 7/10 | ⚠️ 보통 (타입 안전성 문제) |
| **보안** | **4/10** | 🔴 **긴급 개선 필요** |
| **접근성** | **5/10** | 🔴 **긴급 개선 필요** |

### 1.3 목표

**1차 목표 (P0 - 1~2주)**: 보안 취약점 및 접근성 문제 해결
**2차 목표 (P1 - 2~3주)**: UX 개선 및 관리자 워크플로우 완성
**3차 목표 (P2 - 3~4주)**: 사용성 향상
**4차 목표 (P3 - 1~2주)**: 성능 최적화

---

## 2. 문제 정의 (Problem Statement)

### 2.1 보안 취약점 (Critical)

#### 문제 #1: Dev Mode 인증 우회
- **위치**: `src/lib/supabase.ts:28-35`
- **문제**: 개발 모드에서 인증이 완전 우회됨
- **위험**: 실수로 프로덕션에 개발 모드 배포 가능
- **영향**: 🔴 **심각** - 인증 없이 시스템 접근 가능

#### 문제 #2: SQL 인젝션 위험
- **위치**: 20+ 파일에서 `as any` 타입 단언 사용
- **문제**: 타입 검사를 우회하여 SQL 쿼리 실행
- **위험**: 악의적 입력으로 데이터베이스 공격 가능
- **영향**: 🔴 **심각** - 데이터 무결성 위협

#### 문제 #3: XSS 취약점
- **위치**: `src/lib/email-templates.ts`
- **문제**: 사용자 입력이 포함된 이메일 본문 미검증
- **위험**: 악성 스크립트 삽입 가능
- **영향**: 🔴 **심각** - 클라이언트 공격 가능

#### 문제 #4: 권한 검증 부족
- **위치**: `/api/admin/*` 경로
- **문제**: 서비스 역할 키 사용 시 관리자 확인 부족
- **위험**: 일반 사용자가 관리자 기능 접근 가능
- **영향**: 🔴 **심각** - 권한 상승 공격 가능

### 2.2 접근성 문제 (Critical)

#### 문제 #1: 색상 대비 실패
- **위치**: `src/app/globals.css:779-794, 1051-1109`
- **문제**: 네이비 버튼 텍스트 대비 4.5:1 미달 (WCAG 2.1 AA)
- **영향**: 🔴 **심각** - 시각 장애인 사용 불가

#### 문제 #2: 모바일 메뉴 접근성 부족
- **위치**: `src/components/portal/PortalLayout.tsx:77-91`
- **문제**: ARIA 속성 누락, 키보드 내비게이션 불완전
- **영향**: 🔴 **심각** - 키보드 사용자 접근 불가

#### 문제 #3: 폼 에러 연결 누락
- **위치**: `src/components/ui/Input.tsx:195-196`
- **문제**: `role="alert"` 누락
- **영향**: 🟡 **중간** - 스크린 리더 사용자 경험 저하

### 2.3 타입 안전성 문제 (High)

#### 문제 #1: 과도한 `any` 타입 사용
- **위치**: 20+ 파일
- **문제**: TypeScript 타입 검사 우회
- **영향**: 🟡 **중간** - 런타임 오류 위험 증가

### 2.4 UX 문제 (Medium)

#### 문제 #1: 관리자 워크플로우 부족
- **위치**: 주문 관리 기능
- **문제**: 고객용은 완료, 관리자용은 부분적 (75%)
- **영향**: 🟡 **중간** - 관리자 업무 효율 저하

#### 문제 #2: 다단계 폼 미구현
- **위치**: B2B 등록, 샘플 요청
- **문제**: 단일 긴 폼으로 사용성 저하
- **영향**: 🟢 **낮음** - 사용자 경험 개선 필요

---

## 3. 해결 방안 (Solution)

### 3.1 P0: 긴급 (1~2주)

#### 3.1.1 Dev Mode 인증 제거 또는 보안 강화

**파일**: `src/lib/supabase.ts`

**현재 코드**:
```typescript
export const DEV_MODE = process.env.NEXT_PUBLIC_DEV_MODE === 'true'
export const mockUser: UserProfile = { ... }
```

**개선안**:
```typescript
export const DEV_MODE = process.env.NEXT_PUBLIC_DEV_MODE === 'true'

if (DEV_MODE && process.env.NODE_ENV === 'production') {
  throw new Error('DEV_MODE cannot be enabled in production!')
}
```

**수락 기준**:
- [ ] 프로덕션 환경에서 DEV_MODE 활성화 시 에러 발생
- [ ] 개발 환경에서는 정상 작동
- [ ] 환경 변수 확인 로직 강화

#### 3.1.2 SQL 인젝션 방지

**파일**: 20+ 파일 (API 경로)

**현재 코드**:
```typescript
const { data } = await (supabase as any)
  .from('production_jobs')
  .select('*')
```

**개선안**:
```typescript
import { Database } from '@/types/database'

const { data } = await supabase
  .from('production_jobs')
  .select<'*', Database['public']['Tables']['production_jobs']['Row'][]>('*')
```

**수락 기준**:
- [x] 모든 `as any` 제거
- [x] 제네릭 타입 가드 사용
- [x] ESLint 보안 경고 해결

#### 3.1.3 XSS 방지

**파일**: `src/lib/email-templates.ts`

**현재 코드**:
```typescript
html: `<p>Name: ${data.name}</p>`
```

**개선안**:
```typescript
import DOMPurify from 'dompurify'

html: `<p>Name: ${DOMPurify.sanitize(data.name)}</p>`
```

**수락 기준**:
- [ ] DOMPurify 설치 및 적용
- [ ] 모든 사용자 입력 sanitize
- [ ] 이메일 템플릿 XSS 테스트 통과

#### 3.1.4 색상 대비 수정

**파일**: `src/app/globals.css`

**현재 코드**:
```css
.bg-navy-600, .bg-navy-700 {
  &, & * {
    color: #FFFFFF !important;
  }
}
```

**개선안**:
```css
.bg-navy-600 {
  @apply text-inverse; /* Design token with proper contrast */
}
```

**수락 기준**:
- [ ] 네이비 버튼 대비 4.5:1 달성
- [ ] Lighthouse 접근성 점수 90+ 달성
- [ ] axe-core 테스트 통과

#### 3.1.5 모바일 메뉴 접근성

**파일**: `src/components/portal/PortalLayout.tsx`

**현재 코드**:
```typescript
<button
  onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}
  className="p-2..."
  aria-label="メニュー"
>
```

**개선안**:
```typescript
<button
  onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}
  aria-label="メニュー"
  aria-expanded={isMobileMenuOpen}
  aria-controls="sidebar-menu"
  onKeyDown={(e) => e.key === 'Escape' && setIsMobileMenuOpen(false)}
>
```

**수락 기준**:
- [ ] `aria-expanded`, `aria-controls` 추가
- [ ] Escape 키로 메뉴 닫기
- [ ] 포커스 관리 구현
- [ ] 키보드 내비게이션 완료

#### 3.1.6 폼 에러 연결

**파일**: `src/components/ui/Input.tsx`

**현재 코드**:
```typescript
<p id={errorId} className="text-error-500">
  {error}
</p>
```

**개선안**:
```typescript
<p id={errorId} className="text-error-500" role="alert">
  {error}
</p>
```

**수락 기준**:
- [ ] `role="alert"` 추가
- [ ] 스크린 리더로 에러 확인

### 3.2 P1: 높음 (2~3주)

#### 3.2.1 모바일 메뉴 접근성 (추가)

**수락 기준**:
- [ ] 포커스 트랩 구현
- [ ] 메뉴 열릴 때 첫 메뉴 항목으로 포커스 이동
- [ ] 메뉴 닫힐 때 트리거 버튼으로 포커스 복귀

#### 3.2.2 Select 컴포넌트 키보드 내비게이션

**파일**: `src/components/ui/Select.tsx`

**개선안**:
```typescript
onKeyDown={(e) => {
  switch (e.key) {
    case 'ArrowDown':
      e.preventDefault()
      // 다음 옵션으로 이동
      break
    case 'ArrowUp':
      e.preventDefault()
      // 이전 옵션으로 이동
      break
    case 'Home':
      e.preventDefault()
      // 첫 옵션으로 이동
      break
    case 'End':
      e.preventDefault()
      // 마지막 옵션으로 이동
      break
  }
}}
```

**수락 기준**:
- [ ] 방향키로 옵션 탐색
- [ ] Home/End 키 지원
- [ ] Enter/Space로 선택

#### 3.2.3 관리자 워크플로우 완성

**기능**:
- 주문 관리 API 추가
- 관리자 대시보드 기능 확장
- 주문 상태 변경 인터페이스

**수락 기준**:
- [ ] 주문 전체 목록 조회
- [ ] 주문 상태 변경 기능
- [ ] 주문 상세 정보 수정
- [ ] 대량 작업 지원

### 3.3 P2: 중간 (3~4주)

#### 3.3.1 다단계 폼 구현

**대상**: B2B 등록, 샘플 요청

**기능**:
```typescript
const steps = [
  { id: 'account', title: 'アカウント情報' },
  { id: 'company', title: '企業情報' },
  { id: 'documents', title: '書類アップロード' },
  { id: 'review', title: '確認' },
]
```

**수락 기준**:
- [ ] 위저드 컴포넌트 구현
- [ ] 단계별 진행률 표시
- [ ] 이전/다음 단계 네비게이션
- [ ] 초안 저장 기능

#### 3.3.2 샘플 요청 폼 섹션 분할

**파일**: `src/components/contact/SampleRequestForm.tsx` (716줄)

**개선안**:
```typescript
<CustomerInfoSection />
<DeliveryDestinationsSection />
<SampleItemsSection />
<MessageSection />
<PrivacySection />
```

**수락 기준**:
- [ ] 악코디언 섹션으로 분할
- [ ] 각 섹션별 검증
- [ ] 진행률 표시

#### 3.3.3 스켈레톤 로딩

**대상**: `FullPageSpinner` → `SkeletonLoader`

**수락 기준**:
- [ ] 대시보드 로딩 시 스켈레톤 표시
- [ ] 목록 페이지 로딩 시 스켈레톤 표시
- [ ] 로딩 상태 개선

#### 3.3.4 일본어 입력 개선

**기능**:
- 자동 변환 기능 (한자→카나)
- 설명 텍스트 추가
- 입력 힌트 제공

**수락 기준**:
- [ ] 자동 변환 기능 구현
- [ ] 입력 가이드 표시
- [ ] 사용자 피드백 개선

### 3.4 P3: 낮음 (1~2주)

#### 3.4.1 코드 분할

**대상**:
- `SampleRequestForm.tsx` (716줄)
- `pdf-generator.ts` (2000줄)

**수락 기준**:
- [ ] 컴포넌트 분할
- [ ] 모듈화 완료
- [ ] 번들 크기 감소

#### 3.4.2 React.memo 최적화

**수락 기준**:
- [ ] 불필요한 리렌더링 제거
- [ ] `useMemo`, `useCallback` 추가
- [ ] 성능 프로파일링 개선

#### 3.4.3 초안 저장 기능

**수락 기준**:
- [ ] localStorage에 임시 저장
- [ ] 복원 기능 구현
- [ ] 자동 저장 (30초마다)

---

## 4. 기능 요구사항 (Functional Requirements)

### 4.1 보안 요구사항

| ID | 요구사항 | 우선순위 | 상태 |
|----|----------|----------|------|
| SEC-001 | Dev Mode 프로덕션 배포 방지 | P0 | |
| SEC-002 | SQL 인젝션 방지 (타입 안전성) | P0 | ✅ 완료 |
| SEC-003 | XSS 방지 (이메일 템플릿) | P0 | |
| SEC-004 | 관리자 권한 검증 강화 | P0 | |

### 4.2 접근성 요구사항

| ID | 요구사항 | 우선순위 | 상태 |
|----|----------|----------|------|
| A11Y-001 | 색상 대비 4.5:1 달성 | P0 | |
| A11Y-002 | 모바일 메뉴 ARIA 속성 추가 | P0 | |
| A11Y-003 | 폼 에러 role="alert" 추가 | P0 | |
| A11Y-004 | 키보드 내비게이션 완료 | P0 | |
| A11Y-005 | 포커스 관리 구현 | P1 | |
| A11Y-006 | Select 컴포넌트 키보드 지원 | P1 | |

### 4.3 UX 요구사항

| ID | 요구사항 | 우선순위 | 상태 |
|----|----------|----------|------|
| UX-001 | 관리자 워크플로우 완성 | P1 | |
| UX-002 | 다단계 폼 구현 (B2B 등록) | P2 | |
| UX-003 | 샘플 요청 섹션 분할 | P2 | |
| UX-004 | 스켈레톤 로딩 적용 | P2 | |
| UX-005 | 일본어 입력 개선 | P2 | |
| UX-006 | 진행률 표시 추가 | P2 | |

### 4.4 성능 요구사항

| ID | 요구사항 | 우선순위 | 상태 |
|----|----------|----------|------|
| PERF-001 | 대형 컴포넌트 코드 분할 | P3 | |
| PERF-002 | React.memo 최적화 | P3 | |
| PERF-003 | 번들 크기 최적화 | P3 | |

---

## 5. 비기능 요구사항 (Non-Functional Requirements)

### 5.1 성능 요구사항

| 항목 | 목표 | 현재 | 개선 필요 |
|------|------|------|-----------|
| Lighthouse 점수 | 90+ | 85+ | ✅ |
| 접근성 점수 | 90+ | 65 | 🔴 |
| 번들 크기 | < 250KB | ~250KB | ⚠️ |
| LCP | < 2.5s | ~2s | ✅ |
| CLS | < 0.1 | ~0.05 | ✅ |

### 5.2 보안 요구사항

| 항목 | 목표 | 현재 | 개선 필요 |
|------|------|------|-----------|
| SQL 인젝션 방지 | 100% | 60% | 🔴 |
| XSS 방지 | 100% | 70% | 🔴 |
| 인증 우회 방지 | 100% | 0% | 🔴 |
| 권한 검증 | 100% | 80% | 🔴 |

### 5.3 접근성 요구사항 (WCAG 2.1 AA)

| 항목 | 목표 | 현재 | 개선 필요 |
|------|------|------|-----------|
| 색상 대비 | 4.5:1 | 3.5:1 | 🔴 |
| 키보드 내비게이션 | 100% | 70% | 🔴 |
| ARIA 라벨 | 100% | 60% | 🔴 |
| 스크린 리더 | 100% | 75% | 🟡 |

---

## 6. 우선순위 매트릭스

| 우선순위 | 항목 수 | 예상 기간 | 비즈니스 영향 |
|----------|---------|-----------|--------------|
| **P0: 긴급** | 6개 | 1~2주 | 🔴 보안/법적 리스크 |
| **P1: 높음** | 3개 | 2~3주 | 🟡 기능 결함 |
| **P2: 중간** | 5개 | 3~4주 | 🟢 사용성 개선 |
| **P3: 낮음** | 3개 | 1~2주 | ⚪ 성능 최적화 |

**총 예상 기간**: 7~11주 (병렬 작업 시 5~7주)

---

## 7. 성공 기준 (Success Criteria)

### 7.1 P0 완료 기준 (1~2주)

- [ ] Dev Mode 인증 우회 제거
- [x] SQL 인젝션 취약점 해결 (as any 제거)
- [ ] XSS 취약점 해결 (이메일 템플릿 sanitize)
- [ ] 색상 대비 4.5:1 달성
- [ ] 모바일 메뉴 접근성 완료
- [ ] 폼 에러 role="alert" 추가
- [ ] Lighthouse 접근성 점수 90+ 달성
- [x] ESLint 보안 경고 0개 (src/ 경로)

### 7.2 P1 완료 기준 (2~3주)

- [ ] Select 컴포넌트 키보드 내비게이션
- [ ] 관리자 워크플로우 완성 (100%)
- [ ] 포커스 관리 구현

### 7.3 P2 완료 기준 (3~4주)

- [ ] 다단계 폼 구현
- [ ] 샘플 요청 섹션 분할
- [ ] 스켈레톤 로딩 적용
- [ ] 일본어 입력 개선

### 7.4 P3 완료 기준 (1~2주)

- [ ] 코드 분할 완료
- [ ] React.memo 최적화
- [ ] 초안 저장 기능

### 7.5 최종 목표

| 항목 | 현재 | 목표 |
|------|------|------|
| 전체 점수 | 6.7/10 | 8.5+/10 |
| 보안 | 4/10 | 9+/10 |
| 접근성 | 5/10 | 9+/10 |
| UI/UX | 7.5/10 | 8.5+/10 |
| 코드 품질 | 7/10 | 8+/10 |

---

## 8. 기술 제약사항 (Technical Constraints)

### 8.1 기술 스택

- **프레임워크**: Next.js 16
- **언어**: TypeScript (Strict Mode)
- **데이터베이스**: Supabase (PostgreSQL)
- **스타일링**: Tailwind CSS 4
- **테스트**: Jest (단위), Playwright (E2E)
- **폼**: React Hook Form + Zod

### 8.2 브라우저 지원

- Chrome/Edge (최신 2버전)
- Safari (최신 2버전)
- Firefox (최신 2버전)
- 모바일 Safari iOS 14+
- Chrome Android

### 8.3 일본어 지원

- Noto Sans JP 폰트
- 일본어 비즈니스 형식 (請求書, 見積書, 契約書)
- 일본어 입력 검증 (한자/카나)

---

## 9. 릴리스 계획 (Release Plan)

### 9.1 Phase 1: 보안 및 접근성 (P0)

**기간**: 1~2주
**목표**: 보안 취약점 및 접근성 문제 해결
**성공 기준**:
- Lighthouse 접근성 90+
- ESLint 보안 경고 0개
- 모든 P0 항목 완료

### 9.2 Phase 2: UX 개선 (P1)

**기간**: 2~3주
**목표**: 관리자 워크플로우 완성, 키보드 내비게이션
**성공 기준**:
- 관리자 기능 100% 완료
- 키보드 내비게이션 완료

### 9.3 Phase 3: 사용성 향상 (P2)

**기간**: 3~4주
**목표**: 다단계 폼, 스켈레톤 로딩
**성공 기준**:
- 다단계 폼 구현
- 사용성 테스트 통과

### 9.4 Phase 4: 최적화 (P3)

**기간**: 1~2주
**목표**: 성능 최적화
**성공 기준**:
- 번들 크기 감소
- 렌더링 성능 개선

---

## 10. 리스크 관리 (Risk Management)

### 10.1 기술 리스크

| 리스크 | 확률 | 영향 | 완화 방안 |
|--------|------|------|-----------|
| 타입 안전성 개선 중 런타임 오류 | 중 | 높 | 점진적 리팩토링, 테스트 강화 |
| 접근성 수정으로 UI 변경 | 중 | 중 | 디자인 시스템 활용 |
| 보안 수정으로 기능 회귀 | 낮 | 높 | 포괄적 테스트 |

### 10.2 일정 리스크

| 리스크 | 확률 | 영향 | 완화 방안 |
|--------|------|------|-----------|
| P0 작업 예상보다 오래 소요 | 중 | 높 | 병렬 작업, 우선순위 재조정 |
| 테스트 불충분으로 버그 발생 | 중 | 중 | E2E 테스트 확대 |

---

## 11. 테스트 전략 (Testing Strategy)

### 11.1 보안 테스트

- SQL 인젝션 테스트
- XSS 테스트
- 인증/인가 테스트
- penetration testing

### 11.2 접근성 테스트

- axe-core 테스트
- Lighthouse 접근성 테스트
- 키보드 내비게이션 테스트
- 스크린 리더 테스트 (NVDA, JAWS)

### 11.3 기능 테스트

- 단위 테스트 (Jest)
- 통합 테스트
- E2E 테스트 (Playwright)

### 11.4 성능 테스트

- Lighthouse 테스트
- 번들 크기 측정
- 렌더링 성능 프로파일링

---

## 12. 승인 기준 (Acceptance Criteria)

### 12.1 최종 승인 조건

- [ ] 전체 점수 8.5+/10 달성
- [ ] 보안 점수 9+/10 달성
- [ ] 접근성 점수 9+/10 달성
- [ ] Lighthouse 전체 카테고리 90+ 달성
- [ ] 모든 P0, P1 항목 완료
- [ ] 80% 이상의 P2 항목 완료
- [ ] 프로덕션 배포 준비 완료

---

## 13. 용어 정의 (Glossary)

| 용어 | 정의 |
|------|------|
| P0 | 긴급 (Critical) - 보안, 법적 준비 |
| P1 | 높음 (High) - 기능 결함 |
| P2 | 중간 (Medium) - 사용성 개선 |
| P3 | 낮음 (Low) - 최적화 |
| WCAG 2.1 AA | 웹 콘텐츠 접근성 가이드라인 |
| RLS | Row Level Security (Supabase) |
| SQL 인젝션 | 악의적 SQL 코드 삽입 공격 |
| XSS | Cross-Site Scripting (사이트 간 스크립팅) |

---

## 14. 참고 문서 (References)

1. [COMPREHENSIVE_CODE_REVIEW_REPORT.md](../reports/COMPREHENSIVE_CODE_REVIEW_REPORT.md)
2. [WCAG 2.1 AA Guidelines](https://www.w3.org/WAI/WCAG21/quickref/)
3. [OWASP Top 10](https://owasp.org/www-project-top-ten/)
4. [Next.js 16 Documentation](https://nextjs.org/docs)
5. [Supabase Documentation](https://supabase.com/docs)

---

**문서 버전**: 1.0
**최종 수정**: 2026-01-02
**다음 검토**: P0 완료 후
