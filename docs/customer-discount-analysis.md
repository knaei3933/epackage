# é¡§å®¢åˆ¥å‰²å¼•ç‡ãƒã‚°åˆ†æå ±å‘Š

ä½œæˆæ—¥: 2026-02-17

---

## ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ

### æœŸå¾…ä¾¡æ ¼ vs å®Ÿéš›ä¾¡æ ¼

| é …ç›® | æœŸå¾…ä¾¡æ ¼ | å®Ÿéš›ä¾¡æ ¼ | å·®é¡ |
|------|----------|----------|------|
| **åˆè¨ˆé‡‘é¡** | **Â¥150,210** | **Â¥166,900** | **Â¥16,690** |
| **å˜ä¾¡** | **Â¥300.4/å€‹** | **Â¥333.8/å€‹** | **Â¥33.4/å€‹** |
| **æ•°é‡** | 500å€‹ | 500å€‹ | - |

**çµè«–**: é¡§å®¢åˆ¥å‰²å¼•ï¼ˆ10%OFFï¼‰ãŒé©ç”¨ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

---

## âœ… å‹•ä½œç¢ºèªæ¸ˆã¿

### 1. APIã¯æ­£ã—ãå‹•ä½œã—ã¦ã„ã‚‹

```javascript
// /api/user/markup-rate ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
{
  "success": true,
  "data": {
    "markupRate": -0.1,  // âœ… 10%å‰²å¼•
    "markupRateNote": null
  }
}
```

### 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹

```javascript
// /api/auth/current-user ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
{
  "success": true,
  "hasUser": true,
  "userId": "118b0906-4d3d-4a19-be96-7245e5492523",
  "email": "arwg22@gmail.com"
}
```

### 3. Cookieã«èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒå­˜åœ¨ã—ã¦ã„ã‚‹

```javascript
// Cookieãƒã‚§ãƒƒã‚¯
{
  "isLoggedIn": true,
  "hasCookie": true,
  "cookiesLength": 4245
}
```

### 4. ã‚³ãƒ¼ãƒ‰ã¯æ­£ã—ãè¨˜è¿°ã•ã‚Œã¦ã„ã‚‹

**`unified-pricing-engine.ts`**:
```typescript
// Step 3: è¼¸å…¥åŸä¾¡ + è²©å£²ãƒãƒ¼ã‚¸ãƒ³ = æœ€çµ‚è²©å£²ä¾¡æ ¼
// é¡§å®¢åˆ¥ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—ç‡ã‚’é©ç”¨ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ20%ã€è² ã®å€¤ã¯å‰²å¼•ï¼‰
const salesMargin = markupRate;  // âœ… é¡§å®¢åˆ¥ãƒãƒ¼ã‚¸ãƒ³ç‡ã‚’é©ç”¨
let totalPrice = importCost * (1 + salesMargin) + deliveryCost;
```

---

## ğŸ”´ å•é¡Œã®æ ¹æœ¬åŸå› 

### `RealTimePriceDisplay`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (3571è¡Œç›®)

```typescript
// é¡§å®¢åˆ¥ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—ç‡ã‚’å–å¾—
let customerMarkupRate = 0.2; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ20% âš ï¸
if (currentUser?.id) {
  try {
    const response = await fetch('/api/user/markup-rate');
    if (response.ok) {
      const result = await response.json();
      customerMarkupRate = result.data?.markupRate ?? 0.2;  // âš ï¸ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
    }
  } catch (e) {
    console.warn('[calculatePrice] Failed to fetch markup rate:', e);
  }
}

const quoteResult = await unifiedPricingEngine.calculateQuote({
  // ...
  markupRate: customerMarkupRate,  // ã“ã“ã§æ¸¡ã•ã‚Œã‚‹
  // ...
});
```

**å•é¡Œ**: `currentUser?.id`ãŒundefinedã®å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®`0.2`ï¼ˆ20%ï¼‰ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

### `handleNext`é–¢æ•° (3896è¡Œç›®)

```typescript
// Get customer-specific markup rate (if logged in)
let markupRate = 0.0; // Default 0% (no discount) âš ï¸
if (user?.id) {
  try {
    const response = await fetch('/api/user/markup-rate');
    if (response.ok) {
      const result = await response.json();
      markupRate = result.data?.markupRate ?? 0.0;  // âš ï¸ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
      console.log('[handleNext] Customer markup rate:', markupRate);
    }
  } catch (error) {
    console.warn('[handleNext] Failed to fetch markup rate, using default 50%:', error);
  }
}
```

**å•é¡Œ**: `user?.id`ãŒundefinedã®å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®`0.0`ï¼ˆ0%ï¼‰ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

---

## ğŸ” èª¿æŸ»çµæœ

### æœ¬ç•ªç’°å¢ƒã§console.logãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹

`next.config.ts`:
```typescript
compiler: {
  removeConsole: process.env.NODE_ENV === 'production' ? {
    exclude: ['error', 'warn'],
  } : false,
},
```

**çµæœ**: `console.log`ãŒè¡¨ç¤ºã•ã‚Œãªã„ãŸã‚ã€ãƒ‡ãƒãƒƒã‚°ãŒå›°é›£ã§ã™ã€‚

### ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼çŠ¶æ…‹ã¯æ­£å¸¸

- Cookieã«èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒå­˜åœ¨ã™ã‚‹
- `/api/auth/current-user`ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã‚‹
- `user.id`ã¯`118b0906-4d3d-4a19-be96-7245e5492523`

---

## ğŸ¯ ä»®èª¬

### ä»®èª¬1: `useAuth()`ãƒ•ãƒƒã‚¯ãŒæ­£ã—ãæ©Ÿèƒ½ã—ã¦ã„ãªã„

`RealTimePriceDisplay`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨`handleNext`é–¢æ•°ã§ã€`useAuth()`ã‹ã‚‰å–å¾—ã•ã‚Œã‚‹`user`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®`id`ãŒundefinedã«ãªã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

**æ¤œè¨¼æ–¹æ³•**:
- `useAuth()`ãƒ•ãƒƒã‚¯ã®å®Ÿè£…ã‚’ç¢ºèª
- `AuthContext`ãŒæ­£ã—ãåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«æ­£ã—ãæ¸¡ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

### ä»®èª¬2: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä¾¡æ ¼è¡¨ç¤ºã§`user`ãŒ`null`

ãƒšãƒ¼ã‚¸ãŒãƒªãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå¾Œã€`AuthContext`ãŒåˆæœŸåŒ–ã•ã‚Œã‚‹å‰ã«`RealTimePriceDisplay`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã€`user`ãŒ`null`ã«ãªã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

**æ¤œè¨¼æ–¹æ³•**:
- ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèª
- `AuthContext`ã®åˆæœŸåŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ç¢ºèª

---

## ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **`useAuth()`ãƒ•ãƒƒã‚¯ã®å®Ÿè£…ã‚’ç¢ºèª**
   - `AuthContext.tsx`ã§`useAuth()`ãƒ•ãƒƒã‚¯ãŒæ­£ã—ãå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
   - `user`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«`id`ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

2. **`RealTimePriceDisplay`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ‡ãƒãƒƒã‚°**
   - `user`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ­£ã—ãå–å¾—ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
   - `currentUser?.id`ãŒundefinedã®å ´åˆã®å‡¦ç†ã‚’è¿½åŠ 

3. **`handleNext`é–¢æ•°ã®ãƒ‡ãƒãƒƒã‚°**
   - `user`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ­£ã—ãå–å¾—ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
   - `user?.id`ãŒundefinedã®å ´åˆã®å‡¦ç†ã‚’è¿½åŠ 

4. **é–‹ç™ºç’°å¢ƒã§ãƒ†ã‚¹ãƒˆ**
   - æœ¬ç•ªç’°å¢ƒã§ã¯ãªãé–‹ç™ºç’°å¢ƒã§ãƒ†ã‚¹ãƒˆã—ã¦ã€console.logã‚’ç¢ºèª
   - é¡§å®¢åˆ¥å‰²å¼•ç‡ãŒæ­£ã—ãé©ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

---

## ğŸ’¡ æ¨å¥¨å¯¾ç­–

1. **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®å¤‰æ›´**
   - `RealTimePriceDisplay`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’`0.2`ã‹ã‚‰`0.0`ã«å¤‰æ›´
   - `handleNext`é–¢æ•°ã§ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’`0.0`ã‹ã‚‰`0.2`ã«å¤‰æ›´ï¼ˆçµ±ä¸€ï¼‰

2. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å¼·åŒ–**
   - `currentUser?.id`ãŒundefinedã®å ´åˆã®å‡¦ç†ã‚’è¿½åŠ 
   - APIå‘¼ã³å‡ºã—ãŒå¤±æ•—ã—ãŸå ´åˆã®å‡¦ç†ã‚’è¿½åŠ 

3. **ãƒ­ã‚°ã®å¼·åŒ–**
   - é–‹ç™ºç’°å¢ƒã§è©³ç´°ãªãƒ­ã‚°ã‚’å‡ºåŠ›
   - æœ¬ç•ªç’°å¢ƒã§ã‚‚é‡è¦ãªãƒ­ã‚°ã‚’å‡ºåŠ›ï¼ˆconsole.warnã‚„console.errorã‚’ä½¿ç”¨ï¼‰

---

## ğŸ“ ã¾ã¨ã‚

**å•é¡Œ**: é¡§å®¢åˆ¥å‰²å¼•ç‡ï¼ˆ10%OFFï¼‰ãŒé©ç”¨ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

**æœŸå¾…ä¾¡æ ¼**: Â¥150,210ï¼ˆ10%å‰²å¼•å¾Œï¼‰
**å®Ÿéš›ä¾¡æ ¼**: Â¥166,900ï¼ˆå‰²å¼•ãªã—ï¼‰

**åŸå› **: `user?.id`ãŒundefinedã§ã€APIãŒå‘¼ã³å‡ºã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**: `useAuth()`ãƒ•ãƒƒã‚¯ã®å®Ÿè£…ã‚’ç¢ºèªã—ã¦ã€`user`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ­£ã—ãå–å¾—ã•ã‚Œã¦ã„ã‚‹ã‹èª¿æŸ»ã—ã¾ã™ã€‚
