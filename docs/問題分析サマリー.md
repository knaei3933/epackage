# 修正時規則

## 基本ルール
1. gitにコミット及びプッシュしてVercelにデプロイトリガーすること
2. gitは必ず `https://github.com/knaei3933/epackage` でのみ作業を行う
3. Vercelは必ず `epackage-9p1709fzx-kims-projects-912b33ac.vercel.app` で作業すること
4. Vercelの新しいプロジェクトを絶対に作成しないこと
5. データベースはSupabase MCPを使用して確認及び修正が可能
6. 修正後再デプロイ後に検証を続ける場合は3分待ってから進める（デプロイに3分かかる）

## 最近の修正履歴

### 2026-02-18: 価格設定変更が見積もりに反映されないバグ修正
**問題**: AL単価などの価格設定を変更しても、見積もりシミュレーターに反映されない

**根本原因**:
- `pouch-cost-calculator.ts`で`calculateCostWithDBSettings`を呼び出す際、第二引数に`null`を渡していた
- これにより、データベース設定が使用されず、常にデフォルト値（7800 KRW）が使われていた

**修正内容**:
1. `PouchCostCalculator`にDB設定読み込み機能を追加
   - `loadSystemSettings()`メソッド（30秒キャッシュ）
   - `getSetting()`ヘルパーメソッド
   - `loadFilmCostSettings()`メソッド

2. 関数をasyncに変更してDB設定を渡す
   - `calculateFilmCost`
   - `calculateParallelProductionOptions`
   - `calculateSKUCost`
   - `calculateSingleSKUCost`
   - `calculateEconomicQuantitySuggestion`

3. 外部呼び出し元もasync/awaitに対応
   - `unified-pricing-engine.ts`
   - `ImprovedQuotingWizard.tsx`
   - `ResultStep.tsx`

**コミット**: `b95f1be` - fix: 価格設定変更が見積もりに反映されないバグを修正

### 重複設定削除マイグレーション (2026-02-18)
**目的**: 管理画面の重複設定を削除し、コードが使用する正しいキーのみを残す

**削除対象**:
- `alu_vapor_cost` - VMPETと同じため削除（VMPET_unit_priceを使用）
- `pet_transparent_cost`, `pet_cost` - PET_unit_priceに統合
- `pp_cost`, `pe_cost`, `aluminum_cost`, `paper_laminate_cost` - 未使用の削除
- `material_cost_*` - 古い命名規則のキーを削除
- `material_density_*` - 古い命名規則のキーを削除
- `material_price_krw_*` - film_materialカテゴリに統合済み

**実行方法**: `supabase/migrations/20260218_remove_duplicate_settings.sql` をSupabase SQL Editorで実行

**詳細手順**:
1. Supabaseダッシュボードを開く: https://supabase.com/dashboard/project/xypgmmgqzvdhjvlachwn/sql
2. SQL Editorに移動
3. `supabase/migrations/20260218_remove_duplicate_settings.sql` の内容をコピーして実行
4. 実行後、以下のクエリで確認：
   ```sql
   SELECT category, key, value, description, unit
   FROM system_settings
   WHERE category IN ('film_material', 'printing', 'lamination', 'slitter', 'exchange_rate', 'duty_rate', 'delivery', 'production', 'pricing')
   ORDER BY category, key;
   ```

**スクリプト実行**（代案）:
```bash
npx tsx scripts/apply-cleanup-migration.ts
```
このスクリプトは実行すべきSQLを表示します。

### 検証手順

**1. 価格設定変更のテスト**:
1. 管理画面でAL単価を変更（例: 7800 → 9000 KRW）
2. 見積もりシミュレーターで計算
3. ブラウザのコンソールで以下を確認：
   ```javascript
   // 価格設定APIのレスポンスを確認
   fetch('/api/pricing/settings').then(r => r.json()).then(d => console.log(d))
   ```
4. 30秒以上待ってから再度計算（キャッシュ期限切れ確認）
5. 新しい価格が反映されていることを確認

**2. 期待される動作**:
- DB設定の変更が30秒以内に見積もりに反映
- コンソールに`[PouchCostCalculator] Loaded pricing settings from DB: X settings`と表示
- 計算結果にDBの単価が使用されている

**3. コードレビュー結果**:
- ✅ `calculateCostWithDBSettings`に`dbSettings`が正しく渡されている
- ✅ `loadFilmCostSettings()`が`AL_unit_price`を読み込んでいる
- ✅ 30秒キャッシュで設定変更が迅速に反映

### 2026-02-18: デプロイ完了 & 検証待ち

**デプロイ完了**: コミット `2a1d8f3`
- 価格計算バグ修正が本番環境にデプロイ済み
- https://epackage-9p1709fzx-kims-projects-912b33ac.vercel.app

**検証方法**:
1. https://package-lab.com/admin/settings にアクセス
2. AL単価（`film_material.AL_unit_price`）を変更（例: 7800 → 9000）
3. 見積もりシミュレーターで計算
4. ブラウザコンソールで確認：
   ```
   [PouchCostCalculator] Loaded pricing settings from DB: X settings
   ```
5. 価格が変更されていることを確認

**注意**: Vercel認証保護により自動テストができないため、手動検証が必要です。

### 2026-02-18: 製造業者マージン率が反映されないバグ修正
**問題**: 管理画面で製造業者マージン率（`manufacturer_margin`）を変更しても、見積もり価格が変動しない

**根本原因**:
- `unified-pricing-engine.ts`で`CONSTANTS.MANUFACTURER_MARGIN`（ハードコードされた0.4）を使用していた
- DB設定の`manufacturer_margin`が読み込まれていなかった

**修正内容**:
- 968行：`manufacturerMargin`をDBから読み込むように変更
- 1187行：`filmCostSettings.pricing_manufacturer_margin`を使用
- 1108行：`pricing_manufacturer_margin`をDB設定に追加

**コミット**: `90dfed7` - fix: 製造業者マージン率をDB設定から読み込むように修正

### 2026-02-18: pricingカテゴリが公開APIに含まれていないバグ修正
**問題**: `manufacturer_margin`を変更しても価格が反映されない

**根本原因**:
- `/api/pricing/settings` APIの`PUBLIC_CATEGORIES`に`'pricing'`が含まれていなかった
- これにより`manufacturer_margin`と`default_markup_rate`がAPIレスポンスに含まれなかった

**修正内容**:
- `PUBLIC_CATEGORIES`に`'pricing'`を追加

**コミット**: `3a23d60` - fix: pricingカテゴリを公開APIに追加してマージン率設定を反映

### 2026-02-18: PouchCostCalculatorのキャッシュクリア機能追加
**問題**: 設定変更後もキャッシュが残り、価格が反映されない

**根本原因**:
- `PouchCostCalculator`に`clearSettingsCache()`メソッドがなかった
- キャッシュ無効化APIが`UnifiedPricingEngine`のキャッシュしかクリアしていなかった

**修正内容**:
- `PouchCostCalculator`に`clearSettingsCache()`メソッドを追加
- キャッシュ無効化APIで両方のエンジンのキャッシュをクリア

**コミット**: `2a3c0b5` - fix: PouchCostCalculatorのキャッシュもクリアするように修正

### 2026-02-18: デバッグログ追加
**目的**: `manufacturerMargin`の値が正しく読み込まれているか確認

**追加内容**:
- `calculateQuote`メソッドで`manufacturerMargin`の値をログ出力

**コミット**: `f28727c` - debug: manufacturerMarginの値をログ出力

### 2026-02-18: PouchCostCalculatorの製造業者マージン率ハードコード修正
**問題**: 管理画面で製造業者マージン率を変更しても、見積もり価格が変動しない

**根本原因**:
- `pouch-cost-calculator.ts`の`calculateCostBreakdown`メソッドで、製造者マージン率が**ハードコード**されていた（`manufacturerPriceKRW = baseCostKRW * 1.4`）
- `unified-pricing-engine.ts`での修正が、実際の計算を行う`PouchCostCalculator`には反映されていなかった
- `performSKUCalculation`メソッドが`PouchCostCalculator.calculateSKUCost`を使用していたため、`unified-pricing-engine.ts`側の`manufacturer_margin`読み込みが使用されていなかった

**修正内容**:
1. `calculateCostBreakdown`メソッドをasyncに変更
2. 製造者マージン率をDBから読み込むように変更
   - `manufacturerPriceKRW = baseCostKRW * 1.4` → `baseCostKRW * (1 + await this.getSetting('pricing', 'manufacturer_margin', 0.4))`
3. 販売マージン率もDBから読み込むように変更
   - `SALES_MARGIN = 0.2` → `await this.getSetting('pricing', 'default_markup_rate', 0.2)`
4. 呼び出し元2箇所に`await`を追加

**コミット**: `6dadf68` - fix: PouchCostCalculatorで製造業者マージン率をDB設定から読み込むように修正

**検証方法**:
1. 管理画面で製造業者マージン率を0に変更
2. 見積もりシミュレーターで計算
3. 価格が下がっていることを確認
4. マージン率を1.0（100%）に変更
5. 価格が上がっていることを確認

### 2026-02-18: 計算結果キャッシュがクリアされないバグ修正
**問題**: 設定変更後も価格が反映されない（キャッシュ無効化APIが機能していなかった）

**根本原因**:
- `UnifiedPricingEngine`には2種類のキャッシュがある：
  1. `this.cache` - **計算結果のキャッシュ**（`clearCache()`でクリア）
  2. `this.settingsCache` - **設定のキャッシュ**（`clearSettingsCache()`でクリア）
- キャッシュ無効化APIが`clearSettingsCache()`しか呼び出していなかった
- これにより、計算結果のキャッシュが残ったままだった
- 設定を変更しても、古い計算結果が使われていた

**修正内容**:
- `/api/admin/settings/cache/invalidate/route.ts`で`unifiedPricingEngine.clearCache()`を追加
- 計算結果キャッシュと設定キャッシュの両方をクリアするように変更

**コミット**: `acb3df9` - fix: キャッシュ無効化APIで計算結果キャッシュもクリアするように修正

**検証結果 (2026-02-18 完了)**:
✅ **manufacturer_marginの変更が価格に正しく反映されることを確認**

| manufacturer_margin | 単価 | 検証日時 |
|-------------------|------|----------|
| 0.01 (1%) | ¥130.15/個 | 2026-02-18 |
| 0.4 (40%) | ¥204/個 | 2026-02-18 |

**検証手順**:
1. 管理画面でmanufacturer_marginを0.01に変更
2. 見積もりシミュレーターで計算 → ¥130.15/個 ✅
3. 管理画面でmanufacturer_marginを0.4に戻す
4. 見積もりシミュレーターで計算 → ¥204/個 ✅
5. 価格が正しく変動することを確認

**結論**: manufacturer_marginのDB設定が正しく価格計算に反映されている

## デプロイ環境
- **GitHub**: https://github.com/knaei3933/epackage
- **Vercel**: https://epackage-9p1709fzx-kims-projects-912b33ac.vercel.app
- **Supabase**: https://supabase.com/dashboard/project/xypgmmgqzvdhjvlachwn