# 修正時規則

## 基本ルール
1. gitにコミット及びプッシュしてVercelにデプロイトリガーすること
2. gitは必ず `https://github.com/knaei3933/epackage` でのみ作業を行う
3. Vercelは必ず `epackage-9p1709fzx-kims-projects-912b33ac.vercel.app` で作業すること
4. Vercelの新しいプロジェクトを絶対に作成しないこと
5. データベースはSupabase MCPを使用して確認及び修正が可能
6. 修正後再デプロイ後に検証を続ける場合は3分待ってから進める（デプロイに3分かかる）

## 最近の修正履歴

### 2026-02-18: 価格設定変更が見積もりに反映されないバグ修正
**問題**: AL単価などの価格設定を変更しても、見積もりシミュレーターに反映されない

**根本原因**:
- `pouch-cost-calculator.ts`で`calculateCostWithDBSettings`を呼び出す際、第二引数に`null`を渡していた
- これにより、データベース設定が使用されず、常にデフォルト値（7800 KRW）が使われていた

**修正内容**:
1. `PouchCostCalculator`にDB設定読み込み機能を追加
   - `loadSystemSettings()`メソッド（30秒キャッシュ）
   - `getSetting()`ヘルパーメソッド
   - `loadFilmCostSettings()`メソッド

2. 関数をasyncに変更してDB設定を渡す
   - `calculateFilmCost`
   - `calculateParallelProductionOptions`
   - `calculateSKUCost`
   - `calculateSingleSKUCost`
   - `calculateEconomicQuantitySuggestion`

3. 外部呼び出し元もasync/awaitに対応
   - `unified-pricing-engine.ts`
   - `ImprovedQuotingWizard.tsx`
   - `ResultStep.tsx`

**コミット**: `b95f1be` - fix: 価格設定変更が見積もりに反映されないバグを修正

### 重複設定削除マイグレーション (2026-02-18)
**目的**: 管理画面の重複設定を削除し、コードが使用する正しいキーのみを残す

**削除対象**:
- `alu_vapor_cost` - VMPETと同じため削除（VMPET_unit_priceを使用）
- `pet_transparent_cost`, `pet_cost` - PET_unit_priceに統合
- `pp_cost`, `pe_cost`, `aluminum_cost`, `paper_laminate_cost` - 未使用の削除
- `material_cost_*` - 古い命名規則のキーを削除
- `material_density_*` - 古い命名規則のキーを削除
- `material_price_krw_*` - film_materialカテゴリに統合済み

**実行方法**: `supabase/migrations/20260218_remove_duplicate_settings.sql` をSupabase SQL Editorで実行

## デプロイ環境
- **GitHub**: https://github.com/knaei3933/epackage
- **Vercel**: https://epackage-9p1709fzx-kims-projects-912b33ac.vercel.app
- **Supabase**: https://supabase.com/dashboard/project/xypgmmgqzvdhjvlachwn