# 入稿データ・教正データ問題 分析サマリー

## 実施内容

以下の3つのドキュメントと1つのデバッグスクリプトを作成しました：

1. **詳細分析レポート**: `docs/入稿ダウンロードアップロード問題分析.md`
2. **デバッグガイド**: `docs/教正アップロードフォームデバッグガイド.md`
3. **デバッグスクリプト**: `scripts/debug-file-download.ts`
4. **本サマリードキュメント**

---

## 問題1: 入稿データダウンロード問題

### 問題の概要
ダウンロードボタンを押すと、AIファイルではなく異なるファイルがダウンロードされる

### 原因分析

#### ファイルパスの構造
```
アップロード時の保存パス: order_data_receipt/user-uuid/order-uuid/timestamp_filename.ai
バケット名: production-files
```

#### ダウンロード処理の流れ
```typescript
// 1. データベースから file_path を取得
file_path = "order_data_receipt/user-uuid/order-uuid/1234567890_design.ai"

// 2. ストレージアクセス
supabase.storage
  .from('production-files')  // バケット
  .createSignedUrl('order_data_receipt/...')  // パス
```

#### 考えられる原因
1. **データベースの file_path が間違っている**
   - 古いデータ形式が残っている
   - 移行前のパス形式が使われている

2. **Supabase Storage の問題**
   - バケット構造が異なる
   - ファイルが実際には存在しない

3. **Signed URL 生成の失敗**
   - パスが正しくない
   - フォールバックの public URL も間違っている

### 解決手順

#### ステップ1: デバッグスクリプトを実行
```bash
# Supabase credentials を確認
cat .env.local | grep SUPABASE

# デバッグスクリプト実行
npx tsx scripts/debug-file-download.ts <orderId>
```

スクリプトは以下を確認します：
- データベースのファイルレコード
- file_path, file_url の値
- Signed URL 生成の成功/失敗
- ファイルアクセスの可否

#### ステップ2: Supabase Dashboard で確認
1. Storage タブを開く
2. `production-files` バケットを確認
3. `order_data_receipt/` フォルダを探索
4. 対象ファイルが存在するか確認

#### ステップ3: データベースを直接確認
```sql
-- 対象注文のファイルを確認
SELECT
  id,
  original_filename,
  file_path,
  file_url,
  file_size_bytes
FROM files
WHERE order_id = '対象の注文ID'
ORDER BY uploaded_at DESC;
```

#### ステップ4: 必要に応じてデータ修正
```sql
-- もし file_path にバケット名が含まれている場合
UPDATE files
SET file_path = REPLACE(file_path, 'production-files/', '')
WHERE file_path LIKE 'production-files/%';
```

---

## 問題2: 教正データアップロード問題

### 問題の概要
「新規教正追加」ボタンを押してもフォームが表示されない

### 原因分析

#### コンポーネント構造
```typescript
// 親コンポーネント: DataAndCorrectionManagementTab
// 子コンポーネント: CorrectionRevisionsManager

<TabsContent value="correction">
  <CorrectionRevisionsManager orderId={orderId} fetchFn={fetchFn} />
</TabsContent>
```

#### 状態管理
```typescript
const [isAddingNew, setIsAddingNew] = useState(false);

// ボタン
<Button onClick={() => setIsAddingNew(!isAddingNew)}>
  {isAddingNew ? 'キャンセル' : '新規教正追加'}
</Button>

// フォーム表示
{isAddingNew && (
  <Card>/* フォーム内容 */</Card>
)}
```

#### 考えられる原因
1. **React 状態更新の問題**
   - レンダリングが発生していない
   - Strict Mode の問題

2. **JavaScript エラー**
   - コンポーネント内でエラーが発生
   - onClick ハンドラーが実行されていない

3. **CSS の問題**
   - フォームが描画されているが表示されていない
   - `display: none` や `visibility: hidden` が適用されている

4. **親コンポーネントの影響**
   - Tabs コンポーネントの問題
   - props が正しく渡されていない

### 解決手順

#### ステップ1: React DevTools で状態を確認
1. 開発者ツールを開く (F12)
2. React タブを選択
3. `CorrectionRevisionsManager` コンポーネントを見つける
4. `isAddingNew` の値を確認
5. ボタンをクリックして値が変わるか確認

#### ステップ2: コンソールでエラーを確認
```javascript
// 開発者ツールの Console タブで確認
// エラーメッセージ、警告をチェック
```

#### ステップ3: DOM 要素を確認
```javascript
// Elements/Inspector タブでフォームを検索
// Ctrl+F で "preview-image-input" などを検索
// フォームが DOM に存在するか確認
```

#### ステップ4: デバッグコードを追加
```typescript
// CorrectionRevisionsManager.tsx に追加

useEffect(() => {
  console.log('[CorrectionRevisionsManager] isAddingNew:', isAddingNew);
}, [isAddingNew]);

const handleToggleForm = () => {
  console.log('[Toggle] Before:', isAddingNew);
  setIsAddingNew(prev => {
    const newValue = !prev;
    console.log('[Toggle] After:', newValue);
    return newValue;
  });
};
```

#### ステップ5: 最小限のテスト
```typescript
// 一時的に state を true に固定
const [isAddingNew, setIsAddingNew] = useState(true);

// これで表示される場合: 状態管理の問題
// これでも表示されない: CSS またはレンダリングの問題
```

---

## 次のアクション

### 優先度1: ダウンロード問題の解決

1. **デバッグスクリプトの実行**
   ```bash
   npx tsx scripts/debug-file-download.ts <実際のorderId>
   ```

2. **Supabase Storage の確認**
   - Dashboard でファイルの存在を確認
   - パス構造を検証

3. **データベースの値を確認**
   - file_path が正しい形式か
   - 必要に応じて修正

### 優先度2: アップロード問題の解決

1. **React DevTools でデバッグ**
   - 状態変化を確認
   - エラーをチェック

2. **ブラウザコンソールの確認**
   - JavaScript エラー
   - React 警告

3. **デバッグコードの追加**
   - 状態変化のログ
   - onClick ハンドラーのログ

### 優先度3: 再発防止

1. **E2E テストの追加**
   - ファイルダウンロードのテスト
   - フォーム表示のテスト

2. **エラーハンドリングの強化**
   - ユーザーへのフィードバック
   - 詳細なエラーログ

3. **ドキュメントの更新**
   - トラブルシューティングガイド
   - API ドキュメント

---

## 技術的詳細

### 関連ファイル

#### ダウンロード関連
- `src/app/api/admin/orders/[id]/data-receipt/route.ts`
  - ファイル一覧取得 API
  - file_path, file_url を返却

- `src/app/api/admin/orders/[id]/files/[fileId]/download/route.ts`
  - ファイルダウンロード API
  - Signed URL 生成とファイル取得

- `src/components/admin/DataAndCorrectionManagementTab/DataReceiptSection.tsx`
  - フロントエンド UI
  - ダウンロードボタンの実装

#### アップロード関連
- `src/app/api/admin/orders/[id]/correction/route.ts`
  - 教正データアップロード API
  - Supabase Storage に保存

- `src/components/admin/DataAndCorrectionManagementTab/CorrectionRevisionsManager.tsx`
  - フロントエンド UI
  - フォームの表示/非表示

### データベーススキーマ

#### files テーブル
```sql
CREATE TABLE files (
  id UUID PRIMARY KEY,
  order_id UUID REFERENCES orders(id),
  file_type file_type NOT NULL,
  original_filename TEXT NOT NULL,
  file_url TEXT NOT NULL,
  file_path TEXT NOT NULL,  -- 重要: storage path only
  file_size_bytes INTEGER,
  uploaded_by UUID REFERENCES profiles(id),
  uploaded_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**重要**: `file_path` はバケット名を含まない純粋なストレージパス

#### design_revisions テーブル
```sql
CREATE TABLE design_revisions (
  id UUID PRIMARY KEY,
  order_id UUID REFERENCES orders(id),
  revision_number INTEGER NOT NULL,
  approval_status TEXT DEFAULT 'pending',
  partner_comment TEXT,
  preview_image_url TEXT,
  original_file_url TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### Supabase Storage 構造

```
production-files/
  └─ order_data_receipt/
      └─ {user_id}/
          └─ {order_id}/
              └─ {timestamp}_{filename}

correction-files/
  └─ corrections/
      └─ {order_id}/
          └─ rev{revision_number}/
              ├─ preview_{timestamp}_{filename}
              └─ original_{timestamp}_{filename}
```

---

## 期待される結果

### ダウンロード問題の解決後
1. 管理者が「ダウンロード」ボタンをクリック
2. 正しい AI ファイルがダウンロードされる
3. ファイル名が正しい
4. ファイルサイズが正しい
5. Adobe Illustrator で開ける

### アップロード問題の解決後
1. 管理者が「新規教正追加」ボタンをクリック
2. フォームが表示される
3. プレビュー画像と原版ファイルをアップロードできる
4. アップロード成功後、リストに追加される
5. 顧客が教正データを確認できる

---

## 添付資料

1. **詳細分析レポート**
   - `docs/入稿ダウンロードアップロード問題分析.md`
   - 問題の詳細な技術分析
   - 解決策の提案

2. **デバッグガイド**
   - `docs/教正アップロードフォームデバッグガイド.md`
   - ステップバイステップの手順
   - よくある問題と解決策

3. **デバッグスクリプト**
   - `scripts/debug-file-download.ts`
   - データベースと Storage の検証
   - 自動診断ツール

---

## 作成日
2026-02-01

## 作成者
Claude Code (AI Assistant)

## ステータス
📋 分析完了 - 次は実際のデバッグと修正の実施
