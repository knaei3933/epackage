# EPackage Lab セキュリティ改善 PRD

> 作成日: 2026-01-18
> バージョン: 1.0
> ステータス: 進行中

## 📋 プロダクト要件ドキュメント

---

## 1. 背景と目的

### 1.1 背景

EPackage Labアプリケーションのコードレビューにおいて、**致命的なセキュリティ脆弱性**が発見されました。これらは即時の修正が必要です。

### 1.2 目的

本プロジェクトの目的は、発見されたセキュリティ脆弱性を4週間で体系的に解決し、セキュアなアプリケーション環境を構築することです。

---

## 2. 発見された問題

### 2.1 致命的問題（即時対応）

| ID | 問題 | 重大度 | 影響 |
|----|------|--------|------|
| SEC-001 | SQLインジェクション | 🔴 致命的 | データベース操作、情報漏洩 |
| SEC-002 | MCP API無防備 | 🔴 致命的 | 任意のSQL実行、完全DB操作 |
| SEC-003 | 開発モードプロダクション漏洩 | 🔴 致命的 | 本番で開発機能有効化 |

### 2.2 高優先度問題

| ID | 問題 | 重大度 | 影響 |
|----|------|--------|------|
| SEC-004 | タイプ安全性欠如 | 🟡 高 | ランタイムエラー |
| SEC-005 | 不統一な認証チェック | 🟡 高 | 権限昇格 |

---

## 3. ソリューション概要

### 3.1 Week 1: 致命的セキュリティ修正

**目標**: 3つの致命的脆弱性を完全に修正

1. **SQLインジェクション防止**
   - パラメータ化クエリ導入
   - `insertQuotationItems`関数書き直し
   - 単体テスト追加

2. **MCP APIセキュリティ強化**
   - 管理者認証必須化
   - 危険SQLキーワードフィルタリング
   - 監査ログ実装

3. **開発モード強化**
   - 多重環境検証レイヤー
   - プロダクションで開発モードブロック

### 3.2 Week 2-3: 認証標準化 & タイプ安全性

1. **認証ミドルウェア統合**
   - 共通認証ライブラリ作成
   - 50+ APIルートに適用

2. **タイプガード導入**
   - 22個ファイルから`@ts-ignore`削除

### 3.3 Week 3-4: エラーハンドリング & 検証

1. **中京化エラーハンドラー**
2. **Zod検証スキーマ**

---

## 4. 機能要件

### FR-1: SQLインジェクション防止

**ID**: FR-SEC-001
**優先度**: P0（必須）

システムはすべてのSQLクエリをパラメータ化クエリとして実行し、SQLインジェクション攻撃を防止しなければなりません。

**受入基準**:
- [ ] `insertQuotationItems`関数がパラメータ化クエリを使用
- [ ] 悪意あるSQL入力が安全にエスケープ
- [ ] 単体テストでSQLインジェクション防止を確認
- [ ] 既存機能への回 regression なし

### FR-2: MCP API認証

**ID**: FR-SEC-002
**優先度**: P0（必須）

MCP APIエンドポイントは認証された管理者ユーザーのみアクセス可能でなければなりません。

**受入基準**:
- [ ] 未認証リクエストは401を返す
- [ ] 管理者以外は403を返す
- [ ] 危険SQLキーワードは403を返す
- [ ] 全SQL実行が監査ログに記録

### FR-3: 開発モードセキュリティ

**ID**: FR-SEC-003
**優先度**: P0（必須）

開発モードは開発環境でのみ有効化可能で、プロダクション環境では絶対に有効化できない仕組みが必要です。

**受入基準**:
- [ ] プロダクション環境で開発モード有効化時、起動をブロック
- [ ] 多重検証レイヤー実装
- [ ] 環境変数検証関数提供

### FR-4: 認証標準化

**ID**: FR-SEC-004
**優先度**: P1（高）

APIルートで一貫した認証チェックを実現する共通ミドルウェアを提供します。

**受入基準**:
- [ ] `createAuthMiddleware()`関数提供
- [ ] `withAuth()`ハンドラーラッパー提供
- [ ] 50% APIルートで統合認証使用

### FR-5: タイプ安全性

**ID**: FR-SEC-005
**優先度**: P1（高）

TypeScriptタイプチェックを迂回する`@ts-ignore`を削除し、タイプガードで安全なコードを実現します。

**受入基準**:
- [ ] `isDbRow()`, `assertType()`ガード提供
- [ ] 50% `@ts-ignore`削除
- [ ] TypeScript strictモード有効化

### FR-6: エラーハンドリング

**ID**: FR-SEC-006
**優先度**: P2（中）

一貫したエラー応答と監査可能なエラーロギングを実現します。

**受入基準**:
- [ ] `ApiError`クラス提供
- [ ] `handleApiError()`関数提供
- [ ] `withApiHandler()`ラッパー提供

---

## 5. 非機能要件

### NFR-1: セキュリティ

| 要件 | 説明 |
|------|------|
| 認証 | 全APIエンドポイントで適切な認証 |
| 認可 | ロールベースアクセス制御 |
| 監査 | 管理者操作のログ記録 |
| 暗号化 | 通信はHTTPSのみ |

### NFR-2: 性能

| 要件 | 目標 |
|------|------|
| レスポンス時間 | <100ms（認証オーバーヘッド） |
| 同時実行 | 1000リクエスト/秒 |

### NFR-3: 互換性

| 要件 | 説明 |
|------|------|
| API互換性 | 既存API呼び出し元に影響なし |
| データ互換性 | 既存データベーススキーマ維持 |

### NFR-4: 信頼性

| 要件 | 目標 |
|------|------|
| 可用性 | 99.9% |
| エラー処理 | 全エラーがログ記録 |
| ロールバック | 各変更をフィーチャーフラグで制御 |

---

## 6. 技術仕様

### 6.1 使用技術

| カテゴリ | 技術 |
|----------|------|
| 言語 | TypeScript 5.x |
| フレームワーク | Next.js 16 (App Router) |
| 認証 | Supabase Auth + SSR |
| 検証 | Zod |
| データベース | Supabase Postgres |

### 6.2 アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                        Client                                │
│                    (Next.js App)                             │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    API Routes Layer                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ /api/*       │  │ MCP API      │  │ Admin APIs   │      │
│  │ (public)     │  │ (protected)  │  │ (protected)  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│         │                  │                  │              │
│         │         ┌────────┴────────┐         │              │
│         │         │ Auth Middleware │         │              │
│         │         │ (verifyAdmin)   │         │              │
│         │         └─────────────────┘         │              │
└─────────┼───────────────────┬─────────────────┼──────────────┘
          │                   │                 │
          ▼                   ▼                 ▼
┌─────────────────────────────────────────────────────────────┐
│                    Security Layer                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ Type Guards  │  │ SQL Safety   │  │ Env Validate │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    Data Layer                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ Supabase     │  │ Parameterized│  │ Transaction  │      │
│  │ Client       │  │ Queries      │  │ Support      │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

---

## 7. 実装スケジュール

### Week 1: 致命的脆弱性修正

| 日 | タスク | 担当 |
|----|--------|------|
| 1-2 | SQLインジェクション防止 | Claude |
| 3 | MCP APIセキュリティ | Claude |
| 4-5 | 開発モード強化 | Claude |

### Week 2: 認証標準化

| 日 | タスク | 担当 |
|----|--------|------|
| 1-2 | 認証ミドルウェア実装 | Claude |
| 3-5 | APIルート移行（25%） | Claude |

### Week 3: タイプ安全性

| 日 | タスク | 担当 |
|----|--------|------|
| 1-2 | タイプガード実装 | Claude |
| 3-5 | `@ts-ignore`削除（50%） | Claude |

### Week 4: 完了と検証

| 日 | タスク | 担当 |
|----|--------|------|
| 1-2 | 残り`@ts-ignore`削除 | Claude |
| 3-4 | E2Eテスト実行 | Claude |
| 5 | リリース準備 | Claude |

---

## 8. テスト計画

### 8.1 単体テスト

| カテゴリ | テスト数 | カバレッジ目標 |
|----------|----------|---------------|
| SQL安全 | 15 | 100% |
| 認証 | 20 | 100% |
| タイプガード | 10 | 100% |
| 環境検証 | 8 | 100% |

### 8.2 統合テスト

| シナリオ | 説明 |
|----------|------|
| 認証フロー | ログイン→APIアクセス→ログアウト |
| MCP API | 認証→SQL実行→ログ確認 |
| 見積作成 | 見積作成→アイテム追加→保存 |

### 8.3 回帰テスト

既存E2Eテストスイート（全グループ）を実行し、機能 regression がないことを確認。

---

## 9. リスク管理

### 9.1 技術リスク

| リスク | 影響 | 緩和策 |
|--------|------|--------|
| 既存機能破壊 | 高 | フィーチャーフラグ、段階的ロールアウト |
| 性能劣化 | 中 | ベンチマークテスト |
| 互換性問題 | 中 | 妥当性テスト |

### 9.2 運用リスク

| リスク | 影響 | 緩和策 |
|--------|------|--------|
| デプロイ失敗 | 高 | ロールバック計画 |
| 設定ミス | 中 | 環境変数検証 |

---

## 10. 成功基準

### 10.1 Week 1完了時

- ✅ 全SQLインジェクション脆弱性パッチ完了
- ✅ MCP APIで管理者認証必須
- ✅ プロダクションで開発モード無効化
- ✅ セキュリティテスト0失敗

### 10.2 Week 2-3完了時

- ✅ 50% APIルートで統合認証使用
- ✅ 50% `@ts-ignore`削除完了
- ✅ 全エラーが中京化ハンドラーで処理

### 10.3 Week 3-4完了時

- ✅ 100% APIルートで統合認証
- ✅ 全`@ts-ignore`削除
- ✅ 全ルートで検証スキーマ使用
- ✅ TypeScript strictモード有効化
- ✅ 全E2Eテスト通過

---

## 11. 納入物

### 11.1 コード

- [ ] 修正済みソースコード
- [ ] 単体テスト
- [ ] 統合テスト

### 11.2 ドキュメント

- [ ] PRD（本ドキュメント）
- [ ] LLD
- [ ] TASK
- [ ] セキュリティガイドライン

### 11.3 構成

- [ ] 環境変数設定
- [ ] フィーチャーフラグ設定

---

## 12. 用語集

| 用語 | 説明 |
|------|------|
| SQLインジェクション | ユーザー入力を介して不正SQLを実行する攻撃 |
| パラメータ化クエリ | SQLクエリとパラメータを分離する安全な実行方法 |
| MCP | Model Context Protocolの略 |
| RLS | Row Level Securityの略 |
| JWT | JSON Web Tokenの略 |

---

## 13. 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|----------|
| 2026-01-18 | 1.0 | 初版作成 |

---

以上
