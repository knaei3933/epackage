# 入稿データダウンロード・アップロード問題分析レポート

## 発生した問題

### 1. 入稿データダウンロード問題
- **症状**: ダウンロードボタンを押すと、AIファイルではなく異なるファイルがダウンロードされる
- **影響**: 管理者が顧客がアップロードしたAIデザインファイルを正しく確認できない

### 2. 教正データアップロード問題
- **症状**: 「新規教正追加」ボタンを押してもフォームが表示されない
- **影響**: 韓国パートナーからの教正データをシステムに登録できない

---

## 問題1: 入稿データダウンロード問題の詳細分析

### ファイル構造の理解

#### アップロード時のファイルパス生成
```typescript
// src/app/api/member/orders/[id]/data-receipt/route.ts
function generateStoragePath(userId: string, orderId: string, fileName: string): string {
  const timestamp = Date.now();
  const sanitizedFileName = fileName.replace(/[^a-zA-Z0-9._-]/g, '_');
  return `order_data_receipt/${userId}/${orderId}/${timestamp}_${sanitizedFileName}`;
}
```

**実際の保存パス例**: `order_data_receipt/user-uuid/order-uuid/1234567890_design.ai`

#### データベース保存内容
```typescript
// files テーブルに保存される内容
{
  file_path: "order_data_receipt/user-uuid/order-uuid/1234567890_design.ai",
  file_url: "https://supabase-url/storage/v1/object/public/production-files/order_data_receipt/...",
  file_type: "AI",
  original_filename: "design.ai"
}
```

### ダウンロード処理の問題点

#### 現在の実装
```typescript
// src/app/api/admin/orders/[id]/files/[fileId]/download/route.ts
// L54-73
const filePath = file.file_path || extractPathFromUrl(file.file_url);

let bucket = 'production-files';
let storagePath = filePath;

if (filePath.startsWith('production-files/')) {
  storagePath = filePath.replace('production-files/', '');
}
```

### 問題の根本原因

**論理エラー**: コードは以下の仮定をしていますが、これは正しくありません:

1. **file_path がバケット名を含む** と仮定している
2. **file_path が "production-files/" で始まる** 場合のみ、バケット名を除去する

**実際の状況**:
- `file_path` = `order_data_receipt/user-uuid/order-uuid/1234567890_design.ai`
- バケット名 = `production-files`
- 正しいストレージパス = `order_data_receipt/user-uuid/order-uuid/1234567890_design.ai`

**現在のコードの動作**:
```typescript
// filePath が "production-files/" で始まらないので、そのまま使用
storagePath = "order_data_receipt/user-uuid/order-uuid/1234567890_design.ai"

// Supabase呼び出し
supabase.storage
  .from('production-files')  // バケット指定
  .createSignedUrl('order_data_receipt/...')  // パス指定
```

**これは正しい動作のはずです！**

### 別の可能性を調査

#### 可能性1: Supabase Storage バケットの問題
- `production-files` バケットが存在しない
- バケット内のフォルダ構造が異なる
- ファイルが実際には別の場所に保存されている

#### 可能性2: file_path の値の問題
- データベースに保存された `file_path` が実際の保存場所と異なる
- 古いデータで移行前のパス形式が使われている

#### 可能性3: Signed URL の問題
```typescript
// L79-81
const { data: signedUrlData, error: signedUrlError } = await supabase.storage
  .from(bucket)
  .createSignedUrl(storagePath, 300);
```

Signed URL 生成に失敗すると、フォールバックとして public URL にリダイレクトしますが、この URL が間違っている可能性があります。

#### 可能性4: ファイル拡張子の問題
AIファイルはバイナリファイルですが、以下の可能性があります:
- Supabase Storage が正しい Content-Type を返していない
- ブラウザが AI ファイルを認識できず、テキストとして表示しようとしている

### デバッグ方法

#### 1. データベースの file_path 値を確認
```sql
SELECT
  id,
  original_filename,
  file_path,
  file_url,
  file_type
FROM files
WHERE order_id = '対象の注文ID'
ORDER BY uploaded_at DESC;
```

#### 2. コンソールログの確認
ダウンロード時に以下のログが出力されます:
```
[File Download] Starting download...
[File Download] Bucket: production-files Path: order_data_receipt/...
[File Download] Fetching file from signed URL...
[File Download] Returning file: XXXXX bytes
```

#### 3. Supabase Storage を直接確認
Supabase Dashboard で以下を確認:
- `production-files` バケットが存在するか
- `order_data_receipt/` フォルダ配下にファイルが存在するか
- ファイルのサイズが正しいか

---

## 問題2: 教正データアップロード問題の詳細分析

### コンポーネントの状態管理

#### CorrectionRevisionsManager コンポーネント
```typescript
// src/components/admin/DataAndCorrectionManagementTab/CorrectionRevisionsManager.tsx
const [isAddingNew, setIsAddingNew] = useState(false);
```

#### ボタン実装
```typescript
// L185-192
<Button
  onClick={() => setIsAddingNew(!isAddingNew)}
  variant={isAddingNew ? 'outline' : 'default'}
  className="flex items-center gap-2"
>
  <Plus className="w-4 h-4" />
  {isAddingNew ? 'キャンセル' : '新規教正追加'}
</Button>
```

#### フォーム表示条件
```typescript
// L213
{isAddingNew && (
  <Card className="p-6 border-2 border-blue-200 bg-blue-50/30">
    // フォーム内容
  </Card>
)}
```

### 問題の根本原因

**論理**: コード自体は正しく実装されています。

#### 可能性1: React の状態更新が反映されない
- コンポーネントが再レンダリングされていない
- 親コンポーネントからの props で状態が上書きされている
- Strict Mode の二重レンダリングの問題

#### 可能性2: CSS の問題
- フォームが描画されているが表示されていない
- `display: none` や `visibility: hidden` が適用されている
- z-index の問題で別の要素の背後に隠れている

#### 可能性3: JavaScript エラー
- コンソールにエラーが出ていてレンダリングが止まっている
- onClick ハンドラーが実行時にエラーを投げている

#### 可能性4: 親コンポーネントの問題
```typescript
// このコンポーネントがどのように使われているか確認が必要
<CorrectionRevisionsManager
  orderId={orderId}
  fetchFn={fetch}  // カスタム fetch 関数が渡されている可能性
/>
```

### デバッグ方法

#### 1. React DevTools で状態を確認
1. React DevTools を開く
2. CorrectionRevisionsManager コンポーネントを選択
3. `isAddingNew` の値を確認
4. ボタンをクリックした後に値が変わるか確認

#### 2. コンソールにデバッグログを追加
```typescript
const handleClick = () => {
  console.log('[CorrectionRevisionsManager] Before:', isAddingNew);
  setIsAddingNew(!isAddingNew);
  console.log('[CorrectionRevisionsManager] After:', !isAddingNew);
};
```

#### 3. ブラウザの要素検査
1. ボタンをクリック
2. DOM 要素を検査
3. フォームの Card が DOM に存在するか確認
4. 存在する場合、どのような CSS が適用されているか確認

#### 4. エラーがあるか確認
ブラウザのコンソールを開いて、以下を確認:
- JavaScript エラー
- React 警告
- ネットワークエラー

---

## 解決策

### ダウンロード問題の解決策

#### 解決策1: デバッグログの追加
```typescript
// download/route.ts に詳細ログを追加
console.log('[File Download] File record:', {
  id: file.id,
  original_filename: file.original_filename,
  file_path: file.file_path,
  file_url: file.file_url,
});

console.log('[File Download] Storage access:', {
  bucket,
  storagePath,
  fullPath: `${bucket}/${storagePath}`,
});
```

#### 解決策2: Supabase Storage の直接確認
Supabase Dashboard で:
1. Storage タブを開く
2. `production-files` バケットを確認
3. `order_data_receipt/` フォルダを探索
4. 対象のファイルが存在するか確認

#### 解決策3: Content-Type の明示
```typescript
// AIファイルの正しい Content-Type を設定
const contentType = file.original_filename.endsWith('.ai')
  ? 'application/postscript'
  : fileResponse.headers.get('content-type') || 'application/octet-stream';
```

#### 解決策4: 直接ダウンロード URL の使用
```typescript
// Signed URL の代わりに直接ダウンロード
const { data: publicUrlData } = supabase.storage
  .from(bucket)
  .getPublicUrl(storagePath);

return NextResponse.redirect(publicUrlData.publicUrl);
```

### アップロード問題の解決策

#### 解決策1: デバッグ用の useEffect 追加
```typescript
useEffect(() => {
  console.log('[CorrectionRevisionsManager] isAddingNew changed:', isAddingNew);
}, [isAddingNew]);
```

#### 解決策2: onClick ハンドラーの強化
```typescript
const handleToggleForm = () => {
  console.log('[Toggle] Current state:', isAddingNew);
  setIsAddingNew(prev => {
    const newState = !prev;
    console.log('[Toggle] New state:', newState);
    return newState;
  });
};

<Button onClick={handleToggleForm}>
```

#### 解決策3: 親コンポーネントの確認
```typescript
// このコンポーネントを使用している場所で、props の確認
// 特に fetchFn が正しく渡されているか確認
```

#### 解決策4: CSS の強制表示
```typescript
// デバッグ用に常に表示させる
{true && (  // isAddingNew の代わりに true
  <Card className="p-6 border-2 border-blue-200 bg-blue-50/30">
    // ...
  </Card>
)}
```

---

## 次のステップ

### 優先度1: ダウンロード問題の解決
1. データベースの実際の file_path 値を確認
2. Supabase Storage のファイル構造を確認
3. ダウンロード時の詳細ログを収集
4. Signed URL 生成の成功/失敗を確認

### 優先度2: アップロード問題の解決
1. React DevTools で状態変化を確認
2. コンソールにデバッグログを追加
3. フォームが DOM に存在するか確認
4. CSS の問題を調査

### 優先度3: 根本的な改善
1. エラーハンドリングの強化
2. ユーザーへのフィードバックの改善
3. E2E テストの追加
4. ドキュメントの更新

---

## 技術的詳細

### 関連ファイル

#### ダウンロード関連
- `src/app/api/admin/orders/[id]/data-receipt/route.ts` - ファイル一覧取得
- `src/app/api/admin/orders/[id]/files/[fileId]/download/route.ts` - ファイルダウンロード
- `src/components/admin/DataAndCorrectionManagementTab/DataReceiptSection.tsx` - フロントエンドUI

#### アップロード関連
- `src/app/api/admin/orders/[id]/correction/route.ts` - 教正データアップロードAPI
- `src/components/admin/DataAndCorrectionManagementTab/CorrectionRevisionsManager.tsx` - フロントエンドUI

### データベーススキーマ

#### files テーブル
```sql
CREATE TABLE files (
  id UUID PRIMARY KEY,
  order_id UUID REFERENCES orders(id),
  file_type file_type NOT NULL,
  original_filename TEXT NOT NULL,
  file_url TEXT NOT NULL,
  file_path TEXT NOT NULL,  -- ここが重要
  file_size_bytes INTEGER,
  uploaded_by UUID REFERENCES profiles(id),
  uploaded_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### design_revisions テーブル
```sql
CREATE TABLE design_revisions (
  id UUID PRIMARY KEY,
  order_id UUID REFERENCES orders(id),
  revision_number INTEGER NOT NULL,
  approval_status TEXT DEFAULT 'pending',
  partner_comment TEXT,
  preview_image_url TEXT,
  original_file_url TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### Supabase Storage 構造

#### バケット
- `production-files` - 入稿データ（顧客アップロード）
- `correction-files` - 教正データ（パートナー提供）

#### パス構造
```
production-files/
  └─ order_data_receipt/
      └─ {user_id}/
          └─ {order_id}/
              └─ {timestamp}_{filename}

correction-files/
  └─ corrections/
      └─ {order_id}/
          └─ rev{revision_number}/
              ├─ preview_{timestamp}_{filename}
              └─ original_{timestamp}_{filename}
```

---

## 結論

### ダウンロード問題
コード自体は論理的に正しいですが、以下のいずれかの問題がある可能性が高い:
1. データベースの file_path が実際の保存場所と異なる
2. Supabase Storage のバケット/パス構造の問題
3. Signed URL 生成の失敗

**推奨**: まず実際のデータベース値と Supabase Storage の状態を確認すること。

### アップロード問題
コードは正しく実装されているため、以下の可能性があります:
1. React 状態更新の問題（レンダリングの問題）
2. CSS の表示問題
3. JavaScript エラー

**推奨**: React DevTools とコンソールログで状態変化を確認すること。

---

## 添付資料

- データベーススキーマ: `supabase/migrations/20250130000005_create_files_table.sql`
- 関連ドキュメント: `docs/reports/tjfrP/old/設計図.md`
- E2Eテスト: `tests/e2e/workflow/02-data-receipt-admin-review.spec.ts`
