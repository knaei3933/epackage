# 教正アップロードフォームデバッグガイド

## 問題: 「新規教正追加」ボタンが反応しない

---

## デバッグ手順

### ステップ1: React DevTools で状態を確認

1. ブラウザで開発者ツールを開く (F12)
2. 「React」タブを選択（もしインストールされていないなら、React Developer Tools 拡張をインストール）
3. Components タブで `CorrectionRevisionsManager` コンポーネントを見つける
4. Hooks セクションで `isAddingNew` の値を確認

**期待する動作**:
- 初期値: `false`
- ボタンクリック後: `true`

**実際の結果**:
- [ ] クリック前: `false` ✅ / ❌
- [ ] クリック後: `true` ✅ / ❌
- [ ] クリック後も `false` のまま → 状態更新の問題

---

### ステップ2: コンソールでエラーを確認

1. ブラウザの開発者ツールを開く (F12)
2. Console タブを選択
3. 「新規教正追加」ボタンをクリック
4. エラーメッセージを確認

**よくあるエラー**:

#### TypeError: Cannot read property 'X' of undefined
```javascript
// 例: setIsAddingNew が undefined
// 原因: useState のインポートミス
```

#### Warning: Can't perform a React state update on an unmounted component
```javascript
// 原因: コンポーネントがアンマウントされた後に状態更新
```

#### Uncaught Error: ...
```javascript
// 原因: 何らかのランタイムエラー
```

---

### ステップ3: DOM 要素を確認

1. ブラウザの開発者ツールを開く (F12)
2. Elements/Inspector タブを選択
3. 「新規教正追加」ボタンをクリック
4. DOM ツリーでフォームを探す

**検索方法**:
```
Ctrl+F (または Cmd+F) で検索:
- "新規教正追加"
- "preview-image-input"
- "border-2 border-blue-200"
```

**確認事項**:
- [ ] フォームの Card が DOM に存在する
- [ ] 存在する場合、どのような CSS が適用されているか
- [ ] `display: none` や `visibility: hidden` が適用されていないか
- [ ] `opacity: 0` や `height: 0` になっていないか

---

### ステップ4: デバッグコードの追加

以下のコードを `CorrectionRevisionsManager.tsx` に追加してデバッグ:

#### 4-1. useEffect で状態変化を監視

```typescript
useEffect(() => {
  console.log('[CorrectionRevisionsManager] isAddingNew changed to:', isAddingNew);
}, [isAddingNew]);
```

#### 4-2. onClick ハンドラーでログを出力

```typescript
const handleToggleForm = useCallback(() => {
  console.log('[Toggle Form] Before click, isAddingNew:', isAddingNew);
  setIsAddingNew(prev => {
    const newValue = !prev;
    console.log('[Toggle Form] Setting to:', newValue);
    return newValue;
  });
  console.log('[Toggle Form] After setIsAddingNew call');
}, [isAddingNew]);

// JSX で使用
<Button onClick={handleToggleForm}>
```

#### 4-3. 強制的にフォームを表示する（テスト用）

```typescript
// テスト用: 一時的に isAddingNew を true に固定
const [isAddingNew, setIsAddingNew] = useState(true);  // false → true に変更
```

**これでフォームが表示される場合**: 状態管理の問題
**これでも表示されない場合**: CSS またはレンダリングの問題

---

### ステップ5: CSS の問題を調査

もしフォームが DOM に存在しているが見えない場合:

#### 5-1. 計算済みスタイルを確認

```javascript
// ブラウザコンソールで実行
const card = document.querySelector('[class*="border-blue-200"]');
if (card) {
  const styles = window.getComputedStyle(card);
  console.log('Display:', styles.display);
  console.log('Visibility:', styles.visibility);
  console.log('Opacity:', styles.opacity);
  console.log('Height:', styles.height);
  console.log('Z-index:', styles.zIndex);
}
```

#### 5-2. 親要素の確認

```javascript
// 親要素に overflow: hidden がないか確認
const parent = card?.parentElement;
while (parent) {
  const styles = window.getComputedStyle(parent);
  console.log('Parent:', parent.className, 'overflow:', styles.overflow);
  // 親要素のチェック
  parent = parent.parentElement;
}
```

---

### ステップ6: 親コンポーネントの確認

`CorrectionRevisionsManager` を使用している親コンポーネントを確認:

```typescript
// 使用箇所を検索
<CorrectionRevisionsManager
  orderId={orderId}
  fetchFn={fetch}  // ← これが正しく渡されているか確認
/>
```

**確認事項**:
- [ ] `orderId` が正しい文字列である
- [ ] `fetchFn` が undefined ではない
- [ ] 親コンポーネントで key props が適切に設定されている

---

## よくある問題と解決策

### 問題1: React Strict Mode の二重レンダリング

**症状**: コンソールにログが2回出力される

**解決策**: これは正常な動作です（開発モードのみ）

```typescript
// next.config.ts で Strict Mode を無効化（テスト用）
module.exports = {
  reactStrictMode: false,  // 一時的に無効化
};
```

---

### 問題2: ステートのバッチ更新

**症状**: `isAddingNew` が更新されない

**原因**: 複数の状態更新がバッチされている

**解決策**:
```typescript
// 自動バッチングを回避（React 18+）
import { flushSync } from 'react-dom';

const handleToggleForm = () => {
  flushSync(() => {
    setIsAddingNew(!isAddingNew);
  });
};
```

---

### 問題3: 古いクロージャの捕捉

**症状**: イベントハンドラーが古い状態を参照している

**解決策**:
```typescript
// useCallback の依存配列を確認
const handleToggleForm = useCallback(() => {
  setIsAddingNew(prev => !prev);  // 関数形式を使用
}, []);  // 依存配列を空に
```

---

### 問題4: CSS-in-JS の競合

**症状**: フォームが描画されるがすぐに消える

**解決策**:
```typescript
// 一時的に強制的なスタイルを適用
<Card
  className="p-6 border-2 border-blue-200 bg-blue-50/30"
  style={{ display: 'block', visibility: 'visible', opacity: 1 }}
>
```

---

### 問題5: 親コンポーネントからの制御

**症状**: 親コンポーネントが状態を管理している

**確認方法**:
```typescript
// 親コンポーネントでこのようなコードを探す
const [isAddingNew, setIsAddingNew] = useState(false);
// ...
<CorrectionRevisionsManager
  isAddingNew={isAddingNew}  // ← props として渡されている
  onToggle={setIsAddingNew}
/>
```

**解決策**: 親コンポーネントの状態管理を確認する

---

## 修復手順

### 手順1: 最小限のテストコンポーネントを作成

```typescript
// TestCorrectionForm.tsx
'use client';

import { useState } from 'react';

export function TestCorrectionForm() {
  const [isAddingNew, setIsAddingNew] = useState(false);

  return (
    <div className="p-4">
      <button onClick={() => setIsAddingNew(!isAddingNew)}>
        {isAddingNew ? 'Hide' : 'Show'} Form
      </button>

      {isAddingNew && (
        <div className="mt-4 p-4 border-2 border-blue-200 bg-blue-50">
          <p>Form is visible!</p>
          <p>State: {String(isAddingNew)}</p>
        </div>
      )}
    </div>
  );
}
```

**結果**:
- これが動く場合: 元のコンポーネントに特定の問題がある
- これも動かない場合: React/ブラウザの環境に問題がある

---

### 手順2: 既存のコンポーネントを段階的に簡略化

```typescript
// CorrectionRevisionsManager.tsx
// 1. まず全てのロジックを削除して、ボタンとフォームだけにする

export function CorrectionRevisionsManager({ orderId }: { orderId: string }) {
  const [isAddingNew, setIsAddingNew] = useState(false);

  console.log('[CorrectionRevisionsManager] Render, isAddingNew:', isAddingNew);

  return (
    <div className="space-y-6">
      <button onClick={() => setIsAddingNew(!isAddingNew)}>
        {isAddingNew ? 'キャンセル' : '新規教正追加'}
      </button>

      {isAddingNew && (
        <div className="p-6 border-2 border-blue-200">
          <p>Form is visible! Order ID: {orderId}</p>
        </div>
      )}
    </div>
  );
}
```

**結果**:
- これが動く場合: 他のロジック（useEffect, API呼び出しなど）が問題
- これも動かない場合: React レンダリングの根本的な問題

---

### 手順3: ルート cause の特定

1. **最小限のテストコンポーネントは動くか？**
   - YES → 手順4へ
   - NO → React/Next.js の環境設定を確認

2. **簡略化したコンポーネントは動くか？**
   - YES → 元のコンポーネントの他のロジックに問題
   - NO → props/依存関係に問題

3. **元のコンポーネントのどの部分が問題か？**
   - useEffect → 副作用の問題
   - API呼び出し → 非同期処理の問題
   - 親コンポーネント → props の問題

---

## 最終チェックリスト

- [ ] React Developer Tools で `isAddingNew` が変化する
- [ ] コンソールにエラーが出ていない
- [ ] フォームが DOM に存在する
- [ ] フォームに `display: none` などが適用されていない
- [ ] 親コンポーネントが状態を上書きしていない
- [ ] 他の CSS が干渉していない
- [ ] 最小限のテストコンポーネントは動作する

---

## 緊急回避策

もし上記のすべてが失敗した場合:

### 回避策1: URL パラメータで制御

```typescript
// URL パラメータを使用してフォームの表示を制御
const searchParams = useSearchParams();
const isAddingNew = searchParams.get('showForm') === 'true';

// フォームを表示するリンク
<Link href="/admin/orders/123?showForm=true">
  新規教正追加
</Link>

// フォームを閉じるリンク
<Link href="/admin/orders/123">
  キャンセル
</Link>
```

### 回避策2: 別ページに移動

```typescript
// 教正追加専用のページを作成
<Link href={`/admin/orders/${orderId}/correction/new`}>
  新規教正追加
</Link>
```

---

## 次のステップ

1. まず React DevTools で状態を確認
2. コンソールにデバッグログを追加
3. 最小限のテストコンポーネントを作成
4. 問題が特定できたら、適切な修正を適用
5. E2E テストを追加して regression を防止

---

## 参考資料

- React Developer Tools: https://react.dev/learn/react-developer-tools
- React useState フック: https://react.dev/reference/react/useState
- React useCallback フック: https://react.dev/reference/react/useCallback
