# 統合ホームページ構造設計書

## 1. 概要 (Overview)

### 1.1 目的 (Purpose)

本設計書は、Portalページ（`/portal/*`）をAdminページ（`/admin/*`）に統合し、ホームページ構造を3つのエリアに再編成するための完全な技術仕様を提供する。

**統合の背景**:
- PortalページとMemberページの機能重複（70-90%の類似性）
- 重複APIエンドポイントによるメンテナンス性の低下
- 顧客向けインターフェースの複雑化
- SEO構造の最適化必要性

### 1.2 現状の問題点 (Current Problems)

| 問題カテゴリ | 具体的問題 | 影響度 |
|------------|----------|--------|
| **機能重複** | Portal/Memberで同一機能が別々に実装 | 開発コスト2倍 |
| **API重複** | `/api/customer/*`と`/api/member/*`で同等機能 | メンテナンス性低下 |
| **コンポーネント重複** | 5つ以上の主要コンポーネントが重複 | コード肥大化 |
| **認証複雑性** | Portal専用の認証ロジックが別途存在 | セキュリティリスク |
| **SEO分散** | 同一コンテンツが複数URLで存在 | 検索順位低下 |

### 1.3 スコープ (Scope)

**含む範囲**:
- Portalページ全体（6ページ）の`/admin/customers/*`への移行
- 重複APIエンドポイント（6個）の削除
- コンポーネント統合（5コンポーネント）
- ミドルウェア認証ロジックの更新
- 301リダイレクト実装
- E2Eテストの移行

**含まない範囲**:
- データベーススキーマ変更（既存スキーマのまま使用）
- 新機能開発
- UI/UXデザイン変更
- APIレスポンス形式の変更

---

## 2. 現状分析 (Current Analysis)

### 2.1 既存構造 (Existing Structure)

#### 現在のルーティング構造

```
├── / (Public Pages - 37ページ)
│   ├── /catalog
│   ├── /contact
│   ├── /quote-simulator
│   └── ...
├── /auth (Authentication - 6ページ)
│   ├── /signin
│   ├── /register
│   └── /pending
├── /member (Member Pages - 26ページ)
│   ├── /dashboard
│   ├── /orders
│   ├── /quotations
│   └── ...
├── /portal (Portal Pages - 6ページ) ← 統合対象
│   ├── / (Dashboard)
│   ├── /orders
│   ├── /documents
│   └── /profile
└── /admin (Admin Pages - 18ページ) ← 統合先
    ├── /dashboard
    ├── /orders
    ├── /quotations
    └── ...
```

#### 現在のAPI構造

```
/api/
├── /customer/ (Portal専用 - 5エンドポイント) ← 削除対象
│   ├── /dashboard
│   ├── /orders
│   ├── /orders/[id]
│   ├── /profile
│   └── /documents
├── /member/ (Member専用 - 20+エンドポイント)
│   ├── /dashboard
│   ├── /orders
│   ├── /quotations
│   └── ...
├── /admin/ (Admin専用 - 30+エンドポイント)
│   ├── /dashboard
│   ├── /orders
│   ├── /quotations
│   └── ...
└── /[shared] (共通API)
    ├── /auth/*
    ├── /products/*
    └── /quotations/*
```

### 2.2 ページ別API·DB完全マッピング (Complete Page-by-Page Mapping)

#### 2.2.1 PORTALページ詳細分析

| # | ページ名 | ファイルパス | APIエンドポイント | データベーステーブル | コンポーネント | 重複度 |
|---|---------|-------------|------------------|---------------------|--------------|--------|
| 1 | **Dashboard** | `src/app/portal/page.tsx` | `GET /api/customer/dashboard` | `orders`, `profiles`, `users` | `OrderSummaryCard`<br>`PortalLayout` | 60% |
| 2 | **Orders List** | `src/app/portal/orders/page.tsx` | `GET /api/customer/orders?status=&search=` | `orders`, `order_items` | `OrderSummaryCard`<br>`PortalLayout` | 80% |
| 3 | **Order Detail** | `src/app/portal/orders/[id]/page.tsx` | `GET /api/customer/orders/[id]` | `orders`, `order_items`<br>`production_jobs`, `shipments`<br>`order_documents`, `order_notes` | `ProductionProgressWidget`<br>`DocumentDownloadCard`<br>`ShipmentTrackingCard` | 85% |
| 4 | **Documents** | `src/app/portal/documents/page.tsx` | `GET /api/customer/documents?type=` | `order_documents`, `documents`<br>`orders` | カスタムカードUI | 90% |
| 5 | **Profile** | `src/app/portal/profile/page.tsx` | `GET /api/customer/profile`<br>`PATCH /api/customer/profile` | `profiles`, `users`<br>`companies` | `PortalLayout`<br>`ProfileCancelButton` | 75% |
| 6 | **Support** | `src/app/portal/support/page.tsx` | なし (静的ページ) | なし | `PortalLayout` | 100% |

**Portalページの主要な問題点**:
1. Memberページと70-90%の機能重複
2. 専用API`/api/customer/*`がMember APIと完全重複
3. 主要コンポーネントがAdmin/Memberと共有されていない
4. 認証ロジックがPortal専用で別途実装されている

#### 2.2.2 ADMINページ詳細分析

| # | ページ名 | ファイルパス | APIエンドポイント | データベーステーブル | 主要コンポーネント |
|---|---------|-------------|------------------|---------------------|------------------|
| 1 | **Dashboard** | `src/app/admin/dashboard/page.tsx` | `GET /api/admin/dashboard/statistics`<br>`GET /api/admin/performance/metrics`<br>`GET /api/admin/orders/statistics` | `orders`, `quotations`, `users` | `Card`, `Container`<br>`DashboardSidebarNavigation` |
| 2 | **Orders** | `src/app/admin/orders/page.tsx` | `GET /api/admin/orders`<br>`PUT /api/admin/orders/[id]`<br>`GET /api/admin/delivery/tracking/[orderId]` | `orders`, `order_items`, `users`<br>`order_status_history` | `OrderTable`, `OrderFilter`<br>`OrderStatusBadge` |
| 3 | **Order Detail** | `src/app/admin/orders/[id]/page.tsx` | なし (Supabase直接) | `orders`, `order_items`<br>`order_status_history` | `PageLoadingState`, `Button` |
| 4 | **Quotations** | `src/app/admin/quotations/page.tsx` | `GET /api/admin/quotations`<br>`GET /api/admin/quotations/[id]`<br>`PUT /api/admin/quotations/[id]`<br>`DELETE /api/admin/quotations/[id]` | `quotations`, `quotation_items`<br>`users`, `products` | `EnhancedProductCard`<br>`DownloadButton`<br>`EnhancedPostProcessingSelector` |
| 5 | **Contracts** | `src/app/admin/contracts/page.tsx` | `GET /api/admin/contracts`<br>`GET /api/admin/contracts/[id]`<br>`POST /api/contracts/workflow/action` | `contracts`, `contract_signatures`<br>`users`, `contract_templates` | `ElectronicSignature`<br>`DocumentDownload`<br>`WorkflowTimeline` |
| 6 | **Production** | `src/app/admin/production/page.tsx` | `GET /api/admin/production/jobs`<br>`PUT /api/admin/production-jobs/[id]`<br>`PUT /api/admin/production/update-status` | `production_jobs`, `orders`<br>`users`, `production_stages` | `ProductionTimeline`<br>`ProductionStatusManager`<br>`OrderTimeline` |
| 7 | **Inventory** | `src/app/admin/inventory/page.tsx` | `GET /api/admin/inventory`<br>`PUT /api/admin/inventory/[id]`<br>`GET /api/admin/inventory/low-stock` | `inventory_items`, `products`<br>`inventory_movements` | `InventoryTable`<br>`StockAlertBanner`<br>`InventoryFilters` |
| 8 | **Approvals** | `src/app/admin/approvals/page.tsx` | `GET /api/admin/approvals`<br>`PUT /api/admin/approvals/[id]`<br>`POST /api/admin/approvals/[id]` | `approvals`, `users`<br>`approval_history` | `ApprovalCard`<br>`ApprovalDecisionButtons`<br>`ApprovalHistoryTimeline` |
| 9 | **Leads** | `src/app/admin/leads/page.tsx` | **未実装**<br>`GET /api/admin/leads` (必要) | `leads` (データなし) | `Card`, `Button`, `Badge`<br>`LeadScoreDisplay` |
| 10 | **Settings** | `src/app/admin/settings/page.tsx` | `GET /api/admin/settings`<br>`PUT /api/admin/settings/[category]/[key]` | `system_settings`<br>`pricing_configurations`<br>`material_costs` | タブナビゲーション<br>`SettingInput` |
| 11 | **Coupons** | `src/app/admin/coupons/page.tsx` | `GET /api/admin/coupons`<br>`POST /api/admin/coupons`<br>`GET /api/admin/coupons/[id]`<br>`PUT /api/admin/coupons/[id]`<br>`DELETE /api/admin/coupons/[id]` | `coupons`, `coupon_usage`<br>`coupon_usages` | `CouponForm`, `StatusBadge` |
| 12 | **Customer Settings** | `src/app/admin/settings/customers/page.tsx` | `GET /api/admin/settings/customer-markup`<br>`PUT /api/admin/settings/customer-markup/[id]` | `users`, `profiles`<br>`markup_rates` | `CustomerMarkupRow`<br>`PercentIcon` |
| 13 | **Shipments** | `src/app/admin/shipments/page.tsx` | ( shipments関連APIs ) | `shipments`, `orders`<br>`carriers` | 配送関連コンポーネント |
| 14 | **Contract Detail** | `src/app/admin/contracts/[id]/page.tsx` | ( contract APIs ) | `contracts`, `contract_signatures` | 契約詳細コンポーネント |
| 15 | **Production Detail** | `src/app/admin/production/[id]/page.tsx` | ( production APIs ) | `production_jobs` | 生産詳細コンポーネント |
| 16 | **Shipment Detail** | `src/app/admin/shipments/[id]/page.tsx` | ( shipment APIs ) | `shipments`, `carriers` | 配送詳細コンポーネント |
| 17 | **Quotation Detail** | `src/app/admin/quotations/[id]/page.tsx` | ( quotation APIs ) | `quotations`, `quotation_items` | 見積詳細コンポーネント |
| 18 | **Order Detail** | `src/app/admin/orders/[id]/page.tsx` | ( order APIs ) | `orders`, `order_items` | 注文詳細コンポーネント |

#### 2.2.3 MEMBERページ詳細分析

| # | ページ名 | ファイルパス | APIエンドポイント | データベーステーブル | 主要コンポーネント |
|---|---------|-------------|------------------|---------------------|------------------|
| 1 | **Dashboard** | `src/app/member/dashboard/page.tsx` | `GET /api/member/dashboard` | `orders`, `quotations`<br>`samples`, `invoices`<br>`approvals` | `DashboardCards`<br>`SidebarNavigation` |
| 2 | **Orders List** | `src/app/member/orders/page.tsx` | `GET /api/member/orders` | `orders`, `order_items`<br>`addresses` | `Card`, フィルタリングUI |
| 3 | **Order Detail** | `src/app/member/orders/[id]/page.tsx` | `GET /api/orders/[id]`<br>`GET /api/orders/[id]/status-history` | `orders`, `order_items`<br>`addresses`, `users`<br>`order_status_history` | `OrderActions`<br>`OrderFileUploadSection`<br>`OrderCommentsSection` |
| 4 | **New Orders** | `src/app/member/orders/new/page.tsx` | `getOrders` (lib) | `orders` (PRODUCTION status) | サーバーコンポーネント |
| 5 | **Reorder** | `src/app/member/orders/reorder/page.tsx` | `getOrders` (lib) | `orders` (DELIVERED/SHIPPED) | サーバーコンポーネント |
| 6 | **History** | `src/app/member/orders/history/page.tsx` | `getOrders` (lib) | 全てのorders | サーバーコンポーネント |
| 7 | **Confirmation** | `src/app/member/orders/[id]/confirmation/page.tsx` | サーバーサイドフェッチ | `orders` | `OrderConfirmSuccessClient` |
| 8 | **Data Receipt** | `src/app/member/orders/[id]/data-receipt/page.tsx` | `POST /api/member/orders/[id]/data-receipt` | `orders` | `DataReceiptUploadClient` |
| 9 | **Quotations List** | `src/app/member/quotations/page.tsx` | `GET /api/member/quotations` | `quotations`, `quotation_items`<br>`products` | フィルタリングUI, `Card` |
| 10 | **Quotation Detail** | `src/app/member/quotations/[id]/page.tsx` | `GET /api/quotations/[id]`<br>`POST /api/quotations/[id]/download-history` | `quotations`, `quotation_items`<br>`products`, `download_history` | PDFコンポーネント |
| 11 | **Quotation Request** | `src/app/member/quotations/request/page.tsx` | Supabase直接 | `companies` | `B2BQuotationRequestForm` |
| 12 | **Quotation Confirm** | `src/app/member/quotations/[id]/confirm/page.tsx` | サーバーサイド検証 | `quotations` | 確認コンポーネント |
| 13 | **Samples** | `src/app/member/samples/page.tsx` | `GET /api/samples`<br>`POST /api/samples` | `sample_requests`<br>`sample_items`, `products` | `SampleRequestForm`<br>フィルタリングUI |
| 14 | **Profile Display** | `src/app/member/profile/page.tsx` | `GET /api/profile` (lib) | `users`, `profiles`<br>`companies` | プロフィール表示 |
| 15 | **Profile Edit** | `src/app/member/edit/page.tsx` | `POST /api/profile`<br>`POST /api/auth/change-password`<br>`DELETE /api/member/delete-account` | `profiles`, `users` | `ProfileEditForm`<br>`ChangePasswordForm` |
| 16 | **Settings** | `src/app/member/settings/page.tsx` | `GET /api/member/settings`<br>`POST /api/member/settings`<br>`DELETE /api/member/delete-account` | `profiles`, `users` | 通知フォーム<br>セキュリティ設定 |
| 17 | **Contracts** | `src/app/member/contracts/page.tsx` | `GET /api/contracts` | `contracts`, `contract_signatures` | 契約リスト<br>署名ステータス |
| 18 | **Deliveries** | `src/app/member/deliveries/page.tsx` | `GET /api/member/addresses/delivery`<br>`POST /api/member/addresses/delivery`<br>`PUT /api/member/addresses/delivery/[id]`<br>`DELETE /api/member/addresses/delivery/[id]` | `delivery_addresses` | `DeliveryAddressForm` |
| 19 | **Inquiries** | `src/app/member/inquiries/page.tsx` | `GET /api/member/inquiries` | `inquiries`<br>`inquiry_responses` | フィルタリングUI<br>`StatusBadge`, `TypeBadge` |
| 20 | **Invoices** | `src/app/member/invoices/page.tsx` | `GET /api/member/invoices` | `invoices`, `invoice_items` | フィルタリングUI<br>`StatusBadge`, `PaymentProgress` |
| 21 | **Notifications** | `src/app/member/notifications/page.tsx` | `GET /api/member/notifications`<br>`PATCH /api/member/notifications/[id]/read`<br>`PATCH /api/member/notifications/mark-all-read`<br>`DELETE /api/member/notifications/[id]`<br>`DELETE /api/member/notifications/delete-all` | `notifications` | フィルタリングUI<br>通知アイテム |
| 22 | **Order Actions** | `src/app/member/orders/[id]/OrderActions.tsx` | (複数のAPI) | `orders`, `order_items` | 注文アクションボタン群 |
| 23 | **File Upload** | `src/app/member/orders/[id]/OrderFileUploadSection.tsx` | `POST /api/upload`<br>`POST /api/member/orders/[id]/documents` | `order_documents` | ファイルアップロードUI |
| 24 | **Comments** | `src/app/member/orders/[id]/OrderCommentsSection.tsx` | `GET /api/notes`<br>`POST /api/notes` | `order_notes` | コメントUI |
| 25 | **AI Extraction** | `src/app/member/ai-extraction/*` | `POST /api/member/ai-extraction/*` | `ai_extractions` | AI抽出UI |
| 26 | **Approvals** | `src/app/member/approvals/*` | `GET /api/member/approvals` | `approvals` | 承認UI |

### 2.3 重複·不要機能分析 (Duplicate/Unnecessary Features Analysis)

#### 2.3.1 ページ重複分析

**Portal vs Member 重複マトリックス**

| 機能カテゴリ | Portalパス | Memberパス | 重複度 | 統合推奨 |
|------------|-----------|-----------|--------|---------|
| **注文一覧** | `/portal/orders` | `/member/orders` | 80% | Memberへ統合 |
| **注文詳細** | `/portal/orders/[id]` | `/member/orders/[id]` | 85% | Memberへ統合 |
| **プロフィール管理** | `/portal/profile` | `/member/profile` | 75% | Memberへ統合 |
| **ドキュメントダウンロード** | `/portal/documents` | `/member/contracts` | 90% | Memberへ統合 |
| **ダッシュボード** | `/portal/` | `/member/dashboard` | 60% | Memberへ統合 |

**Portal vs Admin 共通機能**

| 機能 | Portalの実装 | Adminの実装 | 共通化可能性 |
|------|-------------|-------------|-------------|
| 注文管理 | 基本参照のみ | 全CRUD機能 | 共通コンポーネント |
| 注文追跡 | 生産進捗率表示 | 全生産管理 | `ProductionProgressWidget` |
| ドキュメント管理 | ダウンロードのみ | 全管理機能 | `DocumentDownload` |
| 配送追跡 | `ShipmentTrackingCard` | 同一コンポーネント | **既に共有済み** |

**Member vs Admin UI重複**

| UI要素 | Member実装 | Admin実装 | 類似性 |
|--------|-----------|-----------|--------|
| 注文一覧テーブル | Cardベース | Tableベース | 85% |
| 見積一覧UI | Card+フィルタ | 同じパターン | 80% |
| ファイルダウンロード | 共通コンポーネント | 共通コンポーネント | **100%** |
| プロフィール表示 | 基本情報 | 管理者用詳細版 | 90% |

#### 2.3.2 API重複分析

**完全重複API（削除対象）**

| APIエンドポイント | 現在の使用箇所 | 重複先 | 削除可否 |
|-----------------|--------------|--------|---------|
| `GET /api/customer/dashboard` | Portalのみ | `GET /api/member/dashboard` | ✅ 削除可能 |
| `GET /api/customer/orders` | Portalのみ | `GET /api/member/orders` | ✅ 削除可能 |
| `GET /api/customer/orders/[id]` | Portalのみ | `GET /api/member/orders/[id]` | ✅ 削除可能 |
| `GET /api/customer/profile` | Portalのみ | `GET /api/member/profile` | ✅ 削除可能 |
| `PATCH /api/customer/profile` | Portalのみ | `PATCH /api/member/profile` | ✅ 削除可能 |
| `GET /api/customer/documents` | Portalのみ | `GET /api/member/contracts` | ✅ 削除可能 |

**API統合可能性（権限ベースフィルタリング）**

| 現在の分離API | 使用箇所 | 統合後の構想 |
|-------------|--------|-------------|
| `/api/admin/orders` | Adminのみ | `/api/orders?role=admin` |
| `/api/member/orders` | Memberのみ | `/api/orders?role=member` |
| `/api/admin/quotations` | Adminのみ | `/api/quotations?role=admin` |
| `/api/member/quotations` | Memberのみ | `/api/quotations?role=member` |
| `/api/admin/dashboard` | Adminのみ | `/api/dashboard?role=admin` |
| `/api/member/dashboard` | Memberのみ | `/api/dashboard?role=member` |

**注意**: 統合は実装コストと見合わないため、今回は`/api/customer/*`の削除のみ実施。

#### 2.3.3 コンポーネント重複分析

**既に共有されているコンポーネント**

| コンポーネント | 場所 | 使用箇所 |
|--------------|------|---------|
| `Button` | `components/ui/button.tsx` | 全ページ |
| `Card` | `components/ui/card.tsx` | 全ページ |
| `Badge` | `components/ui/badge.tsx` | 全ページ |
| `Input` | `components/ui/input.tsx` | 全ページ |
| `DocumentDownload` | `components/b2b/DocumentDownload.tsx` | Admin/Member/Portal |

**統合が必要なコンポーネント**

| コンポーネント名 | Portalの場所 | Memberの場所 | Adminの場所 | 統合先 |
|---------------|-------------|-------------|-----------|--------|
| `OrderTable` | - | `src/components/member/*` | `src/components/admin/*` | `components/shared/order/` |
| `OrderStatusBadge` | - | `src/components/member/*` | `src/components/admin/*` | `components/shared/status/` |
| `DocumentDownloadCard` | `src/components/portal/` | - | `src/components/admin/*` | `components/shared/document/` |
| `ProductionProgressWidget` | `src/components/portal/` | - | `src/components/admin/*` | `components/shared/production/` |
| `ShipmentTrackingCard` | `src/components/portal/` | - | `src/components/admin/*` | `components/shared/shipping/` |
| `OrderSummaryCard` | `src/components/portal/` | - | - | `components/shared/order/` |
| `PortalLayout` | `src/components/portal/` | - | - | `components/admin/CustomerPortalLayout` |

#### 2.3.4 未実装機能分析

**Adminページ（未実装）**

| ページ | 現状 | 必要な作業 |
|-------|------|----------|
| **Leads** | Mockデータのみ | `/api/admin/leads`エンドポイント実装 |
| **Settings** | 部分実装 | 全設定管理完了 |
| **Notifications** | 未実装 | 通知システム実装 |

**Portalページ（制限あり）**

| ページ | 制限事項 | 推奨事項 |
|-------|---------|---------|
| **Support** | 静的コンテンツのみ | Memberのinquiriesへ統合 |
| **Profile** | 基本編集のみ | Memberの全プロフィールへ統合 |

---

## 3. 新構造設計 (New Structure Design)

### 3.1 エリア定義 (Area Definition)

統合後のホームページは3つの明確なエリアに区分される：

#### 3.1.1 一般 ホームページ（Public Pages）

**目的**: 匿名ユーザー向けの情報提供とリード獲得

**ルート構造**:
```
/ (Public)
├── / (Home)
├── /catalog
├── /catalog/[slug]
├── /contact
├── /quote-simulator
├── /roi-calculator
├── /smart-quote
├── /samples
├── /news
├── /premium-content
├── /archives
├── /guide/
│   ├── /size
│   └── ...
└── /inquiry/
    └── /detailed
```

**認証**: 不要（一部ページを除く）

**主機能**:
- 製品カタログ閲覧
- 見積シミュレーション
- サンプル請求
- お問い合わせ
- ニュース・お知らせ

#### 3.1.2 会員 ページ（Member Pages）

**目的**: 会員専用のセルフサービスポータル

**ルート構造**:
```
/member (Member Only)
├── /dashboard
├── /orders
│   ├── /[id]
│   │   ├── /confirmation
│   │   └── /data-receipt
│   ├── /new
│   ├── /reorder
│   └── /history
├── /quotations
│   ├── /[id]
│   │   ├── /confirm
│   │   └── /export
│   └── /request
├── /samples
├── /profile
├── /edit
├── /settings
├── /contracts
├── /deliveries
├── /inquiries
├── /invoices
└── /notifications
```

**認証**: 必須（MEMBERロール & ACTIVEステータス）

**主機能**:
- 注文管理・追跡
- 見積依頼・管理
- サンプル請求
- プロフィール管理
- 配送先管理
- 通知管理

#### 3.1.3 管理者 ページ（Admin Pages - 統合Portal）

**目的**: 管理者用ダッシュボードと顧客向け管理インターフェース

**ルート構造**:
```
/admin (Admin + Customer Portal)
├── /dashboard (Admin Only)
├── /orders (Admin Only)
├── /quotations (Admin Only)
├── /contracts (Admin Only)
├── /production (Admin Only)
├── /inventory (Admin Only)
├── /approvals (Admin Only)
├── /leads (Admin Only)
├── /settings (Admin Only)
├── /coupons (Admin Only)
├── /customers (Admin + Active Member)
│   ├── / (Dashboard - from /portal)
│   ├── /orders (from /portal/orders)
│   │   └── /[id] (from /portal/orders/[id])
│   ├── /documents (from /portal/documents)
│   ├── /profile (from /portal/profile)
│   └── /support (from /portal/support)
├── /shipments (Admin Only)
├── /settings/customers (Admin Only)
└── /[other-detail-pages]
```

**認証**:
- `/admin/customers/*`: ADMIN または (MEMBER & ACTIVE)
- その他: ADMINのみ

**主機能**:
- **管理者**: 全データの管理・承認・分析
- **会員**: `/admin/customers/*`経由でPortalと同等の機能にアクセス

### 3.2 URL構造（URL Structure）

#### 3.2.1 統合後の完全URLマッピング

| 旧URL（Portal） | 新URL（Admin/customers） | ステータス |
|---------------|----------------------|---------|
| `/portal` | `/admin/customers` | 301リダイレクト |
| `/portal/orders` | `/admin/customers/orders` | 301リダイレクト |
| `/portal/orders/[id]` | `/admin/customers/orders/[id]` | 301リダイレクト |
| `/portal/documents` | `/admin/customers/documents` | 301リダイレクト |
| `/portal/profile` | `/admin/customers/profile` | 301リダイレクト |
| `/portal/support` | `/admin/customers/support` | 301リダイレクト |

#### 3.2.2 URL階層設計原則

1. **セマンティック階層**: 機能的に関連するページを同じ階層にグループ化
2. **RESTful規約**: リソースベースのURL設計
3. **SEO最適化**: キーワードを含む明確なURL構造
4. **将来的拡張性**: 新機能追加時の階層変更を最小限に

### 3.3 ナビゲーション設計（Navigation Design）

#### 3.3.1 Admin内部ナビゲーション

```typescript
// Admin専用ナビゲーション
const adminNavItems = [
  { href: '/admin/dashboard', label: 'ダッシュボード', icon: 'LayoutDashboard' },
  { href: '/admin/orders', label: '注文管理', icon: 'ShoppingCart' },
  { href: '/admin/quotations', label: '見積管理', icon: 'FileText' },
  { href: '/admin/contracts', label: '契約管理', icon: 'FileCheck' },
  { href: '/admin/production', label: '生産管理', icon: 'Wrench' },
  { href: '/admin/inventory', label: '在庫管理', icon: 'Package' },
  { href: '/admin/approvals', label: '承認待ち', icon: 'UserCheck' },
  { href: '/admin/customers', label: '顧客ポータル', icon: 'Users' }, // ← 新規追加
  { href: '/admin/settings', label: '設定', icon: 'Settings' },
];
```

#### 3.3.2 顧客ポータルナビゲーション

```typescript
// 顧客ポータル専用ナビゲーション
const customerPortalNavItems = [
  { href: '/admin/customers', label: 'ダッシュボード', icon: 'Home' },
  { href: '/admin/customers/orders', label: '注文一覧', icon: 'ShoppingCart' },
  { href: '/admin/customers/documents', label: 'ドキュメント', icon: 'FileText' },
  { href: '/admin/customers/profile', label: 'プロフィール', icon: 'User' },
  { href: '/admin/customers/support', label: 'サポート', icon: 'HelpCircle' },
];
```

#### 3.3.3 パンくずリスト設計

```
/admin/customers/orders/12345
→ ホーム > 管理者 > 顧客ポータル > 注文一覧 > 注文詳細 #12345

/admin/orders/12345
→ ホーム > 管理者 > 注文管理 > 注文詳細 #12345
```

### 3.4 レイアウト設計（Layout Design）

#### 3.4.1 Adminレイアウト統合

**ファイル**: `src/app/admin/layout.tsx`

```typescript
'use client';

import { usePathname } from 'next/navigation';
import { requireAuth } from '@/lib/auth-helpers';
import InternalAdminLayout from '@/components/admin/InternalAdminLayout';
import CustomerPortalLayout from '@/components/admin/CustomerPortalLayout';

export default async function AdminLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  // 認証チェック
  const user = await requireAuth();
  const profile = await getUserProfile(user.id);
  const pathname = usePathname();

  // 顧客ポータルルートかどうかを判定
  const isCustomerPortal = pathname.startsWith('/admin/customers');

  // 権限チェック
  if (isCustomerPortal) {
    // ADMIN または (MEMBER & ACTIVE) のみアクセス可能
    const hasAccess =
      profile.role === 'ADMIN' ||
      (profile.role === 'MEMBER' && profile.status === 'ACTIVE');

    if (!hasAccess) {
      redirect('/auth/signin');
    }
  } else {
    // 管理者専用ルート
    if (profile.role !== 'ADMIN') {
      redirect('/auth/error?error=AccessDenied');
    }
  }

  return (
    <ErrorBoundaryWrapper enableRetry={true}>
      {isCustomerPortal ? (
        <CustomerPortalLayout profile={profile}>
          {children}
        </CustomerPortalLayout>
      ) : (
        <InternalAdminLayout profile={profile}>
          {children}
        </InternalAdminLayout>
      )}
    </ErrorBoundaryWrapper>
  );
}
```

#### 3.4.2 CustomerPortalLayoutコンポーネント

**新規作成**: `src/components/admin/CustomerPortalLayout.tsx`

```typescript
'use client';

import { ReactNode } from 'react';
import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Home, ShoppingCart, FileText, User, HelpCircle, LogOut } from 'lucide-react';

interface CustomerPortalLayoutProps {
  children: ReactNode;
  profile: any;
}

const customerPortalNavItems = [
  { href: '/admin/customers', label: 'ダッシュボード', icon: Home },
  { href: '/admin/customers/orders', label: '注文一覧', icon: ShoppingCart },
  { href: '/admin/customers/documents', label: 'ドキュメント', icon: FileText },
  { href: '/admin/customers/profile', label: 'プロフィール', icon: User },
  { href: '/admin/customers/support', label: 'サポート', icon: HelpCircle },
];

export default function CustomerPortalLayout({
  children,
  profile,
}: CustomerPortalLayoutProps) {
  const pathname = usePathname();

  const handleSignOut = async () => {
    await fetch('/api/auth/signout', { method: 'POST' });
    window.location.href = '/auth/signin';
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* ヘッダー */}
      <header className="bg-white border-b border-gray-200">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center h-16">
            <div className="flex items-center">
              <h1 className="text-xl font-bold text-gray-900">
                顧客ポータル
              </h1>
            </div>
            <div className="flex items-center space-x-4">
              <span className="text-sm text-gray-700">
                {profile?.company_name || profile?.email}
              </span>
              <Button
                variant="ghost"
                size="sm"
                onClick={handleSignOut}
              >
                <LogOut className="h-4 w-4 mr-2" />
                ログアウト
              </Button>
            </div>
          </div>
        </div>
      </header>

      {/* ナビゲーション + コンテンツ */}
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div className="flex space-x-8">
          {/* サイドナビゲーション */}
          <nav className="w-64 flex-shrink-0">
            <ul className="space-y-2">
              {customerPortalNavItems.map((item) => {
                const isActive = pathname === item.href;
                const Icon = item.icon;

                return (
                  <li key={item.href}>
                    <Link
                      href={item.href}
                      className={`
                        flex items-center space-x-3 px-4 py-2 rounded-lg
                        ${isActive
                          ? 'bg-blue-100 text-blue-700'
                          : 'text-gray-700 hover:bg-gray-100'
                        }
                      `}
                    >
                      <Icon className="h-5 w-5" />
                      <span>{item.label}</span>
                    </Link>
                  </li>
                );
              })}
            </ul>
          </nav>

          {/* メインコンテンツ */}
          <main className="flex-1">{children}</main>
        </div>
      </div>
    </div>
  );
}
```

---

## 4. 技術実装（Technical Implementation）

### 4.1 ルーティング（Routing）

#### 4.1.1 新しいルート構造

**作成するディレクトリ構造**:

```
src/app/admin/customers/
├── page.tsx              # ダッシュボード（from /portal）
├── orders/
│   ├── page.tsx         # 注文一覧（from /portal/orders）
│   └── [id]/
│       └── page.tsx     # 注文詳細（from /portal/orders/[id]）
├── documents/
│   └── page.tsx         # ドキュメント（from /portal/documents）
├── profile/
│   └── page.tsx         # プロフィール（from /portal/profile）
└── support/
    └── page.tsx         # サポート（from /portal/support）
```

#### 4.1.2 ルート実装例

**ファイル**: `src/app/admin/customers/page.tsx`

```typescript
// 元: src/app/portal/page.tsx
// 変更点: API呼び出しを /api/customer/dashboard → /api/member/dashboard に変更

import { DashboardStats } from '@/components/dashboard/DashboardStats';
import { RecentOrders } from '@/components/dashboard/RecentOrders';

export default async function CustomerPortalDashboard() {
  // API呼び出しを変更
  const stats = await fetch(`${process.env.NEXT_PUBLIC_APP_URL}/api/member/dashboard`, {
    cache: 'no-store',
  }).then(res => res.json());

  return (
    <div>
      <h1 className="text-3xl font-bold text-gray-900 mb-8">
        ダッシュボード
      </h1>
      <DashboardStats stats={stats} />
      <RecentOrders orders={stats.recentOrders} />
    </div>
  );
}
```

**ファイル**: `src/app/admin/customers/orders/page.tsx`

```typescript
// 元: src/app/portal/orders/page.tsx
// 変更点: API呼び出しを /api/customer/orders → /api/member/orders に変更

import { OrdersList } from '@/components/orders/OrdersList';

export default async function CustomerOrdersPage({
  searchParams,
}: {
  searchParams: { status?: string; search?: string };
}) {
  const { status = '', search = '' } = searchParams;

  // API呼び出しを変更
  const orders = await fetch(
    `${process.env.NEXT_PUBLIC_APP_URL}/api/member/orders?status=${status}&search=${search}`,
    { cache: 'no-store' }
  ).then(res => res.json());

  return (
    <div>
      <h1 className="text-3xl font-bold text-gray-900 mb-8">
        注文一覧
      </h1>
      <OrdersList orders={orders} />
    </div>
  );
}
```

### 4.2 認証・認可（Authentication & Authorization）

#### 4.2.1 ミドルウェア更新

**ファイル**: `src/middleware.ts`

```typescript
import { createMiddlewareClient } from '@supabase/auth-helpers-nextjs';
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export async function middleware(req: NextRequest) {
  const res = NextResponse.next();
  const supabase = createMiddlewareClient({ req, res });
  const {
    data: { session },
  } = await supabase.auth.getSession();

  const pathname = req.nextUrl.pathname;

  // 新しいルート分類
  const isAdminInternalRoute = pathname.match(/^\/admin\/(?!customers)/);
  const isCustomerPortalRoute = pathname.startsWith('/admin/customers');
  const isMemberRoute = pathname.startsWith('/member');
  const isAuthRoute = pathname.startsWith('/auth');

  // 認証が必要なルート
  const protectedRoutes = [
    ...(isMemberRoute ? ['/member'] : []),
    ...(isAdminInternalRoute ? ['/admin'] : []),
    ...(isCustomerPortalRoute ? ['/admin/customers'] : []),
  ];

  const isProtectedRoute = protectedRoutes.some(route => pathname.startsWith(route));

  // セッションがない場合、認証ページへリダイレクト
  if (!session && isProtectedRoute && !isAuthRoute) {
    return NextResponse.redirect(new URL('/auth/signin', req.url));
  }

  // セッションがある場合、ユーザープロフィールを取得
  if (session && isProtectedRoute) {
    const { data: profile } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', session.user.id)
      .single();

    if (!profile) {
      return NextResponse.redirect(new URL('/auth/signin', req.url));
    }

    // 管理者専用ルートのチェック
    if (isAdminInternalRoute && profile.role !== 'ADMIN') {
      return NextResponse.redirect(new URL('/auth/error?error=AccessDenied', req.url));
    }

    // 顧客ポータルルートのチェック（ADMIN または ACTIVE MEMBER）
    if (isCustomerPortalRoute) {
      const hasAccess =
        profile.role === 'ADMIN' ||
        (profile.role === 'MEMBER' && profile.status === 'ACTIVE');

      if (!hasAccess) {
        return NextResponse.redirect(new URL('/auth/signin', req.url));
      }
    }

    // メンバールートのチェック
    if (isMemberRoute && profile.status !== 'ACTIVE') {
      return NextResponse.redirect(new URL('/auth/pending', req.url));
    }
  }

  // Portal → Admin/Customers への301リダイレクト
  if (pathname.startsWith('/portal')) {
    const newPath = pathname.replace('/portal', '/admin/customers');
    const url = new URL(newPath, req.url);
    url.search = req.nextUrl.search; // クエリパラメータを保持
    return NextResponse.redirect(url, { status: 301 }); // 永続リダイレクト
  }

  return res;
}

export const config = {
  matcher: [
    /*
     * Match all request paths except:
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     * - public folder
     */
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
};
```

#### 4.2.2 権限マトリックス

| ルート | ADMIN | MEMBER (ACTIVE) | MEMBER (PENDING) | その他 |
|-------|-------|----------------|----------------|--------|
| `/admin/*` (customers除く) | ✅ | ❌ | ❌ | ❌ |
| `/admin/customers/*` | ✅ | ✅ | ❌ | ❌ |
| `/member/*` | ✅ | ✅ | ❌ | ❌ |
| `/auth/*` | 全員 | 全員 | 全員 | 全員 |
| `/*` (Public) | 全員 | 全員 | 全員 | 全員 |

### 4.3 コンポーネント統合（Component Consolidation）

#### 4.3.1 共通コンポーネントディレクトリ構造

**作成するディレクトリ**:

```
src/components/shared/
├── order/
│   ├── OrderTable.tsx
│   ├── OrderFilters.tsx
│   ├── OrderStatusBadge.tsx
│   └── index.ts
├── document/
│   ├── DocumentDownload.tsx
│   ├── DocumentCard.tsx
│   └── index.ts
├── production/
│   ├── ProductionProgressWidget.tsx
│   ├── ProductionTimeline.tsx
│   └── index.ts
├── shipping/
│   ├── ShipmentTrackingCard.tsx
│   ├── DeliveryStatusBadge.tsx
│   └── index.ts
└── status/
    ├── StatusBadge.tsx
    ├── ApprovalStatusBadge.tsx
    └── index.ts
```

#### 4.3.2 コンポーネント統合例

**移動元**: `src/components/portal/ProductionProgressWidget.tsx`
**移動先**: `src/components/shared/production/ProductionProgressWidget.tsx`

**統合後の実装**:

```typescript
// src/components/shared/production/ProductionProgressWidget.tsx

'use client';

import { ProductionJob } from '@/types/production';
import { Card } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { Badge } from '@/components/ui/badge';

interface ProductionProgressWidgetProps {
  productionJobs: ProductionJob[];
}

export function ProductionProgressWidget({
  productionJobs,
}: ProductionProgressWidgetProps) {
  const getProgressPercentage = (stage: string) => {
    const stageMap: Record<string, number> = {
      PENDING: 0,
      PROCESSING: 25,
      COMPLETED: 75,
      SHIPPED: 100,
    };
    return stageMap[stage] || 0;
  };

  const getStageLabel = (stage: string) => {
    const labelMap: Record<string, string> = {
      PENDING: '待機中',
      PROCESSING: '生産中',
      COMPLETED: '完了',
      SHIPPED: '発送済み',
    };
    return labelMap[stage] || stage;
  };

  return (
    <Card className="p-6">
      <h3 className="text-lg font-semibold mb-4">生産進捗</h3>
      <div className="space-y-4">
        {productionJobs.map((job) => (
          <div key={job.id} className="border-b pb-4 last:border-0">
            <div className="flex justify-between items-center mb-2">
              <span className="font-medium">{job.product_name}</span>
              <Badge>{getStageLabel(job.stage)}</Badge>
            </div>
            <Progress value={getProgressPercentage(job.stage)} />
          </div>
        ))}
      </div>
    </Card>
  );
}
```

**index.ts エクスポート**:

```typescript
// src/components/shared/production/index.ts

export { ProductionProgressWidget } from './ProductionProgressWidget';
export { ProductionTimeline } from './ProductionTimeline';
```

#### 4.3.3 コンポーネント使用例（統合後）

**Adminページでの使用**:

```typescript
// src/app/admin/production/page.tsx

import { ProductionProgressWidget } from '@/components/shared/production';

export default function AdminProductionPage() {
  // ... データフェッチ

  return (
    <div>
      <h1>生産管理</h1>
      <ProductionProgressWidget productionJobs={productionJobs} />
    </div>
  );
}
```

**Memberページでの使用**:

```typescript
// src/app/member/orders/[id]/page.tsx

import { ProductionProgressWidget } from '@/components/shared/production';

export default function MemberOrderDetailPage({ params }) {
  // ... データフェッチ

  return (
    <div>
      <h1>注文詳細</h1>
      <ProductionProgressWidget productionJobs={order.production_jobs} />
    </div>
  );
}
```

**Customer Portal（旧Portal）での使用**:

```typescript
// src/app/admin/customers/orders/[id]/page.tsx

import { ProductionProgressWidget } from '@/components/shared/production';

export default function CustomerPortalOrderDetailPage({ params }) {
  // ... データフェッチ

  return (
    <div>
      <h1>注文詳細</h1>
      <ProductionProgressWidget productionJobs={order.production_jobs} />
    </div>
  );
}
```

### 4.4 API統合（API Consolidation）

#### 4.4.1 削除するAPIエンドポイント

```
DELETE /api/customer/dashboard
DELETE /api/customer/orders
DELETE /api/customer/orders/[id]
DELETE /api/customer/profile
DELETE /api/customer/documents
```

#### 4.4.2 API呼び出し変更マトリックス

| 旧API呼び出し | 新API呼び出し | 変更ファイル数 |
|-------------|-------------|-------------|
| `/api/customer/dashboard` | `/api/member/dashboard` | 1 |
| `/api/customer/orders` | `/api/member/orders` | 2 |
| `/api/customer/orders/[id]` | `/api/member/orders/[id]` | 1 |
| `/api/customer/profile` | `/api/member/profile` | 2 |
| `/api/customer/documents` | `/api/member/contracts` | 1 |

#### 4.4.3 API呼び出し更新例

**更新前**:

```typescript
const response = await fetch('/api/customer/dashboard');
const data = await response.json();
```

**更新後**:

```typescript
const response = await fetch('/api/member/dashboard');
const data = await response.json();
```

---

## 5. 移行計画（Migration Plan）

### 5.1 フェーズ別実装（Phase-by-Phase Implementation）

#### Phase 1: 準備 & 文書化（Week 1）

**目的**: 完全な設計文書と計画の作成

**タスク**:
1. ✅ 統合ホームページ構造設計書の作成（本ファイル）
2. ⏳ 重複機能分析レポートの作成
3. ⏳ 整理対象ファイルリストの作成
4. ⏳ 機能ブランチの作成: `feature/portal-admin-merge`

**成果物**:
- 設計文書（本ファイル）
- 重複機能分析レポート
- ファイル削除/統合チェックリスト
- Gitブランチ

#### Phase 2: API整理 & コンポーネント統合（Week 2）

**目的**: 重複コードの削除と統合

**タスク**:
1. `/api/customer/*` APIエンドポイントの削除（6個）
2. 共通コンポーネントディレクトリの作成
3. 重複コンポーネントの統合（5個）
4. コンポーネントテストの作成/更新

**成果物**:
- 削除されたAPIエンドポイント
- 統合されたコンポーネント
- 更新されたインポート文
- テストコード

#### Phase 3: ルート移行（Week 3）

**目的**: Portalページの`/admin/customers/*`への移行

**タスク**:
1. `/admin/customers/`ディレクトリ構造の作成
2. Portalページの移動とAPI呼び出しの変更
3. ミドルウェア権限ロジックの更新
4. Adminレイアウトの統合

**成果物**:
- 新しいルート構造
- 更新されたミドルウェア
- 統合されたAdminレイアウト
- 顧客ポータルレイアウトコンポーネント

#### Phase 4: リダイレクト & テスト（Week 4）

**目的**: SEO維持と動作確認

**タスク**:
1. ミドルウェア301リダイレクトの実装
2. テストディレクトリの再構成
3. 全テストファイルのURL更新
4. リダイレクトテストの追加
5. Phase 4 Adminテストの修正（68% → 90%+）
6. Phase 6 Customer Portalテストの実行

**成果物**:
- 301リダイレクト実装
- 更新されたE2Eテスト
- リダイレクト検証テスト
- テスト結果レポート

#### Phase 5: 文書化 & 検証（Week 5）

**目的**: 開発者ドキュメントの更新と品質保証

**タスク**:
1. CLAUDE.mdの更新
2. APIドキュメントの更新
3. 統合テストの実行
4. パフォーマンステストの実行

**成果物**:
- 更新されたCLAUDE.md
- 更新されたAPIドキュメント
- 統合テストレポート
- パフォーマンスレポート

#### Phase 6: 出荷 & モニタリング（Week 6）

**目的**: 本番環境へのデプロイと安定性確認

**タスク**:
1. 全体回帰テストの実行
2. セキュリティ監査の実行
3. ステージング環境へのデプロイ
4. 本番環境へのデプロイ
5. 2週間のモニタリング

**成果物**:
- 回帰テストレポート
- セキュリティ監査レポート
- デプロイメントドキュメント
- モニタリングレポート

### 5.2 リダイレクト戦略（Redirect Strategy）

#### 5.2.1 301リダイレクト実装

**実装方法**: ミドルウェアでのリダイレクト（推奨）

```typescript
// src/middleware.ts

// Portal → Admin/Customers への301リダイレクト
if (pathname.startsWith('/portal')) {
  const newPath = pathname.replace('/portal', '/admin/customers');
  const url = new URL(newPath, req.url);
  url.search = req.nextUrl.search; // クエリパラメータを保持
  return NextResponse.redirect(url, { status: 301 }); // 永続リダイレクト
}
```

#### 5.2.2 リダイレクトマッピング表

| 元URL | リダイレクト先 | HTTPステータス | SEO影響 |
|-------|--------------|--------------|---------|
| `/portal` | `/admin/customers` | 301 | なし（ランキング維持） |
| `/portal/orders` | `/admin/customers/orders` | 301 | なし |
| `/portal/orders/12345` | `/admin/customers/orders/12345` | 301 | なし |
| `/portal/documents` | `/admin/customers/documents` | 301 | なし |
| `/portal/profile` | `/admin/customers/profile` | 301 | なし |
| `/portal/support` | `/admin/customers/support` | 301 | なし |

#### 5.2.3 クエリパラメータ保持

リダイレクト時にクエリパラメータも保持されます：

```
/portal/orders?status=pending&page=2
↓
/admin/customers/orders?status=pending&page=2
```

### 5.3 テスト移行（Test Migration）

#### 5.3.1 テストディレクトリ再構成

**更新前**:
```
tests/e2e/
├── phase-5-portal/
│   ├── 01-portal-home.spec.ts
│   ├── 02-portal-orders.spec.ts
│   └── ...
```

**更新後**:
```
tests/e2e/
├── phase-6-customer-portal/
│   ├── 01-customer-portal-home.spec.ts
│   ├── 02-customer-portal-orders.spec.ts
│   ├── 03-customer-portal-redirects.spec.ts  ← 新規追加
│   └── ...
```

#### 5.3.2 テストファイル更新例

**更新前**: `tests/e2e/phase-5-portal/01-portal-home.spec.ts`

```typescript
test.describe('Portal Home', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/portal');
  });

  test('should display dashboard', async ({ page }) => {
    await expect(page.locator('h1')).toContainText('ダッシュボード');
  });
});
```

**更新後**: `tests/e2e/phase-6-customer-portal/01-customer-portal-home.spec.ts`

```typescript
test.describe('Customer Portal Home', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/admin/customers');
  });

  test('should display dashboard', async ({ page }) => {
    await expect(page.locator('h1')).toContainText('ダッシュボード');
  });
});
```

#### 5.3.3 リダイレクト検証テスト

**新規追加**: `tests/e2e/phase-6-customer-portal/00-redirects.spec.ts`

```typescript
import { test, expect } from '@playwright/test';

test.describe('Portal → Admin/Customers Redirects', () => {
  test('should redirect /portal to /admin/customers', async ({ page }) => {
    await page.goto('/portal');
    await expect(page).toHaveURL(/\/admin\/customers$/);
  });

  test('should redirect /portal/orders to /admin/customers/orders', async ({ page }) => {
    await page.goto('/portal/orders');
    await expect(page).toHaveURL(/\/admin\/customers\/orders$/);
  });

  test('should redirect /portal/orders/[id] to /admin/customers/orders/[id]', async ({ page }) => {
    await page.goto('/portal/orders/12345');
    await expect(page).toHaveURL(/\/admin\/customers\/orders\/12345$/);
  });

  test('should redirect /portal/documents to /admin/customers/documents', async ({ page }) => {
    await page.goto('/portal/documents');
    await expect(page).toHaveURL(/\/admin\/customers\/documents$/);
  });

  test('should redirect /portal/profile to /admin/customers/profile', async ({ page }) => {
    await page.goto('/portal/profile');
    await expect(page).toHaveURL(/\/admin\/customers\/profile$/);
  });

  test('should redirect /portal/support to /admin/customers/support', async ({ page }) => {
    await page.goto('/portal/support');
    await expect(page).toHaveURL(/\/admin\/customers\/support$/);
  });

  test('should preserve query parameters', async ({ page }) => {
    await page.goto('/portal/orders?status=pending&page=2');
    await expect(page).toHaveURL(/\/admin\/customers\/orders\?status=pending&page=2$/);
  });

  test('should return 301 status for SEO', async ({ page }) => {
    const response = await page.request.get('/portal');
    expect(response.status()).toBe(301);
  });

  test('should preserve hash fragments', async ({ page }) => {
    await page.goto('/portal#orders-section');
    await expect(page).toHaveURL(/\/admin\/customers#orders-section$/);
  });
});
```

### 5.4 データ移行（Data Migration）

**必要なし**: 本統合はルート変更とAPI統合のみのため、データベーススキーマ変更やデータ移行は不要です。

---

## 6. クリーンアップタスク（Cleanup Tasks）

### 6.1 削除ファイル一覧（Files to Delete）

#### 6.1.1 ディレクトリ削除

**削除タイミング**: Phase 4（リダイレクト実装後）

```
# Portalディレクトリ全体（移行完了後）
DELETE src/app/portal/

# Portalコンポーネントディレクトリ（移行完了後）
DELETE src/components/portal/

# 重複APIルートディレクトリ（移行完了後）
DELETE src/app/api/customer/
```

#### 6.1.2 個別ファイル削除

**Portalページファイル**:
```
DELETE src/app/portal/page.tsx
DELETE src/app/portal/orders/page.tsx
DELETE src/app/portal/orders/[id]/page.tsx
DELETE src/app/portal/documents/page.tsx
DELETE src/app/portal/profile/page.tsx
DELETE src/app/portal/support/page.tsx
```

**Portalコンポーネントファイル**:
```
DELETE src/components/portal/PortalLayout.tsx
DELETE src/components/portal/OrderSummaryCard.tsx
DELETE src/components/portal/DocumentDownloadCard.tsx
DELETE src/components/portal/ProductionProgressWidget.tsx
DELETE src/components/portal/ShipmentTrackingCard.tsx
```

**APIルートファイル**:
```
DELETE src/app/api/customer/dashboard/route.ts
DELETE src/app/api/customer/orders/route.ts
DELETE src/app/api/customer/orders/[id]/route.ts
DELETE src/app/api/customer/profile/route.ts
DELETE src/app/api/customer/documents/route.ts
```

#### 6.1.3 削除チェックリスト

Phase 4完了後に以下の順序で削除を実施：

1. ✅ リダイレクトが正しく動作することを確認
2. ✅ `/admin/customers/*`ページが全て機能することを確認
3. ✅ API呼び出しが全て`/api/member/*`に変更されていることを確認
4. ✅ E2Eテストが全て通過することを確認
5. ⏳ 上記確認後、`src/app/portal/`を削除
6. ⏳ `src/app/api/customer/`を削除
7. ⏳ `src/components/portal/`を削除（未使用コンポーネントのみ）

### 6.2 リファクタリング項目（Refactoring Items）

#### 6.2.1 API呼び出しの一括置換

**検索文字列**: `/api/customer`
**置換文字列**: `/api/member`

**実行コマンド例**:

```bash
# 全ファイルで一括置換（dry-run）
find src -type f -name "*.ts" -o -name "*.tsx" | xargs grep -l "/api/customer" | while read file; do
  sed 's|/api/customer|/api/member|g' "$file" > "${file}.tmp"
  mv "${file}.tmp" "$file"
done
```

#### 6.2.2 インポート文の更新

**更新前**:
```typescript
import { OrderSummaryCard } from '@/components/portal/OrderSummaryCard';
import { PortalLayout } from '@/components/portal/PortalLayout';
```

**更新後**:
```typescript
import { OrderSummaryCard } from '@/components/shared/order/OrderSummaryCard';
import { CustomerPortalLayout } from '@/components/admin/CustomerPortalLayout';
```

#### 6.2.3 型定義の整理

重複型定義の統合が必要な場合は、以下のファイルを確認：

```
src/types/
├── portal.ts  ← 削除（内容をtypes/index.tsに統合）
├── member.ts  ← 整理
├── admin.ts   ← 整理
└── index.ts   ← 統合先
```

### 6.3 コード重複削除（Code Duplication Removal）

#### 6.3.1 重複コード検出

以下のツールを使用して重複コードを検出：

```bash
# ESLint で重複コード検出
npm run lint -- --quiet

# カスタムスクリプトで重複関数検出
node scripts/find-duplicates.js
```

#### 6.3.2 コンポーネント統合優先順位

| 優先度 | コンポーネント | 統合先 | 理由 |
|-------|--------------|--------|------|
| 1 | `DocumentDownloadCard` | `components/shared/document/` | Portal/Member/Admin全てで使用 |
| 2 | `ProductionProgressWidget` | `components/shared/production/` | Portal/Adminで使用 |
| 3 | `ShipmentTrackingCard` | `components/shared/shipping/` | Portal/Adminで使用 |
| 4 | `OrderSummaryCard` | `components/shared/order/` | Portalで使用（将来拡張考慮） |
| 5 | `PortalLayout` | `components/admin/CustomerPortalLayout` | Portal専用 → Admin/customers専用に変更 |

---

## 7. リスク管理（Risk Management）

### 7.1 リスク評価（Risk Assessment）

| リスクID | リスクカテゴリ | 説明 | 影響度 | 発生確率 | リスクレベル |
|---------|--------------|------|--------|---------|-----------|
| R1 | SEO | リダイレクト設定ミスによる検索順位低下 | HIGH | LOW | MEDIUM |
| R2 | ユーザビリティ | 既存ユーザーがURL変更に混乱 | MEDIUM | HIGH | MEDIUM |
| R3 | 機能 | API統合による機能欠落 | HIGH | LOW | MEDIUM |
| R4 | パフォーマンス | 新規ルートによるパフォーマンス低下 | MEDIUM | LOW | LOW |
| R5 | セキュリティ | 権限設定ミスによる不正アクセス | CRITICAL | LOW | MEDIUM |
| R6 | テスト | E2Eテストの大幅な書き換えが必要 | MEDIUM | HIGH | MEDIUM |

### 7.2 代替計画（Alternative Plans）

#### R1: SEOリスクへの対応

**予防策**:
- 301リダイレクト（永続的）を使用
- Google Search ConsoleでURL変更を通知
- XMLサイトマップを更新

**緩和策**:
- リダイレクト実装後、2週間毎に検索順位をモニタリング
- 重要ページのランキング変動を追跡
- 必要に応じてmetaタグや構造化データを調整

**代替案**:
- 301ではなく302一時的リダイレクトを使用（リスク低減）
- `/portal`を残して`/admin/customers`をエイリアスとして機能

#### R2: ユーザビリティリスクへの対応

**予防策**:
- 移行前にユーザーへ告知メールを送信
- ヘルプページでURL変更を案内
- 古いURLから自動遷移する301リダイレクトを実装

**緩和策**:
- 移行後1ヶ月間、旧URLからのアクセスをログ記録
- ユーザーからの問い合わせを優先対応

**代替案**:
- `/portal`ルートを完全に削除せず、リダイレクト専用ページとして残す

#### R3: 機能欠落リスクへの対応

**予防策**:
- 包括的な回帰テストを実施
- 各ページの手動テストチェックリスト作成
- APIレスポンス形式の整合性確認

**緩和策**:
- カナリアリリースで一部ユーザーのみ新ルートへ誘導
- エラーログ監視体制の強化

**代替案**:
- `/api/customer/*`を即座に削除せず、非推奨マークを付けて残す
- 3ヶ月間の移行期間を設ける

#### R5: セキュリティリスクへの対応

**予防策**:
- ミドルウェア権限ロジックの包括的なレビュー
- 全ルートの権限テストケース作成
- セキュリティ監査の実施

**緩和策**:
- 権限エラー時の詳細ログ記録
- 管理者ダッシュボードに権限違反アラート表示

**代替案**:
- `/admin/customers/*`へのアクセスをADMINのみに制限（機能縮小）

### 7.3 ロールバック手順（Rollback Procedure）

#### 緊急ロールバック手順

**状況**: 移行後に重大な問題が発見された場合

**実行コマンド**:

```bash
# 1. 機能ブランチから移動
git checkout main

# 2. 移行前の状態に戻す（コミットハッシュを指定）
git revert <migration-commit-hash>

# 3. ビルドとデプロイ
npm run build
npm run deploy

# 4. データベースは変更していないためロールバック不要
```

**推定時間**: 15分

**データ損失リスク**: なし（データベース変更なし）

#### 段階的ロールバック

**シナリオ**: 一部機能のみ問題がある場合

1. **ミドルウェアのみロールバック**:
   ```bash
   git checkout main -- src/middleware.ts
   # 再デプロイ
   ```

2. **特定のページのみロールバック**:
   ```bash
   git checkout main -- src/app/admin/customers/orders
   # 再デプロイ
   ```

3. **リダイレクトのみ無効化**:
   ```typescript
   // src/middleware.ts でコメントアウト
   // if (pathname.startsWith('/portal')) {
   //   const newPath = pathname.replace('/portal', '/admin/customers');
   //   ...
   // }
   ```

---

## 8. 品質保証（Quality Assurance）

### 8.1 テスト戦略（Test Strategy）

#### 8.1.1 テストカバレッジ目標

| テスト種類 | 現在 | 目標 | 達成方法 |
|-----------|------|------|---------|
| **E2Eテスト** | Phase 4: 68% | 100% | 全ページのテスト追加 |
| **ユニットテスト** | 未実施 | 80% | 主要コンポーネントのテスト追加 |
| **統合テスト** | 未実施 | 90% | API統合テストの実施 |
| **パフォーマンステスト** | Lighthouse 90+ | 95+ | 最適化の実施 |

#### 8.1.2 E2Eテスト計画

**Phase 6: Customer Portal テスト**

| テストID | テスト名 | 検証内容 | 優先度 |
|---------|---------|---------|--------|
| TC-6.1 | 顧客ポータルホーム | ダッシュボード表示、統計表示 | P0 |
| TC-6.2 | 注文一覧ページ | ページネーション、フィルタリング | P0 |
| TC-6.3 | 注文詳細ページ | 進捗表示、ドキュメントダウンロード | P0 |
| TC-6.4 | プロフィールページ | プロフィール表示、編集機能 | P1 |
| TC-6.5 | ドキュメントページ | ファイル一覧、ダウンロード機能 | P1 |
| TC-6.6 | リダイレクト検証 | 全Portal→Customer Portalリダイレクト | P0 |
| TC-6.7 | 権限検証 | ADMIN/会員でのアクセス制御 | P0 |
| TC-6.8 | レスポンシブデザイン | モバイル表示対応 | P1 |

**テストスケジュール**:
- Week 4: テストケース作成とURL更新
- Week 4-5: テスト実施と修正
- Week 5: 最終検証と承認

#### 8.1.3 回帰テスト計画

**全機能回帰テスト**（Week 6）

| 機能領域 | テスト項目数 | 実施担当 |
|---------|-------------|---------|
| Public Pages | 37 | QAチーム |
| Member Pages | 26 | QAチーム |
| Admin Pages | 18 | QAチーム |
| Customer Portal | 6 | QAチーム |
| Authentication | 8 | QAチーム |
| **合計** | **95** | - |

**実施方法**:
- Playwright E2Eテスト自動実行
- 手動探索的テスト（主要フロー）
- クロスブラウザテスト（Chrome, Firefox, Safari）

### 8.2 パフォーマンス基準（Performance Benchmarks）

#### 8.2.1 Core Web Vitals目標

| 指標 | 現在 | 目標 | 許容範囲 |
|------|------|------|---------|
| **LCP** (Largest Contentful Paint) | 2.1s | < 2.5s | 2.5-4.0s |
| **FID** (First Input Delay) | 80ms | < 100ms | 100-300ms |
| **CLS** (Cumulative Layout Shift) | 0.05 | < 0.1 | 0.1-0.25 |
| **FCP** (First Contentful Paint) | 1.5s | < 1.8s | 1.8-3.0s |
| **TTI** (Time to Interactive) | 3.2s | < 3.8s | 3.8-7.3s |

#### 8.2.2 Lighthouse目標スコア

| カテゴリ | 現在 | 目標 |
|---------|------|------|
| **Performance** | 92 | 95+ |
| **Accessibility** | 94 | 95+ |
| **Best Practices** | 96 | 95+ |
| **SEO** | 98 | 100 |
| **PWA** | - | - |

#### 8.2.3 ページロード時間目標

| ページタイプ | 現在 | 目標 | 最大許容 |
|------------|------|------|---------|
| **Public Pages** | 1.8s | < 2s | 3s |
| **Member Dashboard** | 2.4s | < 2.5s | 4s |
| **Admin Dashboard** | 2.2s | < 2.5s | 4s |
| **Customer Portal** | - | < 2.5s | 4s |
| **Order Detail** | 2.8s | < 3s | 5s |

### 8.3 セキュリティ対策（Security Measures）

#### 8.3.1 認証・認可セキュリティ

**実施項目**:
1. ✅ ミドルウェアでの権限チェック
2. ✅ サーバーサイドでのセッション検証
3. ✅ CSRFトークンの実装
4. ⏳ Rate Limitingの強化
5. ⏳ セキュリティヘッダーの追加

**権限チェック実装例**:

```typescript
// src/lib/auth-helpers.ts

export async function requireAuth() {
  const supabase = createServerComponentClient();
  const {
    data: { session },
  } = await supabase.auth.getSession();

  if (!session) {
    redirect('/auth/signin');
  }

  return session.user;
}

export async function requireAdmin() {
  const user = await requireAuth();
  const supabase = createServerComponentClient();
  const { data: profile } = await supabase
    .from('profiles')
    .select('*')
    .eq('id', user.id)
    .single();

  if (!profile || profile.role !== 'ADMIN') {
    redirect('/auth/error?error=AccessDenied');
  }

  return profile;
}

export async function requireCustomerPortalAccess() {
  const user = await requireAuth();
  const supabase = createServerComponentClient();
  const { data: profile } = await supabase
    .from('profiles')
    .select('*')
    .eq('id', user.id)
    .single();

  if (!profile) {
    redirect('/auth/signin');
  }

  const hasAccess =
    profile.role === 'ADMIN' ||
    (profile.role === 'MEMBER' && profile.status === 'ACTIVE');

  if (!hasAccess) {
    redirect('/auth/error?error=AccessDenied');
  }

  return profile;
}
```

#### 8.3.2 セキュリティテスト

| テスト項目 | ツール | 頻度 |
|-----------|--------|------|
| 脆弱性スキャン | OWASP ZAP | 移行前後 |
| 依存関係チェック | npm audit | 毎週 |
| 権限昇格テスト | 手動テスト | 移行前後 |
| XSSテスト | Playwright | 移行後 |
| SQLインジェクションテスト | 手動テスト | 移行前後 |

---

## 9. 運用・保守（Operations & Maintenance）

### 9.1 ドキュメント更新（Documentation Updates）

#### 9.1.1 技術ドキュメント

**更新が必要なファイル**:

1. **CLAUDE.md**:
   - ルート構造の更新
   - APIエンドポイント一覧の更新
   - コンポーネント構成の更新

2. **APIドキュメント**:
   - `/api/customer/*`エンドポイントの削除
   - `/api/member/*`エンドポイントの詳細追加

3. **設計文書**:
   - `docs/reports/tjfrP/設計図.md`の更新
   - 本ファイルの作成

4. **README.md**:
   - プロジェクト構造の更新
   - 開発コマンドの更新

#### 9.1.2 ユーザードキュメント

**新規作成**:

1. **URL変更案内** (`/admin/customers/support`内):
   ```markdown
   # URL変更について

   お客様ポータルのURLが以下の通り変更となりました。

   - 旧: `/portal` → 新: `/admin/customers`

   古いURL（ブックマーク等）から自動的に新しいURLへ転送されます。
   ```

2. **ヘルプページ更新**:
   - スクリーンショットの更新
   - ナビゲーションパスの更新
   - APIエンドポイントの更新

### 9.2 モニタリング計画（Monitoring Plan）

#### 9.2.1 モニタリング項目

| 項目 | ツール | 警告閾値 | 対応時間 |
|------|--------|---------|---------|
| **ページレスポンス時間** | Vercel Analytics | > 3s | 即時 |
| **エラーレート** | Vercel Logs | > 1% | 1時間以内 |
| **リダイレクト成功率** | カスタムログ | < 99% | 即時 |
| **権限エラー** | Supabase Logs | > 10/時間 | 即時 |
| **SEOランキング** | Google Search Console | 順位低下 | 1営業日以内 |

#### 9.2.2 モニタリングダッシュボード

**実装予定**:
- Vercel Analyticsの統合
- Supabase Log Drainの設定
- カスタムエラートラッキングの実装

### 9.3 ユーザーサポート（User Support）

#### 9.3.1 サポート体制

**移行期間中（2週間）**:
- 専用サポートメールアドレスの設置
- ライブチャットの拡充
- FAQページの更新

**想定問い合わせ**:

| 質問 | 回答 |
|------|------|
| ブックマークが使えなくなった | 古いURLから自動転送されます。ブックマークの更新をお勧めします。 |
| ログインできない | `/auth/signin`から再度ログインしてください。 |
| データが消えた | データは全て保持されています。表示のURLが変更になっただけです。 |
| ページが見つからない | 古いURLから自動転送されます。問題が続く場合はサポートまでお問い合わせください。 |

#### 9.3.2 コミュニケーション計画

**移行前（1週間前）**:
- メール告知: 全ユーザーへ
- サイト内バナー: `/portal`ページに表示
- ヘルプページ更新

**移行後（2週間）**:
- フォローアップメール: ユーザーからのフィードバック収集
- サポート統計の収集
- 問題報告の分析

---

## 10. 成功指標（Success Metrics）

### 10.1 技術指標（Technical Metrics）

| 指標 | 現在 | 目標 | 測定方法 |
|------|------|------|---------|
| **重複API削除率** | 0% | 100% | コードベース分析 |
| **重複コンポーネント統合率** | 0% | 80%+ | コードベース分析 |
| **コード重複率** | 現在値 | -40% | SonarQube分析 |
| **E2Eテストカバレッジ** | 68% | 100% | Playwrightレポート |
| **Lighthouse Performance** | 92 | 95+ | Lighthouseレポート |
| **ページロード時間** | 2.4s | < 2.5s | Lighthouseレポート |
| **ビルド時間** | 現在値 | ±10%以内 | CI/CDログ |

### 10.2 ビジネス指標（Business Metrics）

| 指標 | 現在 | 目標 | 測定方法 |
|------|------|------|---------|
| **サポートチケット増加** | 0件/週 | 0件/週 | サポート統計 |
| **ユーザー導入率** | - | > 95% | アクティブユーザー数 |
| **データ損失** | 0件 | 0件 | イシュー追跡 |
| **SEOランキング変動** | - | ±3位以内 | Google Search Console |
| **直帰率** | 現在値 | ±5%以内 | Google Analytics |

### 10.3 コード品質指標（Code Quality Metrics）

| 指標 | 現在 | 目標 | 測定方法 |
|------|------|------|---------|
| **コンポーネント再利用率** | 現在値 | +60% | コードベース分析 |
| **保守時間** | 現在値 | -30% | 開発時間追跡 |
| **バグ報告数** | 現在値 | ±10%以内 | Bugトラッカー |
| **コードレビュー時間** | 現在値 | -20% | PR統計 |

---

## 付録（Appendix）

### 付録A: 完全API·DBマッピング表（Complete API/DB Mapping Table）

詳細なマッピング表は本文「2.2 ページ別API·DB完全マッピング」を参照。

### 付録B: 重複機能詳細分析（Detailed Duplication Analysis）

詳細な重複分析は本文「2.3 重複·不要機能分析」を参照。

### 付録C: 削除·統合ファイル一覧（Files to Delete/Consolidate）

詳細なファイル一覧は本文「6. クリーンアップタスク」を参照。

### 付録D: 用語集（Glossary）

| 用語 | 説明 |
|------|------|
| **Portal** | 顧客向けポータルページ（`/portal/*`） |
| **Member** | 会員専用ページ（`/member/*`） |
| **Admin** | 管理者ページ（`/admin/*`） |
| **Customer Portal** | 統合後の顧客ポータル（`/admin/customers/*`） |
| **301リダイレクト** | 永続的URL転送（SEOに有利） |
| **ミドルウェア** | Next.jsのリクエスト処理ミドルウェア |
| **E2Eテスト** | End-to-Endテスト（Playwright使用） |
| **RLS** | Row Level Security（Supabaseの行レベルセキュリティ） |
| **SSR** | Server-Side Rendering（サーバーサイドレンダリング） |
| **RSC** | React Server Components（Reactサーバーコンポーネント） |

---

**文書バージョン**: 1.0
**作成日**: 2026-01-15
**最終更新**: 2026-01-15
**作成者**: Claude Code
**ステータス**: 承認待ち
